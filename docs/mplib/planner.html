<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.3.0"/>
    <title>mplib.planner API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../mplib.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;mplib</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Planner">Planner</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Planner.__init__">Planner</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.urdf">urdf</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.robot">robot</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.pinocchio_model">pinocchio_model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.planning_world">planning_world</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.user_link_names">user_link_names</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.user_joint_names">user_joint_names</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.joint_name_2_idx">joint_name_2_idx</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.link_name_2_idx">link_name_2_idx</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.move_group">move_group</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.move_group_joint_indices">move_group_joint_indices</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.joint_types">joint_types</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.joint_limits">joint_limits</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.joint_vel_limits">joint_vel_limits</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.joint_acc_limits">joint_acc_limits</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.move_group_link_id">move_group_link_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Planner.planner">planner</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.replace_package_keyword">replace_package_keyword</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.generate_collision_pair">generate_collision_pair</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.distance_6D">distance_6D</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.check_joint_limit">check_joint_limit</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.pad_qpos">pad_qpos</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.check_for_collision">check_for_collision</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.check_for_self_collision">check_for_self_collision</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.check_for_env_collision">check_for_env_collision</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.IK">IK</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.TOPP">TOPP</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.update_point_cloud">update_point_cloud</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.update_attached_tool">update_attached_tool</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.update_attached_sphere">update_attached_sphere</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.update_attached_box">update_attached_box</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.update_attached_mesh">update_attached_mesh</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.set_base_pose">set_base_pose</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.set_normal_object">set_normal_object</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.remove_normal_object">remove_normal_object</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.plan_qpos_to_qpos">plan_qpos_to_qpos</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.plan_qpos_to_pose">plan_qpos_to_pose</a>
                        </li>
                        <li>
                                <a class="function" href="#Planner.plan_screw">plan_screw</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../mplib.html">mplib</a><wbr>.planner    </h1>

                
                        <input id="mod-planner-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-planner-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">toppra</span> <span class="k">as</span> <span class="nn">ta</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">toppra.algorithm</span> <span class="k">as</span> <span class="nn">algo</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">toppra.constraint</span> <span class="k">as</span> <span class="nn">constraint</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">transforms3d.quaternions</span> <span class="kn">import</span> <span class="n">mat2quat</span><span class="p">,</span> <span class="n">quat2mat</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">mplib.pymp</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="k">class</span> <span class="nc">Planner</span><span class="p">:</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Motion planner.&quot;&quot;&quot;</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>    <span class="c1"># TODO(jigu): default joint vel and acc limits</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>    <span class="c1"># TODO(jigu): how does user link names and joint names are exactly used?</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>        <span class="n">urdf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>        <span class="n">move_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>        <span class="n">srdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>        <span class="n">package_keyword_replacement</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>        <span class="n">user_link_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>        <span class="n">user_joint_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>        <span class="n">joint_vel_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>        <span class="n">joint_acc_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="p">):</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Motion planner for robots.</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">        Args:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">            urdf: Unified Robot Description Format file.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">            user_link_names: names of links, the order. if empty, all links will be used.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">            user_joint_names: names of the joints to plan.  if empty, all active joints will be used.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">            move_group: target link to move, usually the end-effector.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">            joint_vel_limits: maximum joint velocities for time parameterization,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">                which should have the same length as</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">            joint_acc_limits: maximum joint accelerations for time parameterization,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">                which should have the same length as</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">            srdf: Semantic Robot Description Format file.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        References:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">            http://docs.ros.org/en/kinetic/api/moveit_tutorials/html/doc/urdf_srdf/urdf_srdf_tutorial.html</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span> <span class="o">=</span> <span class="n">urdf</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="k">if</span> <span class="n">srdf</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)):</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span> <span class="o">=</span> <span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No SRDF file provided but found </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="c1"># replace package:// keyword if exists</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="n">urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_package_keyword</span><span class="p">(</span><span class="n">package_keyword_replacement</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span><span class="p">(</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>            <span class="n">urdf</span><span class="p">,</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>            <span class="n">srdf</span><span class="p">,</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">],</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>            <span class="n">user_joint_names</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>            <span class="n">user_link_names</span><span class="p">,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>            <span class="n">convex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_pinocchio_model</span><span class="p">()</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span> <span class="o">=</span> <span class="n">planning_world</span><span class="o">.</span><span class="n">PlanningWorld</span><span class="p">(</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">],</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="p">[</span><span class="s2">&quot;robot&quot;</span><span class="p">],</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normal_objects&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normal_object_names&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="k">if</span> <span class="n">srdf</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">generate_collision_pair</span><span class="p">()</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">update_SRDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">)</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_pinocchio_model</span><span class="p">()</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_names</span><span class="p">()</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_joint_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_names</span><span class="p">()</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_name_2_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">joint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_joint_names</span><span class="p">):</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">joint_name_2_idx</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">):</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="n">move_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;end-effector not found as one of the links in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group</span> <span class="o">=</span> <span class="n">move_group</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_move_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_move_group_joint_indices</span><span class="p">()</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_types</span><span class="p">()</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_limits</span><span class="p">())</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="n">joint_vel_limits</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">))</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="n">joint_acc_limits</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">))</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_acc_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">),</span> <span class="p">(</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="sa">f</span><span class="s2">&quot;length of move_group (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) &gt; &quot;</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="sa">f</span><span class="s2">&quot;number of total joints (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span> <span class="o">=</span> <span class="n">planning_world</span><span class="o">.</span><span class="n">PlanningWorld</span><span class="p">(</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;robot&quot;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planner</span> <span class="o">=</span> <span class="n">ompl</span><span class="o">.</span><span class="n">OMPLPlanner</span><span class="p">(</span><span class="n">world</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="k">def</span> <span class="nf">replace_package_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_keyword_replacement</span><span class="p">):</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        some ROS URDF files use package:// keyword to refer the package dir</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">        replace it with the given string (default is empty)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">        Args:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">            package_keyword_replacement: the string to replace &#39;package://&#39; keyword</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="n">rtn_urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_f</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">in_f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>            <span class="k">if</span> <span class="s2">&quot;package://&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>                <span class="n">rtn_urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;_package_keyword_replaced.urdf&quot;</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;package://&quot;</span><span class="p">,</span> <span class="n">package_keyword_replacement</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rtn_urdf</span><span class="p">):</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rtn_urdf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_f</span><span class="p">:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>                        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="k">return</span> <span class="n">rtn_urdf</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="k">def</span> <span class="nf">generate_collision_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">echo_freq</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        we read the srdf file to get the link pairs that should not collide.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">        if not provided, we need to randomly sample configurations to find the link pairs that will always collide.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="s2">&quot;Since no SRDF file is provided. We will first detect link pairs that will&quot;</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="s2">&quot; always collide. This may take several minutes.&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="n">n_link</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="n">cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_link</span><span class="p">,</span> <span class="n">n_link</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_time</span><span class="p">):</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_random_configuration</span><span class="p">()</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="n">collisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">()</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="k">for</span> <span class="n">collision</span> <span class="ow">in</span> <span class="n">collisions</span><span class="p">:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name1</span><span class="p">]</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name2</span><span class="p">]</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                <span class="n">cnt</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">echo_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finish </span><span class="si">%.1f%%</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">sample_time</span><span class="p">))</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;robot&quot;</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="n">robot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">robot_name</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_link</span><span class="p">):</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_link</span><span class="p">):</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>                <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">sample_time</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>                    <span class="n">link1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                    <span class="n">link2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                        <span class="s2">&quot;Ignore collision pair: (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">), reason:  always collide&quot;</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                        <span class="o">%</span> <span class="p">(</span><span class="n">link1</span><span class="p">,</span> <span class="n">link2</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>                    <span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>                    <span class="n">collision</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;disable_collisions&quot;</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;link1&quot;</span><span class="p">,</span> <span class="n">link1</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;link2&quot;</span><span class="p">,</span> <span class="n">link2</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="s2">&quot;Default&quot;</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="n">srdffile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="n">srdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">))</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">srdffile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving the SRDF file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>    <span class="k">def</span> <span class="nf">distance_6D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">q2</span><span class="p">):</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        compute the distance between two poses</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        Args:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">            p1: position of pose 1</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">            q1: quaternion of pose 1</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">            p2: position of pose 2</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">            q2: quaternion of pose 2</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q1</span> <span class="o">-</span> <span class="n">q2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q1</span> <span class="o">+</span> <span class="n">q2</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="p">)</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>    <span class="k">def</span> <span class="nf">check_joint_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        check if the joint configuration is within the joint limits</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        Args:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">            q: joint configuration</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">        Returns:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">            True if the joint configuration is within the joint limits</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JointModelR&quot;</span><span class="p">):</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                    <span class="k">continue</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                    <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                <span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                    <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                    <span class="ow">or</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="p">):</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">flag</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="k">def</span> <span class="nf">pad_qpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpos</span><span class="p">,</span> <span class="n">articulation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        if the user does not provide the full qpos but only the move_group joints,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">        pad the qpos with the rest of the joints</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">):</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                <span class="k">if</span> <span class="n">articulation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="n">tmp</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">qpos</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="sa">f</span><span class="s2">&quot;length of qpos (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="sa">f</span><span class="s2">&quot;number of total joints (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">return</span> <span class="n">qpos</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="k">def</span> <span class="nf">check_for_collision</span><span class="p">(</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="n">collision_function</span><span class="p">,</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to check for collision&quot;&quot;&quot;</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="c1"># handle no user input</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="n">articulation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="n">articulation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">qpos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="n">articulation</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="c1"># first save the current qpos</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="n">old_qpos</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="c1"># set robot to new qpos</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">articulation</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="c1"># find the index of the articulation inside the array</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">get_articulations</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">articulation</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="c1"># check for self-collision</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="n">collisions</span> <span class="o">=</span> <span class="n">collision_function</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="c1"># reset qpos</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="n">articulation</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">old_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="k">return</span> <span class="n">collisions</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>    <span class="k">def</span> <span class="nf">check_for_self_collision</span><span class="p">(</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the robot is in self-collision.</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        Args:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">            articulation: robot model. if none will be self.robot</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">            qpos: robot configuration. if none will be the current pose</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">        Returns:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="sd">            A list of collisions.</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_collision</span><span class="p">(</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">self_collide</span><span class="p">,</span> <span class="n">articulation</span><span class="p">,</span> <span class="n">qpos</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>    <span class="k">def</span> <span class="nf">check_for_env_collision</span><span class="p">(</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="n">with_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the robot is in collision with the environment</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">        Args:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">            articulation: robot model. if none will be self.robot</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">            qpos: robot configuration. if none will be the current pose</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">            with_point_cloud: whether to check collision against point cloud</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">            use_attach: whether to include the object attached to the end effector in collision checking</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">        Returns:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">            A list of collisions.</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="c1"># store previous results</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="n">prev_use_point_cloud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">use_point_cloud</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="n">prev_use_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">use_attach</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">with_point_cloud</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_collision</span><span class="p">(</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_with_others</span><span class="p">,</span> <span class="n">articulation</span><span class="p">,</span> <span class="n">qpos</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="c1"># restore</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">prev_use_point_cloud</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">prev_use_attach</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>    <span class="k">def</span> <span class="nf">IK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">start_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">[],</span> <span class="n">n_init_qpos</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        Inverse kinematics</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        Args:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">            goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="sd">            start_qpos: initial configuration</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">            mask: if the value at a given index is True, the joint is *not* used in the IK</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">            n_init_qpos: number of random initial configurations</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">            threshold: threshold for the distance between the goal pose and the result pose</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="n">min_dis</span> <span class="o">=</span> <span class="mf">1e9</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="n">qpos0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">start_qpos</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">start_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_init_qpos</span><span class="p">):</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="n">ik_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_IK_CLIK</span><span class="p">(</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="n">index</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">start_qpos</span><span class="p">,</span> <span class="n">mask</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            <span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_joint_limit</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># will clip qpos</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="c1"># check collision</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_qpos_all</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_forward_kinematics</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                <span class="n">new_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_pose</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                <span class="n">tmp_dis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_6D</span><span class="p">(</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                    <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">new_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">new_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                <span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="k">if</span> <span class="n">tmp_dis</span> <span class="o">&lt;</span> <span class="n">min_dis</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                    <span class="n">min_dis</span> <span class="o">=</span> <span class="n">tmp_dis</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                <span class="k">if</span> <span class="n">tmp_dis</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                    <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                            <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                    <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">start_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_random_configuration</span><span class="p">()</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="k">if</span> <span class="n">mask_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_len</span><span class="p">):</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                    <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                        <span class="n">start_qpos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpos0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="k">elif</span> <span class="n">min_dis</span> <span class="o">!=</span> <span class="mf">1e9</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;IK Failed! Distance </span><span class="si">%lf</span><span class="s2"> is greater than threshold </span><span class="si">%lf</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="n">min_dis</span><span class="p">,</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">threshold</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;IK Failed! Cannot find valid solution.&quot;</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">results</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    <span class="k">def</span> <span class="nf">TOPP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        Time-Optimal Path Parameterization</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        Args:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">            path: numpy array of shape (n, dof)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">            step: step size for the discretization</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">            verbose: if True, will print the log of TOPPRA</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="n">N_samples</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="n">dof</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="k">assert</span> <span class="n">dof</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">assert</span> <span class="n">dof</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_samples</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">SplineInterpolator</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="n">pc_vel</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">JointVelocityConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="n">pc_acc</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">JointAccelerationConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="n">instance</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">TOPPRA</span><span class="p">(</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="p">[</span><span class="n">pc_vel</span><span class="p">,</span> <span class="n">pc_acc</span><span class="p">],</span> <span class="n">path</span><span class="p">,</span> <span class="n">parametrizer</span><span class="o">=</span><span class="s2">&quot;ParametrizeConstAccel&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="n">jnt_traj</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">compute_trajectory</span><span class="p">()</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="n">ts_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="n">step</span><span class="p">))</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="n">qs_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="n">qds_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="n">qdds_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="k">return</span> <span class="n">ts_sample</span><span class="p">,</span> <span class="n">qs_sample</span><span class="p">,</span> <span class="n">qds_sample</span><span class="p">,</span> <span class="n">qdds_sample</span><span class="p">,</span> <span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>    <span class="k">def</span> <span class="nf">update_point_cloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        Args:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">            pc: numpy array of shape (n, 3)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">            radius: radius of each point. This gives a buffer around each point that planner will avoid</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_point_cloud</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>    <span class="k">def</span> <span class="nf">update_attached_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcl_collision_geometry</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to update the attached tool&quot;&quot;&quot;</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_tool</span><span class="p">(</span><span class="n">fcl_collision_geometry</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="k">def</span> <span class="nf">update_attached_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">        attach a sphere to some link</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="sd">        Args:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="sd">            radius: radius of the sphere</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the sphere</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>    <span class="k">def</span> <span class="nf">update_attached_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">        attach a box to some link</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        Args:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">            size: [x,y,z] size of the box</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the box</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_box</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>    <span class="k">def</span> <span class="nf">update_attached_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_path</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">        attach a mesh to some link</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">        Args:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">            mesh_path: path to the mesh</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the mesh</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_mesh</span><span class="p">(</span><span class="n">mesh_path</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="k">def</span> <span class="nf">set_base_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose</span><span class="p">):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        tell the planner where the base of the robot is w.r.t the world frame</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        Args:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the base</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_base_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>    <span class="k">def</span> <span class="nf">set_normal_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">collision_object</span><span class="p">):</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;adds or updates a non-articulated collision object in the scene&quot;&quot;&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_normal_object</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">collision_object</span><span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>    <span class="k">def</span> <span class="nf">remove_normal_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;returns true if the object was removed, false if it was not found&quot;&quot;&quot;</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">remove_normal_object</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="k">def</span> <span class="nf">plan_qpos_to_qpos</span><span class="p">(</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="n">goal_qposes</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="n">planner_name</span><span class="o">=</span><span class="s2">&quot;RRTConnect&quot;</span><span class="p">,</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="n">fixed_joint_indices</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>    <span class="p">):</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">        plan a path from a specified joint position to a goal pose</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">        Args:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">            goal_pose: 7D pose of the end-effector [x,y,z,qw,qx,qy,qz]</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">            current_qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">            mask: mask for IK. When set, the IK will leave certain joints out of planning</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">            time_step: time step for TOPP</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">            rrt_range: step size for RRT</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">            planning_time: time limit for RRT</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">            fix_joint_limits: if True, will clip the joint configuration to be within the joint limits</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">            use_attach: if True, will consider the attached tool collision when planning</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="sd">            verbose: if True, will print the log of OMPL and TOPPRA</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">            planner_name: planner name pick from {&quot;RRTConnect&quot;, &quot;RRT*&quot;}</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">            fixed_joint_indices: list of indices of joints that are fixed during planning</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="sd">            constraint_function: evals to 0 when constraint is satisfied</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a><span class="sd">            constraint_jacobian: jacobian of constraint_function</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="sd">            constraint_tolerance: tolerance for constraint_function</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">            no_simplification: if true, will not simplify the path. constraint planning does not support simplification</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">use_point_cloud</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">current_qpos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="n">fix_joint_limits</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="n">current_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>        <span class="n">collisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">()</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid start state!&quot;</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="k">for</span> <span class="n">collision</span> <span class="ow">in</span> <span class="n">collisions</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> collide!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name1</span><span class="p">,</span> <span class="n">collision</span><span class="o">.</span><span class="n">link_name2</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                <span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="n">goal_qpos_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qposes</span><span class="p">)):</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>            <span class="n">goal_qpos_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_qposes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="n">fixed_joints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="k">for</span> <span class="n">joint_idx</span> <span class="ow">in</span> <span class="n">fixed_joint_indices</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>            <span class="n">fixed_joints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ompl</span><span class="o">.</span><span class="n">FixedJoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">joint_idx</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">joint_idx</span><span class="p">]))</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="n">status</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="n">current_qpos</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>            <span class="n">goal_qpos_</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>            <span class="nb">range</span><span class="o">=</span><span class="n">rrt_range</span><span class="p">,</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="n">time</span><span class="o">=</span><span class="n">planning_time</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="n">fixed_joints</span><span class="o">=</span><span class="n">fixed_joints</span><span class="p">,</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>            <span class="n">planner_name</span><span class="o">=</span><span class="n">planner_name</span><span class="p">,</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>            <span class="n">no_simplification</span><span class="o">=</span><span class="n">no_simplification</span><span class="p">,</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>            <span class="n">constraint_function</span><span class="o">=</span><span class="n">constraint_function</span><span class="p">,</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="n">constraint_jacobian</span><span class="o">=</span><span class="n">constraint_jacobian</span><span class="p">,</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="n">constraint_tolerance</span><span class="o">=</span><span class="n">constraint_tolerance</span><span class="p">,</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Exact solution&quot;</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="n">times</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOPP</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">time_step</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="p">}</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;RRT Failed. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">}</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>    <span class="k">def</span> <span class="nf">plan_qpos_to_pose</span><span class="p">(</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>        <span class="n">goal_pose</span><span class="p">,</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>        <span class="n">mask</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        <span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="n">wrt_world</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="n">planner_name</span><span class="o">=</span><span class="s2">&quot;RRTConnect&quot;</span><span class="p">,</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>        <span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>    <span class="p">):</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a><span class="sd">        plan from a start configuration to a goal pose of the end-effector</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a><span class="sd">        Args:</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a><span class="sd">            goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a><span class="sd">            current_qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a><span class="sd">            mask: if the value at a given index is True, the joint is *not* used in the IK</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a><span class="sd">            time_step: time step for TOPPRA (time parameterization of path)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a><span class="sd">            rrt_range: step size for RRT</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a><span class="sd">            planning_time: time limit for RRT</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a><span class="sd">            fix_joint_limits: if True, will clip the joint configuration to be within the joint limits</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a><span class="sd">            use_attach: if True, will consider the attached tool collision when planning</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a><span class="sd">            verbose: if True, will print the log of OMPL and TOPPRA</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a><span class="sd">            wrt_world: if true, interpret the target pose with respect to the world frame instead of the base frame</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">current_qpos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">if</span> <span class="n">fix_joint_limits</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="k">if</span> <span class="n">wrt_world</span><span class="p">:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>            <span class="n">base_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_base_pose</span><span class="p">()</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>            <span class="n">base_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>            <span class="n">base_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>            <span class="n">base_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">base_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>            <span class="n">goal_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>            <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>            <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>            <span class="n">goal_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">base_tf</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">goal_tf</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>            <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">mat2quat</span><span class="p">(</span><span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="p">)</span>  <span class="c1"># we need to take only the move_group joints when planning</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="n">ik_status</span><span class="p">,</span> <span class="n">goal_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IK</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="k">if</span> <span class="n">ik_status</span> <span class="o">!=</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">ik_status</span><span class="p">}</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IK results:&quot;</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>        <span class="n">goal_qpos_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>            <span class="n">goal_qpos_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="n">ik_status</span><span class="p">,</span> <span class="n">goal_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IK</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="k">if</span> <span class="n">ik_status</span> <span class="o">!=</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">ik_status</span><span class="p">}</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IK results:&quot;</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_qpos_to_qpos</span><span class="p">(</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="n">goal_qpos</span><span class="p">,</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>            <span class="n">time_step</span><span class="p">,</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="n">rrt_range</span><span class="p">,</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>            <span class="n">planning_time</span><span class="p">,</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="n">fix_joint_limits</span><span class="p">,</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">use_point_cloud</span><span class="p">,</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="n">use_attach</span><span class="p">,</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="n">verbose</span><span class="p">,</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="n">planner_name</span><span class="p">,</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>            <span class="n">no_simplification</span><span class="p">,</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>            <span class="n">constraint_function</span><span class="p">,</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>            <span class="n">constraint_jacobian</span><span class="p">,</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>            <span class="n">constraint_tolerance</span><span class="p">,</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>    <span class="k">def</span> <span class="nf">plan_screw</span><span class="p">(</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>        <span class="n">target_pose</span><span class="p">,</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="n">qpos</span><span class="p">,</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="n">qpos_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>    <span class="p">):</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a><span class="sd">        plan from a start configuration to a goal pose of the end-effector using screw motion</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a><span class="sd">        Args:</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a><span class="sd">            target_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a><span class="sd">            qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a><span class="sd">            qpos_step: size of the random step for RRT</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a><span class="sd">            time_step: time step for the discretization</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">            use_attach: if True, will use the attached tool to avoid collision</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a><span class="sd">            verbose: if True, will print the log of TOPPRA</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">use_point_cloud</span><span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>        <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>        <span class="k">def</span> <span class="nf">pose7D2mat</span><span class="p">(</span><span class="n">pose</span><span class="p">):</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>            <span class="k">return</span> <span class="n">mat</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>        <span class="k">def</span> <span class="nf">skew</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>                <span class="p">[</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>                <span class="p">[</span><span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>            <span class="p">])</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>        <span class="k">def</span> <span class="nf">pose2exp_coordinate</span><span class="p">(</span><span class="n">pose</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>            <span class="k">def</span> <span class="nf">rot2so3</span><span class="p">(</span><span class="n">rotation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>                <span class="k">assert</span> <span class="n">rotation</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mf">1e6</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>                <span class="n">omega</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                    <span class="mi">1</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                    <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>                    <span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>                <span class="p">)</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>                <span class="k">return</span> <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>            <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">rot2so3</span><span class="p">(</span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>            <span class="k">if</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e5</span><span class="p">:</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>                <span class="k">return</span> <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>            <span class="n">ss</span> <span class="o">=</span> <span class="n">skew</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>            <span class="n">inv_left_jacobian</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">theta</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>                <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ss</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>                <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">theta</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">ss</span> <span class="o">@</span> <span class="n">ss</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>            <span class="p">)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">inv_left_jacobian</span> <span class="o">@</span> <span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">v</span><span class="p">,</span> <span class="n">omega</span><span class="p">]),</span> <span class="n">theta</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_forward_kinematics</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="n">ee_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>        <span class="n">current_p</span> <span class="o">=</span> <span class="n">pose7D2mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_pose</span><span class="p">(</span><span class="n">ee_index</span><span class="p">))</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>        <span class="n">target_p</span> <span class="o">=</span> <span class="n">pose7D2mat</span><span class="p">(</span><span class="n">target_pose</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>        <span class="n">relative_transform</span> <span class="o">=</span> <span class="n">target_p</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">current_p</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>        <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">pose2exp_coordinate</span><span class="p">(</span><span class="n">relative_transform</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>        <span class="k">if</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e4</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;screw plan failed.&quot;</span><span class="p">}</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">theta</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">])]</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_full_jacobian</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>            <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_jacobian</span><span class="p">(</span><span class="n">ee_index</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>            <span class="n">delta_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">@</span> <span class="n">omega</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>            <span class="n">delta_q</span> <span class="o">*=</span> <span class="n">qpos_step</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_q</span><span class="p">))</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>            <span class="n">delta_twist</span> <span class="o">=</span> <span class="n">J</span> <span class="o">@</span> <span class="n">delta_q</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">omega</span><span class="p">):</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>                <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>                <span class="n">delta_q</span> <span class="o">=</span> <span class="n">delta_q</span> <span class="o">*</span> <span class="n">ratio</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>                <span class="n">delta_twist</span> <span class="o">=</span> <span class="n">delta_twist</span> <span class="o">*</span> <span class="n">ratio</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>            <span class="n">qpos</span> <span class="o">+=</span> <span class="n">delta_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>            <span class="n">omega</span> <span class="o">-=</span> <span class="n">delta_twist</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>            <span class="k">def</span> <span class="nf">check_joint_limit</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>                        <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>                        <span class="ow">or</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>                    <span class="p">):</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>            <span class="n">within_joint_limit</span> <span class="o">=</span> <span class="n">check_joint_limit</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_qpos_all</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>            <span class="n">collide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide</span><span class="p">()</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>                <span class="ow">or</span> <span class="n">collide</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>                <span class="ow">or</span> <span class="n">within_joint_limit</span> <span class="o">==</span> <span class="kc">False</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>            <span class="p">):</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;screw plan failed&quot;</span><span class="p">}</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>                    <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>                    <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>                <span class="n">times</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOPP</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">time_step</span><span class="p">)</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>                    <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>                    <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>                    <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>                <span class="p">}</span>
</span></pre></div>


            </section>
                <section id="Planner">
                            <input id="Planner-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Planner</span>:

                <label class="view-source-button" for="Planner-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner-14"><a href="#Planner-14"><span class="linenos"> 14</span></a><span class="k">class</span> <span class="nc">Planner</span><span class="p">:</span>
</span><span id="Planner-15"><a href="#Planner-15"><span class="linenos"> 15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Motion planner.&quot;&quot;&quot;</span>
</span><span id="Planner-16"><a href="#Planner-16"><span class="linenos"> 16</span></a>
</span><span id="Planner-17"><a href="#Planner-17"><span class="linenos"> 17</span></a>    <span class="c1"># TODO(jigu): default joint vel and acc limits</span>
</span><span id="Planner-18"><a href="#Planner-18"><span class="linenos"> 18</span></a>    <span class="c1"># TODO(jigu): how does user link names and joint names are exactly used?</span>
</span><span id="Planner-19"><a href="#Planner-19"><span class="linenos"> 19</span></a>
</span><span id="Planner-20"><a href="#Planner-20"><span class="linenos"> 20</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Planner-21"><a href="#Planner-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner-22"><a href="#Planner-22"><span class="linenos"> 22</span></a>        <span class="n">urdf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Planner-23"><a href="#Planner-23"><span class="linenos"> 23</span></a>        <span class="n">move_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Planner-24"><a href="#Planner-24"><span class="linenos"> 24</span></a>        <span class="n">srdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Planner-25"><a href="#Planner-25"><span class="linenos"> 25</span></a>        <span class="n">package_keyword_replacement</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Planner-26"><a href="#Planner-26"><span class="linenos"> 26</span></a>        <span class="n">user_link_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner-27"><a href="#Planner-27"><span class="linenos"> 27</span></a>        <span class="n">user_joint_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner-28"><a href="#Planner-28"><span class="linenos"> 28</span></a>        <span class="n">joint_vel_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner-29"><a href="#Planner-29"><span class="linenos"> 29</span></a>        <span class="n">joint_acc_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner-30"><a href="#Planner-30"><span class="linenos"> 30</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Planner-31"><a href="#Planner-31"><span class="linenos"> 31</span></a>    <span class="p">):</span>
</span><span id="Planner-32"><a href="#Planner-32"><span class="linenos"> 32</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Motion planner for robots.</span>
</span><span id="Planner-33"><a href="#Planner-33"><span class="linenos"> 33</span></a>
</span><span id="Planner-34"><a href="#Planner-34"><span class="linenos"> 34</span></a><span class="sd">        Args:</span>
</span><span id="Planner-35"><a href="#Planner-35"><span class="linenos"> 35</span></a><span class="sd">            urdf: Unified Robot Description Format file.</span>
</span><span id="Planner-36"><a href="#Planner-36"><span class="linenos"> 36</span></a><span class="sd">            user_link_names: names of links, the order. if empty, all links will be used.</span>
</span><span id="Planner-37"><a href="#Planner-37"><span class="linenos"> 37</span></a><span class="sd">            user_joint_names: names of the joints to plan.  if empty, all active joints will be used.</span>
</span><span id="Planner-38"><a href="#Planner-38"><span class="linenos"> 38</span></a><span class="sd">            move_group: target link to move, usually the end-effector.</span>
</span><span id="Planner-39"><a href="#Planner-39"><span class="linenos"> 39</span></a><span class="sd">            joint_vel_limits: maximum joint velocities for time parameterization,</span>
</span><span id="Planner-40"><a href="#Planner-40"><span class="linenos"> 40</span></a><span class="sd">                which should have the same length as</span>
</span><span id="Planner-41"><a href="#Planner-41"><span class="linenos"> 41</span></a><span class="sd">            joint_acc_limits: maximum joint accelerations for time parameterization,</span>
</span><span id="Planner-42"><a href="#Planner-42"><span class="linenos"> 42</span></a><span class="sd">                which should have the same length as</span>
</span><span id="Planner-43"><a href="#Planner-43"><span class="linenos"> 43</span></a><span class="sd">            srdf: Semantic Robot Description Format file.</span>
</span><span id="Planner-44"><a href="#Planner-44"><span class="linenos"> 44</span></a><span class="sd">        References:</span>
</span><span id="Planner-45"><a href="#Planner-45"><span class="linenos"> 45</span></a><span class="sd">            http://docs.ros.org/en/kinetic/api/moveit_tutorials/html/doc/urdf_srdf/urdf_srdf_tutorial.html</span>
</span><span id="Planner-46"><a href="#Planner-46"><span class="linenos"> 46</span></a>
</span><span id="Planner-47"><a href="#Planner-47"><span class="linenos"> 47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-48"><a href="#Planner-48"><span class="linenos"> 48</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span> <span class="o">=</span> <span class="n">urdf</span>
</span><span id="Planner-49"><a href="#Planner-49"><span class="linenos"> 49</span></a>        <span class="k">if</span> <span class="n">srdf</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)):</span>
</span><span id="Planner-50"><a href="#Planner-50"><span class="linenos"> 50</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span> <span class="o">=</span> <span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)</span>
</span><span id="Planner-51"><a href="#Planner-51"><span class="linenos"> 51</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No SRDF file provided but found </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Planner-52"><a href="#Planner-52"><span class="linenos"> 52</span></a>
</span><span id="Planner-53"><a href="#Planner-53"><span class="linenos"> 53</span></a>        <span class="c1"># replace package:// keyword if exists</span>
</span><span id="Planner-54"><a href="#Planner-54"><span class="linenos"> 54</span></a>        <span class="n">urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_package_keyword</span><span class="p">(</span><span class="n">package_keyword_replacement</span><span class="p">)</span>
</span><span id="Planner-55"><a href="#Planner-55"><span class="linenos"> 55</span></a>
</span><span id="Planner-56"><a href="#Planner-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span><span class="p">(</span>
</span><span id="Planner-57"><a href="#Planner-57"><span class="linenos"> 57</span></a>            <span class="n">urdf</span><span class="p">,</span>
</span><span id="Planner-58"><a href="#Planner-58"><span class="linenos"> 58</span></a>            <span class="n">srdf</span><span class="p">,</span>
</span><span id="Planner-59"><a href="#Planner-59"><span class="linenos"> 59</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">],</span>
</span><span id="Planner-60"><a href="#Planner-60"><span class="linenos"> 60</span></a>            <span class="n">user_joint_names</span><span class="p">,</span>
</span><span id="Planner-61"><a href="#Planner-61"><span class="linenos"> 61</span></a>            <span class="n">user_link_names</span><span class="p">,</span>
</span><span id="Planner-62"><a href="#Planner-62"><span class="linenos"> 62</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-63"><a href="#Planner-63"><span class="linenos"> 63</span></a>            <span class="n">convex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Planner-64"><a href="#Planner-64"><span class="linenos"> 64</span></a>        <span class="p">)</span>
</span><span id="Planner-65"><a href="#Planner-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_pinocchio_model</span><span class="p">()</span>
</span><span id="Planner-66"><a href="#Planner-66"><span class="linenos"> 66</span></a>
</span><span id="Planner-67"><a href="#Planner-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span> <span class="o">=</span> <span class="n">planning_world</span><span class="o">.</span><span class="n">PlanningWorld</span><span class="p">(</span>
</span><span id="Planner-68"><a href="#Planner-68"><span class="linenos"> 68</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">],</span>
</span><span id="Planner-69"><a href="#Planner-69"><span class="linenos"> 69</span></a>            <span class="p">[</span><span class="s2">&quot;robot&quot;</span><span class="p">],</span>
</span><span id="Planner-70"><a href="#Planner-70"><span class="linenos"> 70</span></a>            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normal_objects&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Planner-71"><a href="#Planner-71"><span class="linenos"> 71</span></a>            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normal_object_names&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Planner-72"><a href="#Planner-72"><span class="linenos"> 72</span></a>        <span class="p">)</span>
</span><span id="Planner-73"><a href="#Planner-73"><span class="linenos"> 73</span></a>
</span><span id="Planner-74"><a href="#Planner-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="n">srdf</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="Planner-75"><a href="#Planner-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">generate_collision_pair</span><span class="p">()</span>
</span><span id="Planner-76"><a href="#Planner-76"><span class="linenos"> 76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">update_SRDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">)</span>
</span><span id="Planner-77"><a href="#Planner-77"><span class="linenos"> 77</span></a>
</span><span id="Planner-78"><a href="#Planner-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_pinocchio_model</span><span class="p">()</span>
</span><span id="Planner-79"><a href="#Planner-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_names</span><span class="p">()</span>
</span><span id="Planner-80"><a href="#Planner-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_joint_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_names</span><span class="p">()</span>
</span><span id="Planner-81"><a href="#Planner-81"><span class="linenos"> 81</span></a>
</span><span id="Planner-82"><a href="#Planner-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_name_2_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Planner-83"><a href="#Planner-83"><span class="linenos"> 83</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">joint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_joint_names</span><span class="p">):</span>
</span><span id="Planner-84"><a href="#Planner-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">joint_name_2_idx</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="Planner-85"><a href="#Planner-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Planner-86"><a href="#Planner-86"><span class="linenos"> 86</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">):</span>
</span><span id="Planner-87"><a href="#Planner-87"><span class="linenos"> 87</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="Planner-88"><a href="#Planner-88"><span class="linenos"> 88</span></a>
</span><span id="Planner-89"><a href="#Planner-89"><span class="linenos"> 89</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="Planner-90"><a href="#Planner-90"><span class="linenos"> 90</span></a>            <span class="n">move_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span>
</span><span id="Planner-91"><a href="#Planner-91"><span class="linenos"> 91</span></a>        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;end-effector not found as one of the links in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Planner-92"><a href="#Planner-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group</span> <span class="o">=</span> <span class="n">move_group</span>
</span><span id="Planner-93"><a href="#Planner-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_move_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">)</span>
</span><span id="Planner-94"><a href="#Planner-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_move_group_joint_indices</span><span class="p">()</span>
</span><span id="Planner-95"><a href="#Planner-95"><span class="linenos"> 95</span></a>
</span><span id="Planner-96"><a href="#Planner-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_types</span><span class="p">()</span>
</span><span id="Planner-97"><a href="#Planner-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_limits</span><span class="p">())</span>
</span><span id="Planner-98"><a href="#Planner-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner-99"><a href="#Planner-99"><span class="linenos"> 99</span></a>            <span class="n">joint_vel_limits</span>
</span><span id="Planner-100"><a href="#Planner-100"><span class="linenos">100</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="Planner-101"><a href="#Planner-101"><span class="linenos">101</span></a>            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">))</span>
</span><span id="Planner-102"><a href="#Planner-102"><span class="linenos">102</span></a>        <span class="p">)</span>
</span><span id="Planner-103"><a href="#Planner-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner-104"><a href="#Planner-104"><span class="linenos">104</span></a>            <span class="n">joint_acc_limits</span>
</span><span id="Planner-105"><a href="#Planner-105"><span class="linenos">105</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="Planner-106"><a href="#Planner-106"><span class="linenos">106</span></a>            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">))</span>
</span><span id="Planner-107"><a href="#Planner-107"><span class="linenos">107</span></a>        <span class="p">)</span>
</span><span id="Planner-108"><a href="#Planner-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="Planner-109"><a href="#Planner-109"><span class="linenos">109</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner-110"><a href="#Planner-110"><span class="linenos">110</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="Planner-111"><a href="#Planner-111"><span class="linenos">111</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_acc_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner-112"><a href="#Planner-112"><span class="linenos">112</span></a>        <span class="p">)</span>
</span><span id="Planner-113"><a href="#Planner-113"><span class="linenos">113</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner-114"><a href="#Planner-114"><span class="linenos">114</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="Planner-115"><a href="#Planner-115"><span class="linenos">115</span></a>            <span class="sa">f</span><span class="s2">&quot;length of move_group (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner-116"><a href="#Planner-116"><span class="linenos">116</span></a>        <span class="p">)</span>
</span><span id="Planner-117"><a href="#Planner-117"><span class="linenos">117</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner-118"><a href="#Planner-118"><span class="linenos">118</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) &gt; &quot;</span>
</span><span id="Planner-119"><a href="#Planner-119"><span class="linenos">119</span></a>            <span class="sa">f</span><span class="s2">&quot;number of total joints (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner-120"><a href="#Planner-120"><span class="linenos">120</span></a>        <span class="p">)</span>
</span><span id="Planner-121"><a href="#Planner-121"><span class="linenos">121</span></a>
</span><span id="Planner-122"><a href="#Planner-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span> <span class="o">=</span> <span class="n">planning_world</span><span class="o">.</span><span class="n">PlanningWorld</span><span class="p">(</span>
</span><span id="Planner-123"><a href="#Planner-123"><span class="linenos">123</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;robot&quot;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Planner-124"><a href="#Planner-124"><span class="linenos">124</span></a>        <span class="p">)</span>
</span><span id="Planner-125"><a href="#Planner-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planner</span> <span class="o">=</span> <span class="n">ompl</span><span class="o">.</span><span class="n">OMPLPlanner</span><span class="p">(</span><span class="n">world</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="p">)</span>
</span><span id="Planner-126"><a href="#Planner-126"><span class="linenos">126</span></a>
</span><span id="Planner-127"><a href="#Planner-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">replace_package_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_keyword_replacement</span><span class="p">):</span>
</span><span id="Planner-128"><a href="#Planner-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-129"><a href="#Planner-129"><span class="linenos">129</span></a><span class="sd">        some ROS URDF files use package:// keyword to refer the package dir</span>
</span><span id="Planner-130"><a href="#Planner-130"><span class="linenos">130</span></a><span class="sd">        replace it with the given string (default is empty)</span>
</span><span id="Planner-131"><a href="#Planner-131"><span class="linenos">131</span></a>
</span><span id="Planner-132"><a href="#Planner-132"><span class="linenos">132</span></a><span class="sd">        Args:</span>
</span><span id="Planner-133"><a href="#Planner-133"><span class="linenos">133</span></a><span class="sd">            package_keyword_replacement: the string to replace &#39;package://&#39; keyword</span>
</span><span id="Planner-134"><a href="#Planner-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-135"><a href="#Planner-135"><span class="linenos">135</span></a>        <span class="n">rtn_urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span>
</span><span id="Planner-136"><a href="#Planner-136"><span class="linenos">136</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_f</span><span class="p">:</span>
</span><span id="Planner-137"><a href="#Planner-137"><span class="linenos">137</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">in_f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Planner-138"><a href="#Planner-138"><span class="linenos">138</span></a>            <span class="k">if</span> <span class="s2">&quot;package://&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
</span><span id="Planner-139"><a href="#Planner-139"><span class="linenos">139</span></a>                <span class="n">rtn_urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;_package_keyword_replaced.urdf&quot;</span><span class="p">)</span>
</span><span id="Planner-140"><a href="#Planner-140"><span class="linenos">140</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;package://&quot;</span><span class="p">,</span> <span class="n">package_keyword_replacement</span><span class="p">)</span>
</span><span id="Planner-141"><a href="#Planner-141"><span class="linenos">141</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rtn_urdf</span><span class="p">):</span>
</span><span id="Planner-142"><a href="#Planner-142"><span class="linenos">142</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rtn_urdf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_f</span><span class="p">:</span>
</span><span id="Planner-143"><a href="#Planner-143"><span class="linenos">143</span></a>                        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="Planner-144"><a href="#Planner-144"><span class="linenos">144</span></a>        <span class="k">return</span> <span class="n">rtn_urdf</span>
</span><span id="Planner-145"><a href="#Planner-145"><span class="linenos">145</span></a>
</span><span id="Planner-146"><a href="#Planner-146"><span class="linenos">146</span></a>    <span class="k">def</span> <span class="nf">generate_collision_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">echo_freq</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
</span><span id="Planner-147"><a href="#Planner-147"><span class="linenos">147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-148"><a href="#Planner-148"><span class="linenos">148</span></a><span class="sd">        we read the srdf file to get the link pairs that should not collide.</span>
</span><span id="Planner-149"><a href="#Planner-149"><span class="linenos">149</span></a><span class="sd">        if not provided, we need to randomly sample configurations to find the link pairs that will always collide.</span>
</span><span id="Planner-150"><a href="#Planner-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-151"><a href="#Planner-151"><span class="linenos">151</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="Planner-152"><a href="#Planner-152"><span class="linenos">152</span></a>            <span class="s2">&quot;Since no SRDF file is provided. We will first detect link pairs that will&quot;</span>
</span><span id="Planner-153"><a href="#Planner-153"><span class="linenos">153</span></a>            <span class="s2">&quot; always collide. This may take several minutes.&quot;</span>
</span><span id="Planner-154"><a href="#Planner-154"><span class="linenos">154</span></a>        <span class="p">)</span>
</span><span id="Planner-155"><a href="#Planner-155"><span class="linenos">155</span></a>        <span class="n">n_link</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">)</span>
</span><span id="Planner-156"><a href="#Planner-156"><span class="linenos">156</span></a>        <span class="n">cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_link</span><span class="p">,</span> <span class="n">n_link</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="Planner-157"><a href="#Planner-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_time</span><span class="p">):</span>
</span><span id="Planner-158"><a href="#Planner-158"><span class="linenos">158</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_random_configuration</span><span class="p">()</span>
</span><span id="Planner-159"><a href="#Planner-159"><span class="linenos">159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner-160"><a href="#Planner-160"><span class="linenos">160</span></a>            <span class="n">collisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">()</span>
</span><span id="Planner-161"><a href="#Planner-161"><span class="linenos">161</span></a>            <span class="k">for</span> <span class="n">collision</span> <span class="ow">in</span> <span class="n">collisions</span><span class="p">:</span>
</span><span id="Planner-162"><a href="#Planner-162"><span class="linenos">162</span></a>                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name1</span><span class="p">]</span>
</span><span id="Planner-163"><a href="#Planner-163"><span class="linenos">163</span></a>                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name2</span><span class="p">]</span>
</span><span id="Planner-164"><a href="#Planner-164"><span class="linenos">164</span></a>                <span class="n">cnt</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Planner-165"><a href="#Planner-165"><span class="linenos">165</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">echo_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner-166"><a href="#Planner-166"><span class="linenos">166</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finish </span><span class="si">%.1f%%</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">sample_time</span><span class="p">))</span>
</span><span id="Planner-167"><a href="#Planner-167"><span class="linenos">167</span></a>
</span><span id="Planner-168"><a href="#Planner-168"><span class="linenos">168</span></a>        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
</span><span id="Planner-169"><a href="#Planner-169"><span class="linenos">169</span></a>        <span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>
</span><span id="Planner-170"><a href="#Planner-170"><span class="linenos">170</span></a>
</span><span id="Planner-171"><a href="#Planner-171"><span class="linenos">171</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;robot&quot;</span><span class="p">)</span>
</span><span id="Planner-172"><a href="#Planner-172"><span class="linenos">172</span></a>        <span class="n">robot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner-173"><a href="#Planner-173"><span class="linenos">173</span></a>        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">robot_name</span><span class="p">)</span>
</span><span id="Planner-174"><a href="#Planner-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)</span>
</span><span id="Planner-175"><a href="#Planner-175"><span class="linenos">175</span></a>
</span><span id="Planner-176"><a href="#Planner-176"><span class="linenos">176</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_link</span><span class="p">):</span>
</span><span id="Planner-177"><a href="#Planner-177"><span class="linenos">177</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_link</span><span class="p">):</span>
</span><span id="Planner-178"><a href="#Planner-178"><span class="linenos">178</span></a>                <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">sample_time</span><span class="p">:</span>
</span><span id="Planner-179"><a href="#Planner-179"><span class="linenos">179</span></a>                    <span class="n">link1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Planner-180"><a href="#Planner-180"><span class="linenos">180</span></a>                    <span class="n">link2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Planner-181"><a href="#Planner-181"><span class="linenos">181</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="Planner-182"><a href="#Planner-182"><span class="linenos">182</span></a>                        <span class="s2">&quot;Ignore collision pair: (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">), reason:  always collide&quot;</span>
</span><span id="Planner-183"><a href="#Planner-183"><span class="linenos">183</span></a>                        <span class="o">%</span> <span class="p">(</span><span class="n">link1</span><span class="p">,</span> <span class="n">link2</span><span class="p">)</span>
</span><span id="Planner-184"><a href="#Planner-184"><span class="linenos">184</span></a>                    <span class="p">)</span>
</span><span id="Planner-185"><a href="#Planner-185"><span class="linenos">185</span></a>                    <span class="n">collision</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;disable_collisions&quot;</span><span class="p">)</span>
</span><span id="Planner-186"><a href="#Planner-186"><span class="linenos">186</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;link1&quot;</span><span class="p">,</span> <span class="n">link1</span><span class="p">)</span>
</span><span id="Planner-187"><a href="#Planner-187"><span class="linenos">187</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;link2&quot;</span><span class="p">,</span> <span class="n">link2</span><span class="p">)</span>
</span><span id="Planner-188"><a href="#Planner-188"><span class="linenos">188</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="s2">&quot;Default&quot;</span><span class="p">)</span>
</span><span id="Planner-189"><a href="#Planner-189"><span class="linenos">189</span></a>        <span class="n">srdffile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span id="Planner-190"><a href="#Planner-190"><span class="linenos">190</span></a>        <span class="n">srdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="Planner-191"><a href="#Planner-191"><span class="linenos">191</span></a>            <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">))</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">)</span>
</span><span id="Planner-192"><a href="#Planner-192"><span class="linenos">192</span></a>        <span class="p">)</span>
</span><span id="Planner-193"><a href="#Planner-193"><span class="linenos">193</span></a>        <span class="n">srdffile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Planner-194"><a href="#Planner-194"><span class="linenos">194</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving the SRDF file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">)</span>
</span><span id="Planner-195"><a href="#Planner-195"><span class="linenos">195</span></a>
</span><span id="Planner-196"><a href="#Planner-196"><span class="linenos">196</span></a>    <span class="k">def</span> <span class="nf">distance_6D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">q2</span><span class="p">):</span>
</span><span id="Planner-197"><a href="#Planner-197"><span class="linenos">197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-198"><a href="#Planner-198"><span class="linenos">198</span></a><span class="sd">        compute the distance between two poses</span>
</span><span id="Planner-199"><a href="#Planner-199"><span class="linenos">199</span></a>
</span><span id="Planner-200"><a href="#Planner-200"><span class="linenos">200</span></a><span class="sd">        Args:</span>
</span><span id="Planner-201"><a href="#Planner-201"><span class="linenos">201</span></a><span class="sd">            p1: position of pose 1</span>
</span><span id="Planner-202"><a href="#Planner-202"><span class="linenos">202</span></a><span class="sd">            q1: quaternion of pose 1</span>
</span><span id="Planner-203"><a href="#Planner-203"><span class="linenos">203</span></a><span class="sd">            p2: position of pose 2</span>
</span><span id="Planner-204"><a href="#Planner-204"><span class="linenos">204</span></a><span class="sd">            q2: quaternion of pose 2</span>
</span><span id="Planner-205"><a href="#Planner-205"><span class="linenos">205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-206"><a href="#Planner-206"><span class="linenos">206</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="Planner-207"><a href="#Planner-207"><span class="linenos">207</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q1</span> <span class="o">-</span> <span class="n">q2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q1</span> <span class="o">+</span> <span class="n">q2</span><span class="p">)</span>
</span><span id="Planner-208"><a href="#Planner-208"><span class="linenos">208</span></a>        <span class="p">)</span>
</span><span id="Planner-209"><a href="#Planner-209"><span class="linenos">209</span></a>
</span><span id="Planner-210"><a href="#Planner-210"><span class="linenos">210</span></a>    <span class="k">def</span> <span class="nf">check_joint_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
</span><span id="Planner-211"><a href="#Planner-211"><span class="linenos">211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-212"><a href="#Planner-212"><span class="linenos">212</span></a><span class="sd">        check if the joint configuration is within the joint limits</span>
</span><span id="Planner-213"><a href="#Planner-213"><span class="linenos">213</span></a>
</span><span id="Planner-214"><a href="#Planner-214"><span class="linenos">214</span></a><span class="sd">        Args:</span>
</span><span id="Planner-215"><a href="#Planner-215"><span class="linenos">215</span></a><span class="sd">            q: joint configuration</span>
</span><span id="Planner-216"><a href="#Planner-216"><span class="linenos">216</span></a>
</span><span id="Planner-217"><a href="#Planner-217"><span class="linenos">217</span></a><span class="sd">        Returns:</span>
</span><span id="Planner-218"><a href="#Planner-218"><span class="linenos">218</span></a><span class="sd">            True if the joint configuration is within the joint limits</span>
</span><span id="Planner-219"><a href="#Planner-219"><span class="linenos">219</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-220"><a href="#Planner-220"><span class="linenos">220</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span id="Planner-221"><a href="#Planner-221"><span class="linenos">221</span></a>        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Planner-222"><a href="#Planner-222"><span class="linenos">222</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner-223"><a href="#Planner-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JointModelR&quot;</span><span class="p">):</span>
</span><span id="Planner-224"><a href="#Planner-224"><span class="linenos">224</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
</span><span id="Planner-225"><a href="#Planner-225"><span class="linenos">225</span></a>                    <span class="k">continue</span>
</span><span id="Planner-226"><a href="#Planner-226"><span class="linenos">226</span></a>                <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span>
</span><span id="Planner-227"><a href="#Planner-227"><span class="linenos">227</span></a>                    <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span><span id="Planner-228"><a href="#Planner-228"><span class="linenos">228</span></a>                <span class="p">)</span>
</span><span id="Planner-229"><a href="#Planner-229"><span class="linenos">229</span></a>                <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">:</span>
</span><span id="Planner-230"><a href="#Planner-230"><span class="linenos">230</span></a>                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner-231"><a href="#Planner-231"><span class="linenos">231</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Planner-232"><a href="#Planner-232"><span class="linenos">232</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="Planner-233"><a href="#Planner-233"><span class="linenos">233</span></a>                    <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner-234"><a href="#Planner-234"><span class="linenos">234</span></a>                    <span class="ow">or</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner-235"><a href="#Planner-235"><span class="linenos">235</span></a>                <span class="p">):</span>
</span><span id="Planner-236"><a href="#Planner-236"><span class="linenos">236</span></a>                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner-237"><a href="#Planner-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">flag</span>
</span><span id="Planner-238"><a href="#Planner-238"><span class="linenos">238</span></a>
</span><span id="Planner-239"><a href="#Planner-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">pad_qpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpos</span><span class="p">,</span> <span class="n">articulation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Planner-240"><a href="#Planner-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-241"><a href="#Planner-241"><span class="linenos">241</span></a><span class="sd">        if the user does not provide the full qpos but only the move_group joints,</span>
</span><span id="Planner-242"><a href="#Planner-242"><span class="linenos">242</span></a><span class="sd">        pad the qpos with the rest of the joints</span>
</span><span id="Planner-243"><a href="#Planner-243"><span class="linenos">243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-244"><a href="#Planner-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">):</span>
</span><span id="Planner-245"><a href="#Planner-245"><span class="linenos">245</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner-246"><a href="#Planner-246"><span class="linenos">246</span></a>                <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner-247"><a href="#Planner-247"><span class="linenos">247</span></a>                <span class="k">if</span> <span class="n">articulation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="Planner-248"><a href="#Planner-248"><span class="linenos">248</span></a>                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner-249"><a href="#Planner-249"><span class="linenos">249</span></a>            <span class="p">)</span>
</span><span id="Planner-250"><a href="#Planner-250"><span class="linenos">250</span></a>            <span class="n">tmp</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">qpos</span>
</span><span id="Planner-251"><a href="#Planner-251"><span class="linenos">251</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="Planner-252"><a href="#Planner-252"><span class="linenos">252</span></a>
</span><span id="Planner-253"><a href="#Planner-253"><span class="linenos">253</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner-254"><a href="#Planner-254"><span class="linenos">254</span></a>            <span class="sa">f</span><span class="s2">&quot;length of qpos (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="Planner-255"><a href="#Planner-255"><span class="linenos">255</span></a>            <span class="sa">f</span><span class="s2">&quot;number of total joints (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner-256"><a href="#Planner-256"><span class="linenos">256</span></a>        <span class="p">)</span>
</span><span id="Planner-257"><a href="#Planner-257"><span class="linenos">257</span></a>
</span><span id="Planner-258"><a href="#Planner-258"><span class="linenos">258</span></a>        <span class="k">return</span> <span class="n">qpos</span>
</span><span id="Planner-259"><a href="#Planner-259"><span class="linenos">259</span></a>
</span><span id="Planner-260"><a href="#Planner-260"><span class="linenos">260</span></a>    <span class="k">def</span> <span class="nf">check_for_collision</span><span class="p">(</span>
</span><span id="Planner-261"><a href="#Planner-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner-262"><a href="#Planner-262"><span class="linenos">262</span></a>        <span class="n">collision_function</span><span class="p">,</span>
</span><span id="Planner-263"><a href="#Planner-263"><span class="linenos">263</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-264"><a href="#Planner-264"><span class="linenos">264</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-265"><a href="#Planner-265"><span class="linenos">265</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Planner-266"><a href="#Planner-266"><span class="linenos">266</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to check for collision&quot;&quot;&quot;</span>
</span><span id="Planner-267"><a href="#Planner-267"><span class="linenos">267</span></a>        <span class="c1"># handle no user input</span>
</span><span id="Planner-268"><a href="#Planner-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">articulation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Planner-269"><a href="#Planner-269"><span class="linenos">269</span></a>            <span class="n">articulation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span>
</span><span id="Planner-270"><a href="#Planner-270"><span class="linenos">270</span></a>        <span class="k">if</span> <span class="n">qpos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Planner-271"><a href="#Planner-271"><span class="linenos">271</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner-272"><a href="#Planner-272"><span class="linenos">272</span></a>        <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="n">articulation</span><span class="p">)</span>
</span><span id="Planner-273"><a href="#Planner-273"><span class="linenos">273</span></a>
</span><span id="Planner-274"><a href="#Planner-274"><span class="linenos">274</span></a>        <span class="c1"># first save the current qpos</span>
</span><span id="Planner-275"><a href="#Planner-275"><span class="linenos">275</span></a>        <span class="n">old_qpos</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner-276"><a href="#Planner-276"><span class="linenos">276</span></a>        <span class="c1"># set robot to new qpos</span>
</span><span id="Planner-277"><a href="#Planner-277"><span class="linenos">277</span></a>        <span class="n">articulation</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner-278"><a href="#Planner-278"><span class="linenos">278</span></a>        <span class="c1"># find the index of the articulation inside the array</span>
</span><span id="Planner-279"><a href="#Planner-279"><span class="linenos">279</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">get_articulations</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">articulation</span><span class="p">)</span>
</span><span id="Planner-280"><a href="#Planner-280"><span class="linenos">280</span></a>        <span class="c1"># check for self-collision</span>
</span><span id="Planner-281"><a href="#Planner-281"><span class="linenos">281</span></a>        <span class="n">collisions</span> <span class="o">=</span> <span class="n">collision_function</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="Planner-282"><a href="#Planner-282"><span class="linenos">282</span></a>        <span class="c1"># reset qpos</span>
</span><span id="Planner-283"><a href="#Planner-283"><span class="linenos">283</span></a>        <span class="n">articulation</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">old_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner-284"><a href="#Planner-284"><span class="linenos">284</span></a>        <span class="k">return</span> <span class="n">collisions</span>
</span><span id="Planner-285"><a href="#Planner-285"><span class="linenos">285</span></a>
</span><span id="Planner-286"><a href="#Planner-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">check_for_self_collision</span><span class="p">(</span>
</span><span id="Planner-287"><a href="#Planner-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner-288"><a href="#Planner-288"><span class="linenos">288</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-289"><a href="#Planner-289"><span class="linenos">289</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-290"><a href="#Planner-290"><span class="linenos">290</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Planner-291"><a href="#Planner-291"><span class="linenos">291</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the robot is in self-collision.</span>
</span><span id="Planner-292"><a href="#Planner-292"><span class="linenos">292</span></a>
</span><span id="Planner-293"><a href="#Planner-293"><span class="linenos">293</span></a><span class="sd">        Args:</span>
</span><span id="Planner-294"><a href="#Planner-294"><span class="linenos">294</span></a><span class="sd">            articulation: robot model. if none will be self.robot</span>
</span><span id="Planner-295"><a href="#Planner-295"><span class="linenos">295</span></a><span class="sd">            qpos: robot configuration. if none will be the current pose</span>
</span><span id="Planner-296"><a href="#Planner-296"><span class="linenos">296</span></a>
</span><span id="Planner-297"><a href="#Planner-297"><span class="linenos">297</span></a><span class="sd">        Returns:</span>
</span><span id="Planner-298"><a href="#Planner-298"><span class="linenos">298</span></a><span class="sd">            A list of collisions.</span>
</span><span id="Planner-299"><a href="#Planner-299"><span class="linenos">299</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-300"><a href="#Planner-300"><span class="linenos">300</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_collision</span><span class="p">(</span>
</span><span id="Planner-301"><a href="#Planner-301"><span class="linenos">301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">self_collide</span><span class="p">,</span> <span class="n">articulation</span><span class="p">,</span> <span class="n">qpos</span>
</span><span id="Planner-302"><a href="#Planner-302"><span class="linenos">302</span></a>        <span class="p">)</span>
</span><span id="Planner-303"><a href="#Planner-303"><span class="linenos">303</span></a>
</span><span id="Planner-304"><a href="#Planner-304"><span class="linenos">304</span></a>    <span class="k">def</span> <span class="nf">check_for_env_collision</span><span class="p">(</span>
</span><span id="Planner-305"><a href="#Planner-305"><span class="linenos">305</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner-306"><a href="#Planner-306"><span class="linenos">306</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-307"><a href="#Planner-307"><span class="linenos">307</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-308"><a href="#Planner-308"><span class="linenos">308</span></a>        <span class="n">with_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-309"><a href="#Planner-309"><span class="linenos">309</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-310"><a href="#Planner-310"><span class="linenos">310</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Planner-311"><a href="#Planner-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the robot is in collision with the environment</span>
</span><span id="Planner-312"><a href="#Planner-312"><span class="linenos">312</span></a>
</span><span id="Planner-313"><a href="#Planner-313"><span class="linenos">313</span></a><span class="sd">        Args:</span>
</span><span id="Planner-314"><a href="#Planner-314"><span class="linenos">314</span></a><span class="sd">            articulation: robot model. if none will be self.robot</span>
</span><span id="Planner-315"><a href="#Planner-315"><span class="linenos">315</span></a><span class="sd">            qpos: robot configuration. if none will be the current pose</span>
</span><span id="Planner-316"><a href="#Planner-316"><span class="linenos">316</span></a><span class="sd">            with_point_cloud: whether to check collision against point cloud</span>
</span><span id="Planner-317"><a href="#Planner-317"><span class="linenos">317</span></a><span class="sd">            use_attach: whether to include the object attached to the end effector in collision checking</span>
</span><span id="Planner-318"><a href="#Planner-318"><span class="linenos">318</span></a><span class="sd">        Returns:</span>
</span><span id="Planner-319"><a href="#Planner-319"><span class="linenos">319</span></a><span class="sd">            A list of collisions.</span>
</span><span id="Planner-320"><a href="#Planner-320"><span class="linenos">320</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-321"><a href="#Planner-321"><span class="linenos">321</span></a>        <span class="c1"># store previous results</span>
</span><span id="Planner-322"><a href="#Planner-322"><span class="linenos">322</span></a>        <span class="n">prev_use_point_cloud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">use_point_cloud</span>
</span><span id="Planner-323"><a href="#Planner-323"><span class="linenos">323</span></a>        <span class="n">prev_use_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">use_attach</span>
</span><span id="Planner-324"><a href="#Planner-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">with_point_cloud</span><span class="p">)</span>
</span><span id="Planner-325"><a href="#Planner-325"><span class="linenos">325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="Planner-326"><a href="#Planner-326"><span class="linenos">326</span></a>
</span><span id="Planner-327"><a href="#Planner-327"><span class="linenos">327</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_collision</span><span class="p">(</span>
</span><span id="Planner-328"><a href="#Planner-328"><span class="linenos">328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_with_others</span><span class="p">,</span> <span class="n">articulation</span><span class="p">,</span> <span class="n">qpos</span>
</span><span id="Planner-329"><a href="#Planner-329"><span class="linenos">329</span></a>        <span class="p">)</span>
</span><span id="Planner-330"><a href="#Planner-330"><span class="linenos">330</span></a>
</span><span id="Planner-331"><a href="#Planner-331"><span class="linenos">331</span></a>        <span class="c1"># restore</span>
</span><span id="Planner-332"><a href="#Planner-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">prev_use_point_cloud</span><span class="p">)</span>
</span><span id="Planner-333"><a href="#Planner-333"><span class="linenos">333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">prev_use_attach</span><span class="p">)</span>
</span><span id="Planner-334"><a href="#Planner-334"><span class="linenos">334</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="Planner-335"><a href="#Planner-335"><span class="linenos">335</span></a>
</span><span id="Planner-336"><a href="#Planner-336"><span class="linenos">336</span></a>    <span class="k">def</span> <span class="nf">IK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">start_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">[],</span> <span class="n">n_init_qpos</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="Planner-337"><a href="#Planner-337"><span class="linenos">337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-338"><a href="#Planner-338"><span class="linenos">338</span></a><span class="sd">        Inverse kinematics</span>
</span><span id="Planner-339"><a href="#Planner-339"><span class="linenos">339</span></a>
</span><span id="Planner-340"><a href="#Planner-340"><span class="linenos">340</span></a><span class="sd">        Args:</span>
</span><span id="Planner-341"><a href="#Planner-341"><span class="linenos">341</span></a><span class="sd">            goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="Planner-342"><a href="#Planner-342"><span class="linenos">342</span></a><span class="sd">            start_qpos: initial configuration</span>
</span><span id="Planner-343"><a href="#Planner-343"><span class="linenos">343</span></a><span class="sd">            mask: if the value at a given index is True, the joint is *not* used in the IK</span>
</span><span id="Planner-344"><a href="#Planner-344"><span class="linenos">344</span></a><span class="sd">            n_init_qpos: number of random initial configurations</span>
</span><span id="Planner-345"><a href="#Planner-345"><span class="linenos">345</span></a><span class="sd">            threshold: threshold for the distance between the goal pose and the result pose</span>
</span><span id="Planner-346"><a href="#Planner-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-347"><a href="#Planner-347"><span class="linenos">347</span></a>
</span><span id="Planner-348"><a href="#Planner-348"><span class="linenos">348</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="Planner-349"><a href="#Planner-349"><span class="linenos">349</span></a>        <span class="n">min_dis</span> <span class="o">=</span> <span class="mf">1e9</span>
</span><span id="Planner-350"><a href="#Planner-350"><span class="linenos">350</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner-351"><a href="#Planner-351"><span class="linenos">351</span></a>        <span class="n">qpos0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">start_qpos</span><span class="p">)</span>
</span><span id="Planner-352"><a href="#Planner-352"><span class="linenos">352</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Planner-353"><a href="#Planner-353"><span class="linenos">353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">start_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner-354"><a href="#Planner-354"><span class="linenos">354</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_init_qpos</span><span class="p">):</span>
</span><span id="Planner-355"><a href="#Planner-355"><span class="linenos">355</span></a>            <span class="n">ik_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_IK_CLIK</span><span class="p">(</span>
</span><span id="Planner-356"><a href="#Planner-356"><span class="linenos">356</span></a>                <span class="n">index</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">start_qpos</span><span class="p">,</span> <span class="n">mask</span>
</span><span id="Planner-357"><a href="#Planner-357"><span class="linenos">357</span></a>            <span class="p">)</span>
</span><span id="Planner-358"><a href="#Planner-358"><span class="linenos">358</span></a>            <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_joint_limit</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># will clip qpos</span>
</span><span id="Planner-359"><a href="#Planner-359"><span class="linenos">359</span></a>
</span><span id="Planner-360"><a href="#Planner-360"><span class="linenos">360</span></a>            <span class="c1"># check collision</span>
</span><span id="Planner-361"><a href="#Planner-361"><span class="linenos">361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_qpos_all</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Planner-362"><a href="#Planner-362"><span class="linenos">362</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner-363"><a href="#Planner-363"><span class="linenos">363</span></a>                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner-364"><a href="#Planner-364"><span class="linenos">364</span></a>
</span><span id="Planner-365"><a href="#Planner-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="Planner-366"><a href="#Planner-366"><span class="linenos">366</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_forward_kinematics</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Planner-367"><a href="#Planner-367"><span class="linenos">367</span></a>                <span class="n">new_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_pose</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span id="Planner-368"><a href="#Planner-368"><span class="linenos">368</span></a>                <span class="n">tmp_dis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_6D</span><span class="p">(</span>
</span><span id="Planner-369"><a href="#Planner-369"><span class="linenos">369</span></a>                    <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">new_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">new_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
</span><span id="Planner-370"><a href="#Planner-370"><span class="linenos">370</span></a>                <span class="p">)</span>
</span><span id="Planner-371"><a href="#Planner-371"><span class="linenos">371</span></a>                <span class="k">if</span> <span class="n">tmp_dis</span> <span class="o">&lt;</span> <span class="n">min_dis</span><span class="p">:</span>
</span><span id="Planner-372"><a href="#Planner-372"><span class="linenos">372</span></a>                    <span class="n">min_dis</span> <span class="o">=</span> <span class="n">tmp_dis</span>
</span><span id="Planner-373"><a href="#Planner-373"><span class="linenos">373</span></a>                <span class="k">if</span> <span class="n">tmp_dis</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="Planner-374"><a href="#Planner-374"><span class="linenos">374</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner-375"><a href="#Planner-375"><span class="linenos">375</span></a>                    <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Planner-376"><a href="#Planner-376"><span class="linenos">376</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
</span><span id="Planner-377"><a href="#Planner-377"><span class="linenos">377</span></a>                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="Planner-378"><a href="#Planner-378"><span class="linenos">378</span></a>                            <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner-379"><a href="#Planner-379"><span class="linenos">379</span></a>                    <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
</span><span id="Planner-380"><a href="#Planner-380"><span class="linenos">380</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="Planner-381"><a href="#Planner-381"><span class="linenos">381</span></a>            <span class="n">start_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_random_configuration</span><span class="p">()</span>
</span><span id="Planner-382"><a href="#Planner-382"><span class="linenos">382</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="Planner-383"><a href="#Planner-383"><span class="linenos">383</span></a>            <span class="k">if</span> <span class="n">mask_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner-384"><a href="#Planner-384"><span class="linenos">384</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_len</span><span class="p">):</span>
</span><span id="Planner-385"><a href="#Planner-385"><span class="linenos">385</span></a>                    <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span id="Planner-386"><a href="#Planner-386"><span class="linenos">386</span></a>                        <span class="n">start_qpos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpos0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Planner-387"><a href="#Planner-387"><span class="linenos">387</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner-388"><a href="#Planner-388"><span class="linenos">388</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
</span><span id="Planner-389"><a href="#Planner-389"><span class="linenos">389</span></a>        <span class="k">elif</span> <span class="n">min_dis</span> <span class="o">!=</span> <span class="mf">1e9</span><span class="p">:</span>
</span><span id="Planner-390"><a href="#Planner-390"><span class="linenos">390</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;IK Failed! Distance </span><span class="si">%lf</span><span class="s2"> is greater than threshold </span><span class="si">%lf</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="Planner-391"><a href="#Planner-391"><span class="linenos">391</span></a>                <span class="n">min_dis</span><span class="p">,</span>
</span><span id="Planner-392"><a href="#Planner-392"><span class="linenos">392</span></a>                <span class="n">threshold</span><span class="p">,</span>
</span><span id="Planner-393"><a href="#Planner-393"><span class="linenos">393</span></a>            <span class="p">)</span>
</span><span id="Planner-394"><a href="#Planner-394"><span class="linenos">394</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Planner-395"><a href="#Planner-395"><span class="linenos">395</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;IK Failed! Cannot find valid solution.&quot;</span>
</span><span id="Planner-396"><a href="#Planner-396"><span class="linenos">396</span></a>        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">results</span>
</span><span id="Planner-397"><a href="#Planner-397"><span class="linenos">397</span></a>
</span><span id="Planner-398"><a href="#Planner-398"><span class="linenos">398</span></a>    <span class="k">def</span> <span class="nf">TOPP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Planner-399"><a href="#Planner-399"><span class="linenos">399</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-400"><a href="#Planner-400"><span class="linenos">400</span></a><span class="sd">        Time-Optimal Path Parameterization</span>
</span><span id="Planner-401"><a href="#Planner-401"><span class="linenos">401</span></a>
</span><span id="Planner-402"><a href="#Planner-402"><span class="linenos">402</span></a><span class="sd">        Args:</span>
</span><span id="Planner-403"><a href="#Planner-403"><span class="linenos">403</span></a><span class="sd">            path: numpy array of shape (n, dof)</span>
</span><span id="Planner-404"><a href="#Planner-404"><span class="linenos">404</span></a><span class="sd">            step: step size for the discretization</span>
</span><span id="Planner-405"><a href="#Planner-405"><span class="linenos">405</span></a><span class="sd">            verbose: if True, will print the log of TOPPRA</span>
</span><span id="Planner-406"><a href="#Planner-406"><span class="linenos">406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-407"><a href="#Planner-407"><span class="linenos">407</span></a>
</span><span id="Planner-408"><a href="#Planner-408"><span class="linenos">408</span></a>        <span class="n">N_samples</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner-409"><a href="#Planner-409"><span class="linenos">409</span></a>        <span class="n">dof</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Planner-410"><a href="#Planner-410"><span class="linenos">410</span></a>        <span class="k">assert</span> <span class="n">dof</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="Planner-411"><a href="#Planner-411"><span class="linenos">411</span></a>        <span class="k">assert</span> <span class="n">dof</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="Planner-412"><a href="#Planner-412"><span class="linenos">412</span></a>        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_samples</span><span class="p">)</span>
</span><span id="Planner-413"><a href="#Planner-413"><span class="linenos">413</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">SplineInterpolator</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="Planner-414"><a href="#Planner-414"><span class="linenos">414</span></a>        <span class="n">pc_vel</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">JointVelocityConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="Planner-415"><a href="#Planner-415"><span class="linenos">415</span></a>        <span class="n">pc_acc</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">JointAccelerationConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="Planner-416"><a href="#Planner-416"><span class="linenos">416</span></a>        <span class="n">instance</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">TOPPRA</span><span class="p">(</span>
</span><span id="Planner-417"><a href="#Planner-417"><span class="linenos">417</span></a>            <span class="p">[</span><span class="n">pc_vel</span><span class="p">,</span> <span class="n">pc_acc</span><span class="p">],</span> <span class="n">path</span><span class="p">,</span> <span class="n">parametrizer</span><span class="o">=</span><span class="s2">&quot;ParametrizeConstAccel&quot;</span>
</span><span id="Planner-418"><a href="#Planner-418"><span class="linenos">418</span></a>        <span class="p">)</span>
</span><span id="Planner-419"><a href="#Planner-419"><span class="linenos">419</span></a>        <span class="n">jnt_traj</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">compute_trajectory</span><span class="p">()</span>
</span><span id="Planner-420"><a href="#Planner-420"><span class="linenos">420</span></a>        <span class="n">ts_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="n">step</span><span class="p">))</span>
</span><span id="Planner-421"><a href="#Planner-421"><span class="linenos">421</span></a>        <span class="n">qs_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">)</span>
</span><span id="Planner-422"><a href="#Planner-422"><span class="linenos">422</span></a>        <span class="n">qds_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Planner-423"><a href="#Planner-423"><span class="linenos">423</span></a>        <span class="n">qdds_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Planner-424"><a href="#Planner-424"><span class="linenos">424</span></a>        <span class="k">return</span> <span class="n">ts_sample</span><span class="p">,</span> <span class="n">qs_sample</span><span class="p">,</span> <span class="n">qds_sample</span><span class="p">,</span> <span class="n">qdds_sample</span><span class="p">,</span> <span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span>
</span><span id="Planner-425"><a href="#Planner-425"><span class="linenos">425</span></a>
</span><span id="Planner-426"><a href="#Planner-426"><span class="linenos">426</span></a>    <span class="k">def</span> <span class="nf">update_point_cloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="Planner-427"><a href="#Planner-427"><span class="linenos">427</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-428"><a href="#Planner-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="Planner-429"><a href="#Planner-429"><span class="linenos">429</span></a><span class="sd">            pc: numpy array of shape (n, 3)</span>
</span><span id="Planner-430"><a href="#Planner-430"><span class="linenos">430</span></a><span class="sd">            radius: radius of each point. This gives a buffer around each point that planner will avoid</span>
</span><span id="Planner-431"><a href="#Planner-431"><span class="linenos">431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-432"><a href="#Planner-432"><span class="linenos">432</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_point_cloud</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
</span><span id="Planner-433"><a href="#Planner-433"><span class="linenos">433</span></a>
</span><span id="Planner-434"><a href="#Planner-434"><span class="linenos">434</span></a>    <span class="k">def</span> <span class="nf">update_attached_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcl_collision_geometry</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner-435"><a href="#Planner-435"><span class="linenos">435</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to update the attached tool&quot;&quot;&quot;</span>
</span><span id="Planner-436"><a href="#Planner-436"><span class="linenos">436</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner-437"><a href="#Planner-437"><span class="linenos">437</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner-438"><a href="#Planner-438"><span class="linenos">438</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_tool</span><span class="p">(</span><span class="n">fcl_collision_geometry</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="Planner-439"><a href="#Planner-439"><span class="linenos">439</span></a>
</span><span id="Planner-440"><a href="#Planner-440"><span class="linenos">440</span></a>    <span class="k">def</span> <span class="nf">update_attached_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner-441"><a href="#Planner-441"><span class="linenos">441</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-442"><a href="#Planner-442"><span class="linenos">442</span></a><span class="sd">        attach a sphere to some link</span>
</span><span id="Planner-443"><a href="#Planner-443"><span class="linenos">443</span></a>
</span><span id="Planner-444"><a href="#Planner-444"><span class="linenos">444</span></a><span class="sd">        Args:</span>
</span><span id="Planner-445"><a href="#Planner-445"><span class="linenos">445</span></a><span class="sd">            radius: radius of the sphere</span>
</span><span id="Planner-446"><a href="#Planner-446"><span class="linenos">446</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the sphere</span>
</span><span id="Planner-447"><a href="#Planner-447"><span class="linenos">447</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="Planner-448"><a href="#Planner-448"><span class="linenos">448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-449"><a href="#Planner-449"><span class="linenos">449</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner-450"><a href="#Planner-450"><span class="linenos">450</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner-451"><a href="#Planner-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="Planner-452"><a href="#Planner-452"><span class="linenos">452</span></a>
</span><span id="Planner-453"><a href="#Planner-453"><span class="linenos">453</span></a>    <span class="k">def</span> <span class="nf">update_attached_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner-454"><a href="#Planner-454"><span class="linenos">454</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-455"><a href="#Planner-455"><span class="linenos">455</span></a><span class="sd">        attach a box to some link</span>
</span><span id="Planner-456"><a href="#Planner-456"><span class="linenos">456</span></a>
</span><span id="Planner-457"><a href="#Planner-457"><span class="linenos">457</span></a><span class="sd">        Args:</span>
</span><span id="Planner-458"><a href="#Planner-458"><span class="linenos">458</span></a><span class="sd">            size: [x,y,z] size of the box</span>
</span><span id="Planner-459"><a href="#Planner-459"><span class="linenos">459</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the box</span>
</span><span id="Planner-460"><a href="#Planner-460"><span class="linenos">460</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="Planner-461"><a href="#Planner-461"><span class="linenos">461</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-462"><a href="#Planner-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner-463"><a href="#Planner-463"><span class="linenos">463</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner-464"><a href="#Planner-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_box</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="Planner-465"><a href="#Planner-465"><span class="linenos">465</span></a>
</span><span id="Planner-466"><a href="#Planner-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">update_attached_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_path</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner-467"><a href="#Planner-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-468"><a href="#Planner-468"><span class="linenos">468</span></a><span class="sd">        attach a mesh to some link</span>
</span><span id="Planner-469"><a href="#Planner-469"><span class="linenos">469</span></a>
</span><span id="Planner-470"><a href="#Planner-470"><span class="linenos">470</span></a><span class="sd">        Args:</span>
</span><span id="Planner-471"><a href="#Planner-471"><span class="linenos">471</span></a><span class="sd">            mesh_path: path to the mesh</span>
</span><span id="Planner-472"><a href="#Planner-472"><span class="linenos">472</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the mesh</span>
</span><span id="Planner-473"><a href="#Planner-473"><span class="linenos">473</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="Planner-474"><a href="#Planner-474"><span class="linenos">474</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-475"><a href="#Planner-475"><span class="linenos">475</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner-476"><a href="#Planner-476"><span class="linenos">476</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner-477"><a href="#Planner-477"><span class="linenos">477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_mesh</span><span class="p">(</span><span class="n">mesh_path</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span><span id="Planner-478"><a href="#Planner-478"><span class="linenos">478</span></a>
</span><span id="Planner-479"><a href="#Planner-479"><span class="linenos">479</span></a>    <span class="k">def</span> <span class="nf">set_base_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose</span><span class="p">):</span>
</span><span id="Planner-480"><a href="#Planner-480"><span class="linenos">480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-481"><a href="#Planner-481"><span class="linenos">481</span></a><span class="sd">        tell the planner where the base of the robot is w.r.t the world frame</span>
</span><span id="Planner-482"><a href="#Planner-482"><span class="linenos">482</span></a>
</span><span id="Planner-483"><a href="#Planner-483"><span class="linenos">483</span></a><span class="sd">        Args:</span>
</span><span id="Planner-484"><a href="#Planner-484"><span class="linenos">484</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the base</span>
</span><span id="Planner-485"><a href="#Planner-485"><span class="linenos">485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-486"><a href="#Planner-486"><span class="linenos">486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_base_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
</span><span id="Planner-487"><a href="#Planner-487"><span class="linenos">487</span></a>
</span><span id="Planner-488"><a href="#Planner-488"><span class="linenos">488</span></a>    <span class="k">def</span> <span class="nf">set_normal_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">collision_object</span><span class="p">):</span>
</span><span id="Planner-489"><a href="#Planner-489"><span class="linenos">489</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;adds or updates a non-articulated collision object in the scene&quot;&quot;&quot;</span>
</span><span id="Planner-490"><a href="#Planner-490"><span class="linenos">490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_normal_object</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">collision_object</span><span class="p">)</span>
</span><span id="Planner-491"><a href="#Planner-491"><span class="linenos">491</span></a>
</span><span id="Planner-492"><a href="#Planner-492"><span class="linenos">492</span></a>    <span class="k">def</span> <span class="nf">remove_normal_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="Planner-493"><a href="#Planner-493"><span class="linenos">493</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;returns true if the object was removed, false if it was not found&quot;&quot;&quot;</span>
</span><span id="Planner-494"><a href="#Planner-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">remove_normal_object</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="Planner-495"><a href="#Planner-495"><span class="linenos">495</span></a>
</span><span id="Planner-496"><a href="#Planner-496"><span class="linenos">496</span></a>    <span class="k">def</span> <span class="nf">plan_qpos_to_qpos</span><span class="p">(</span>
</span><span id="Planner-497"><a href="#Planner-497"><span class="linenos">497</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner-498"><a href="#Planner-498"><span class="linenos">498</span></a>        <span class="n">goal_qposes</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="Planner-499"><a href="#Planner-499"><span class="linenos">499</span></a>        <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="Planner-500"><a href="#Planner-500"><span class="linenos">500</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner-501"><a href="#Planner-501"><span class="linenos">501</span></a>        <span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner-502"><a href="#Planner-502"><span class="linenos">502</span></a>        <span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Planner-503"><a href="#Planner-503"><span class="linenos">503</span></a>        <span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Planner-504"><a href="#Planner-504"><span class="linenos">504</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-505"><a href="#Planner-505"><span class="linenos">505</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-506"><a href="#Planner-506"><span class="linenos">506</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-507"><a href="#Planner-507"><span class="linenos">507</span></a>        <span class="n">planner_name</span><span class="o">=</span><span class="s2">&quot;RRTConnect&quot;</span><span class="p">,</span>
</span><span id="Planner-508"><a href="#Planner-508"><span class="linenos">508</span></a>        <span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-509"><a href="#Planner-509"><span class="linenos">509</span></a>        <span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-510"><a href="#Planner-510"><span class="linenos">510</span></a>        <span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-511"><a href="#Planner-511"><span class="linenos">511</span></a>        <span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="Planner-512"><a href="#Planner-512"><span class="linenos">512</span></a>        <span class="n">fixed_joint_indices</span><span class="o">=</span><span class="p">[],</span>
</span><span id="Planner-513"><a href="#Planner-513"><span class="linenos">513</span></a>    <span class="p">):</span>
</span><span id="Planner-514"><a href="#Planner-514"><span class="linenos">514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-515"><a href="#Planner-515"><span class="linenos">515</span></a><span class="sd">        plan a path from a specified joint position to a goal pose</span>
</span><span id="Planner-516"><a href="#Planner-516"><span class="linenos">516</span></a>
</span><span id="Planner-517"><a href="#Planner-517"><span class="linenos">517</span></a><span class="sd">        Args:</span>
</span><span id="Planner-518"><a href="#Planner-518"><span class="linenos">518</span></a><span class="sd">            goal_pose: 7D pose of the end-effector [x,y,z,qw,qx,qy,qz]</span>
</span><span id="Planner-519"><a href="#Planner-519"><span class="linenos">519</span></a><span class="sd">            current_qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="Planner-520"><a href="#Planner-520"><span class="linenos">520</span></a><span class="sd">            mask: mask for IK. When set, the IK will leave certain joints out of planning</span>
</span><span id="Planner-521"><a href="#Planner-521"><span class="linenos">521</span></a><span class="sd">            time_step: time step for TOPP</span>
</span><span id="Planner-522"><a href="#Planner-522"><span class="linenos">522</span></a><span class="sd">            rrt_range: step size for RRT</span>
</span><span id="Planner-523"><a href="#Planner-523"><span class="linenos">523</span></a><span class="sd">            planning_time: time limit for RRT</span>
</span><span id="Planner-524"><a href="#Planner-524"><span class="linenos">524</span></a><span class="sd">            fix_joint_limits: if True, will clip the joint configuration to be within the joint limits</span>
</span><span id="Planner-525"><a href="#Planner-525"><span class="linenos">525</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="Planner-526"><a href="#Planner-526"><span class="linenos">526</span></a><span class="sd">            use_attach: if True, will consider the attached tool collision when planning</span>
</span><span id="Planner-527"><a href="#Planner-527"><span class="linenos">527</span></a><span class="sd">            verbose: if True, will print the log of OMPL and TOPPRA</span>
</span><span id="Planner-528"><a href="#Planner-528"><span class="linenos">528</span></a><span class="sd">            planner_name: planner name pick from {&quot;RRTConnect&quot;, &quot;RRT*&quot;}</span>
</span><span id="Planner-529"><a href="#Planner-529"><span class="linenos">529</span></a><span class="sd">            fixed_joint_indices: list of indices of joints that are fixed during planning</span>
</span><span id="Planner-530"><a href="#Planner-530"><span class="linenos">530</span></a><span class="sd">            constraint_function: evals to 0 when constraint is satisfied</span>
</span><span id="Planner-531"><a href="#Planner-531"><span class="linenos">531</span></a><span class="sd">            constraint_jacobian: jacobian of constraint_function</span>
</span><span id="Planner-532"><a href="#Planner-532"><span class="linenos">532</span></a><span class="sd">            constraint_tolerance: tolerance for constraint_function</span>
</span><span id="Planner-533"><a href="#Planner-533"><span class="linenos">533</span></a><span class="sd">            no_simplification: if true, will not simplify the path. constraint planning does not support simplification</span>
</span><span id="Planner-534"><a href="#Planner-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-535"><a href="#Planner-535"><span class="linenos">535</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">use_point_cloud</span><span class="p">)</span>
</span><span id="Planner-536"><a href="#Planner-536"><span class="linenos">536</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="Planner-537"><a href="#Planner-537"><span class="linenos">537</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">current_qpos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner-538"><a href="#Planner-538"><span class="linenos">538</span></a>        <span class="k">if</span> <span class="n">fix_joint_limits</span><span class="p">:</span>
</span><span id="Planner-539"><a href="#Planner-539"><span class="linenos">539</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner-540"><a href="#Planner-540"><span class="linenos">540</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Planner-541"><a href="#Planner-541"><span class="linenos">541</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner-542"><a href="#Planner-542"><span class="linenos">542</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Planner-543"><a href="#Planner-543"><span class="linenos">543</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner-544"><a href="#Planner-544"><span class="linenos">544</span></a>
</span><span id="Planner-545"><a href="#Planner-545"><span class="linenos">545</span></a>        <span class="n">current_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">)</span>
</span><span id="Planner-546"><a href="#Planner-546"><span class="linenos">546</span></a>
</span><span id="Planner-547"><a href="#Planner-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner-548"><a href="#Planner-548"><span class="linenos">548</span></a>        <span class="n">collisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">()</span>
</span><span id="Planner-549"><a href="#Planner-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner-550"><a href="#Planner-550"><span class="linenos">550</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid start state!&quot;</span><span class="p">)</span>
</span><span id="Planner-551"><a href="#Planner-551"><span class="linenos">551</span></a>            <span class="k">for</span> <span class="n">collision</span> <span class="ow">in</span> <span class="n">collisions</span><span class="p">:</span>
</span><span id="Planner-552"><a href="#Planner-552"><span class="linenos">552</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Planner-553"><a href="#Planner-553"><span class="linenos">553</span></a>                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> collide!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name1</span><span class="p">,</span> <span class="n">collision</span><span class="o">.</span><span class="n">link_name2</span><span class="p">)</span>
</span><span id="Planner-554"><a href="#Planner-554"><span class="linenos">554</span></a>                <span class="p">)</span>
</span><span id="Planner-555"><a href="#Planner-555"><span class="linenos">555</span></a>
</span><span id="Planner-556"><a href="#Planner-556"><span class="linenos">556</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner-557"><a href="#Planner-557"><span class="linenos">557</span></a>
</span><span id="Planner-558"><a href="#Planner-558"><span class="linenos">558</span></a>        <span class="n">goal_qpos_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Planner-559"><a href="#Planner-559"><span class="linenos">559</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qposes</span><span class="p">)):</span>
</span><span id="Planner-560"><a href="#Planner-560"><span class="linenos">560</span></a>            <span class="n">goal_qpos_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_qposes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Planner-561"><a href="#Planner-561"><span class="linenos">561</span></a>
</span><span id="Planner-562"><a href="#Planner-562"><span class="linenos">562</span></a>        <span class="n">fixed_joints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Planner-563"><a href="#Planner-563"><span class="linenos">563</span></a>        <span class="k">for</span> <span class="n">joint_idx</span> <span class="ow">in</span> <span class="n">fixed_joint_indices</span><span class="p">:</span>
</span><span id="Planner-564"><a href="#Planner-564"><span class="linenos">564</span></a>            <span class="n">fixed_joints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ompl</span><span class="o">.</span><span class="n">FixedJoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">joint_idx</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">joint_idx</span><span class="p">]))</span>
</span><span id="Planner-565"><a href="#Planner-565"><span class="linenos">565</span></a>
</span><span id="Planner-566"><a href="#Planner-566"><span class="linenos">566</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Planner-567"><a href="#Planner-567"><span class="linenos">567</span></a>        <span class="n">status</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span>
</span><span id="Planner-568"><a href="#Planner-568"><span class="linenos">568</span></a>            <span class="n">current_qpos</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="Planner-569"><a href="#Planner-569"><span class="linenos">569</span></a>            <span class="n">goal_qpos_</span><span class="p">,</span>
</span><span id="Planner-570"><a href="#Planner-570"><span class="linenos">570</span></a>            <span class="nb">range</span><span class="o">=</span><span class="n">rrt_range</span><span class="p">,</span>
</span><span id="Planner-571"><a href="#Planner-571"><span class="linenos">571</span></a>            <span class="n">time</span><span class="o">=</span><span class="n">planning_time</span><span class="p">,</span>
</span><span id="Planner-572"><a href="#Planner-572"><span class="linenos">572</span></a>            <span class="n">fixed_joints</span><span class="o">=</span><span class="n">fixed_joints</span><span class="p">,</span>
</span><span id="Planner-573"><a href="#Planner-573"><span class="linenos">573</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Planner-574"><a href="#Planner-574"><span class="linenos">574</span></a>            <span class="n">planner_name</span><span class="o">=</span><span class="n">planner_name</span><span class="p">,</span>
</span><span id="Planner-575"><a href="#Planner-575"><span class="linenos">575</span></a>            <span class="n">no_simplification</span><span class="o">=</span><span class="n">no_simplification</span><span class="p">,</span>
</span><span id="Planner-576"><a href="#Planner-576"><span class="linenos">576</span></a>            <span class="n">constraint_function</span><span class="o">=</span><span class="n">constraint_function</span><span class="p">,</span>
</span><span id="Planner-577"><a href="#Planner-577"><span class="linenos">577</span></a>            <span class="n">constraint_jacobian</span><span class="o">=</span><span class="n">constraint_jacobian</span><span class="p">,</span>
</span><span id="Planner-578"><a href="#Planner-578"><span class="linenos">578</span></a>            <span class="n">constraint_tolerance</span><span class="o">=</span><span class="n">constraint_tolerance</span><span class="p">,</span>
</span><span id="Planner-579"><a href="#Planner-579"><span class="linenos">579</span></a>        <span class="p">)</span>
</span><span id="Planner-580"><a href="#Planner-580"><span class="linenos">580</span></a>
</span><span id="Planner-581"><a href="#Planner-581"><span class="linenos">581</span></a>        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Exact solution&quot;</span><span class="p">:</span>
</span><span id="Planner-582"><a href="#Planner-582"><span class="linenos">582</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner-583"><a href="#Planner-583"><span class="linenos">583</span></a>                <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
</span><span id="Planner-584"><a href="#Planner-584"><span class="linenos">584</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Planner-585"><a href="#Planner-585"><span class="linenos">585</span></a>                <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</span><span id="Planner-586"><a href="#Planner-586"><span class="linenos">586</span></a>            <span class="n">times</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOPP</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">time_step</span><span class="p">)</span>
</span><span id="Planner-587"><a href="#Planner-587"><span class="linenos">587</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="Planner-588"><a href="#Planner-588"><span class="linenos">588</span></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span id="Planner-589"><a href="#Planner-589"><span class="linenos">589</span></a>                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
</span><span id="Planner-590"><a href="#Planner-590"><span class="linenos">590</span></a>                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="Planner-591"><a href="#Planner-591"><span class="linenos">591</span></a>                <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span>
</span><span id="Planner-592"><a href="#Planner-592"><span class="linenos">592</span></a>                <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span>
</span><span id="Planner-593"><a href="#Planner-593"><span class="linenos">593</span></a>                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="Planner-594"><a href="#Planner-594"><span class="linenos">594</span></a>            <span class="p">}</span>
</span><span id="Planner-595"><a href="#Planner-595"><span class="linenos">595</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Planner-596"><a href="#Planner-596"><span class="linenos">596</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;RRT Failed. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">}</span>
</span><span id="Planner-597"><a href="#Planner-597"><span class="linenos">597</span></a>
</span><span id="Planner-598"><a href="#Planner-598"><span class="linenos">598</span></a>    <span class="k">def</span> <span class="nf">plan_qpos_to_pose</span><span class="p">(</span>
</span><span id="Planner-599"><a href="#Planner-599"><span class="linenos">599</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner-600"><a href="#Planner-600"><span class="linenos">600</span></a>        <span class="n">goal_pose</span><span class="p">,</span>
</span><span id="Planner-601"><a href="#Planner-601"><span class="linenos">601</span></a>        <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="Planner-602"><a href="#Planner-602"><span class="linenos">602</span></a>        <span class="n">mask</span><span class="o">=</span><span class="p">[],</span>
</span><span id="Planner-603"><a href="#Planner-603"><span class="linenos">603</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner-604"><a href="#Planner-604"><span class="linenos">604</span></a>        <span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner-605"><a href="#Planner-605"><span class="linenos">605</span></a>        <span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Planner-606"><a href="#Planner-606"><span class="linenos">606</span></a>        <span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Planner-607"><a href="#Planner-607"><span class="linenos">607</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-608"><a href="#Planner-608"><span class="linenos">608</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-609"><a href="#Planner-609"><span class="linenos">609</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-610"><a href="#Planner-610"><span class="linenos">610</span></a>        <span class="n">wrt_world</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-611"><a href="#Planner-611"><span class="linenos">611</span></a>        <span class="n">planner_name</span><span class="o">=</span><span class="s2">&quot;RRTConnect&quot;</span><span class="p">,</span>
</span><span id="Planner-612"><a href="#Planner-612"><span class="linenos">612</span></a>        <span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-613"><a href="#Planner-613"><span class="linenos">613</span></a>        <span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-614"><a href="#Planner-614"><span class="linenos">614</span></a>        <span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner-615"><a href="#Planner-615"><span class="linenos">615</span></a>        <span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="Planner-616"><a href="#Planner-616"><span class="linenos">616</span></a>    <span class="p">):</span>
</span><span id="Planner-617"><a href="#Planner-617"><span class="linenos">617</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-618"><a href="#Planner-618"><span class="linenos">618</span></a><span class="sd">        plan from a start configuration to a goal pose of the end-effector</span>
</span><span id="Planner-619"><a href="#Planner-619"><span class="linenos">619</span></a>
</span><span id="Planner-620"><a href="#Planner-620"><span class="linenos">620</span></a><span class="sd">        Args:</span>
</span><span id="Planner-621"><a href="#Planner-621"><span class="linenos">621</span></a><span class="sd">            goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="Planner-622"><a href="#Planner-622"><span class="linenos">622</span></a><span class="sd">            current_qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="Planner-623"><a href="#Planner-623"><span class="linenos">623</span></a><span class="sd">            mask: if the value at a given index is True, the joint is *not* used in the IK</span>
</span><span id="Planner-624"><a href="#Planner-624"><span class="linenos">624</span></a><span class="sd">            time_step: time step for TOPPRA (time parameterization of path)</span>
</span><span id="Planner-625"><a href="#Planner-625"><span class="linenos">625</span></a><span class="sd">            rrt_range: step size for RRT</span>
</span><span id="Planner-626"><a href="#Planner-626"><span class="linenos">626</span></a><span class="sd">            planning_time: time limit for RRT</span>
</span><span id="Planner-627"><a href="#Planner-627"><span class="linenos">627</span></a><span class="sd">            fix_joint_limits: if True, will clip the joint configuration to be within the joint limits</span>
</span><span id="Planner-628"><a href="#Planner-628"><span class="linenos">628</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="Planner-629"><a href="#Planner-629"><span class="linenos">629</span></a><span class="sd">            use_attach: if True, will consider the attached tool collision when planning</span>
</span><span id="Planner-630"><a href="#Planner-630"><span class="linenos">630</span></a><span class="sd">            verbose: if True, will print the log of OMPL and TOPPRA</span>
</span><span id="Planner-631"><a href="#Planner-631"><span class="linenos">631</span></a><span class="sd">            wrt_world: if true, interpret the target pose with respect to the world frame instead of the base frame</span>
</span><span id="Planner-632"><a href="#Planner-632"><span class="linenos">632</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-633"><a href="#Planner-633"><span class="linenos">633</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">current_qpos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner-634"><a href="#Planner-634"><span class="linenos">634</span></a>        <span class="k">if</span> <span class="n">fix_joint_limits</span><span class="p">:</span>
</span><span id="Planner-635"><a href="#Planner-635"><span class="linenos">635</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner-636"><a href="#Planner-636"><span class="linenos">636</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Planner-637"><a href="#Planner-637"><span class="linenos">637</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner-638"><a href="#Planner-638"><span class="linenos">638</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Planner-639"><a href="#Planner-639"><span class="linenos">639</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner-640"><a href="#Planner-640"><span class="linenos">640</span></a>
</span><span id="Planner-641"><a href="#Planner-641"><span class="linenos">641</span></a>        <span class="k">if</span> <span class="n">wrt_world</span><span class="p">:</span>
</span><span id="Planner-642"><a href="#Planner-642"><span class="linenos">642</span></a>            <span class="n">base_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_base_pose</span><span class="p">()</span>
</span><span id="Planner-643"><a href="#Planner-643"><span class="linenos">643</span></a>            <span class="n">base_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="Planner-644"><a href="#Planner-644"><span class="linenos">644</span></a>            <span class="n">base_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Planner-645"><a href="#Planner-645"><span class="linenos">645</span></a>            <span class="n">base_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">base_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="Planner-646"><a href="#Planner-646"><span class="linenos">646</span></a>            <span class="n">goal_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="Planner-647"><a href="#Planner-647"><span class="linenos">647</span></a>            <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Planner-648"><a href="#Planner-648"><span class="linenos">648</span></a>            <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="Planner-649"><a href="#Planner-649"><span class="linenos">649</span></a>            <span class="n">goal_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">base_tf</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">goal_tf</span><span class="p">)</span>
</span><span id="Planner-650"><a href="#Planner-650"><span class="linenos">650</span></a>            <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Planner-651"><a href="#Planner-651"><span class="linenos">651</span></a>            <span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">mat2quat</span><span class="p">(</span><span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="Planner-652"><a href="#Planner-652"><span class="linenos">652</span></a>
</span><span id="Planner-653"><a href="#Planner-653"><span class="linenos">653</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner-654"><a href="#Planner-654"><span class="linenos">654</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner-655"><a href="#Planner-655"><span class="linenos">655</span></a>        <span class="p">)</span>  <span class="c1"># we need to take only the move_group joints when planning</span>
</span><span id="Planner-656"><a href="#Planner-656"><span class="linenos">656</span></a>
</span><span id="Planner-657"><a href="#Planner-657"><span class="linenos">657</span></a>        <span class="n">ik_status</span><span class="p">,</span> <span class="n">goal_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IK</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="Planner-658"><a href="#Planner-658"><span class="linenos">658</span></a>        <span class="k">if</span> <span class="n">ik_status</span> <span class="o">!=</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
</span><span id="Planner-659"><a href="#Planner-659"><span class="linenos">659</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">ik_status</span><span class="p">}</span>
</span><span id="Planner-660"><a href="#Planner-660"><span class="linenos">660</span></a>
</span><span id="Planner-661"><a href="#Planner-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner-662"><a href="#Planner-662"><span class="linenos">662</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IK results:&quot;</span><span class="p">)</span>
</span><span id="Planner-663"><a href="#Planner-663"><span class="linenos">663</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="Planner-664"><a href="#Planner-664"><span class="linenos">664</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Planner-665"><a href="#Planner-665"><span class="linenos">665</span></a>
</span><span id="Planner-666"><a href="#Planner-666"><span class="linenos">666</span></a>        <span class="n">goal_qpos_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Planner-667"><a href="#Planner-667"><span class="linenos">667</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="Planner-668"><a href="#Planner-668"><span class="linenos">668</span></a>            <span class="n">goal_qpos_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Planner-669"><a href="#Planner-669"><span class="linenos">669</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner-670"><a href="#Planner-670"><span class="linenos">670</span></a>
</span><span id="Planner-671"><a href="#Planner-671"><span class="linenos">671</span></a>        <span class="n">ik_status</span><span class="p">,</span> <span class="n">goal_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IK</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="Planner-672"><a href="#Planner-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="n">ik_status</span> <span class="o">!=</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
</span><span id="Planner-673"><a href="#Planner-673"><span class="linenos">673</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">ik_status</span><span class="p">}</span>
</span><span id="Planner-674"><a href="#Planner-674"><span class="linenos">674</span></a>
</span><span id="Planner-675"><a href="#Planner-675"><span class="linenos">675</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner-676"><a href="#Planner-676"><span class="linenos">676</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IK results:&quot;</span><span class="p">)</span>
</span><span id="Planner-677"><a href="#Planner-677"><span class="linenos">677</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="Planner-678"><a href="#Planner-678"><span class="linenos">678</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Planner-679"><a href="#Planner-679"><span class="linenos">679</span></a>
</span><span id="Planner-680"><a href="#Planner-680"><span class="linenos">680</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_qpos_to_qpos</span><span class="p">(</span>
</span><span id="Planner-681"><a href="#Planner-681"><span class="linenos">681</span></a>            <span class="n">goal_qpos</span><span class="p">,</span>
</span><span id="Planner-682"><a href="#Planner-682"><span class="linenos">682</span></a>            <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="Planner-683"><a href="#Planner-683"><span class="linenos">683</span></a>            <span class="n">time_step</span><span class="p">,</span>
</span><span id="Planner-684"><a href="#Planner-684"><span class="linenos">684</span></a>            <span class="n">rrt_range</span><span class="p">,</span>
</span><span id="Planner-685"><a href="#Planner-685"><span class="linenos">685</span></a>            <span class="n">planning_time</span><span class="p">,</span>
</span><span id="Planner-686"><a href="#Planner-686"><span class="linenos">686</span></a>            <span class="n">fix_joint_limits</span><span class="p">,</span>
</span><span id="Planner-687"><a href="#Planner-687"><span class="linenos">687</span></a>            <span class="n">use_point_cloud</span><span class="p">,</span>
</span><span id="Planner-688"><a href="#Planner-688"><span class="linenos">688</span></a>            <span class="n">use_attach</span><span class="p">,</span>
</span><span id="Planner-689"><a href="#Planner-689"><span class="linenos">689</span></a>            <span class="n">verbose</span><span class="p">,</span>
</span><span id="Planner-690"><a href="#Planner-690"><span class="linenos">690</span></a>            <span class="n">planner_name</span><span class="p">,</span>
</span><span id="Planner-691"><a href="#Planner-691"><span class="linenos">691</span></a>            <span class="n">no_simplification</span><span class="p">,</span>
</span><span id="Planner-692"><a href="#Planner-692"><span class="linenos">692</span></a>            <span class="n">constraint_function</span><span class="p">,</span>
</span><span id="Planner-693"><a href="#Planner-693"><span class="linenos">693</span></a>            <span class="n">constraint_jacobian</span><span class="p">,</span>
</span><span id="Planner-694"><a href="#Planner-694"><span class="linenos">694</span></a>            <span class="n">constraint_tolerance</span><span class="p">,</span>
</span><span id="Planner-695"><a href="#Planner-695"><span class="linenos">695</span></a>        <span class="p">)</span>
</span><span id="Planner-696"><a href="#Planner-696"><span class="linenos">696</span></a>
</span><span id="Planner-697"><a href="#Planner-697"><span class="linenos">697</span></a>    <span class="k">def</span> <span class="nf">plan_screw</span><span class="p">(</span>
</span><span id="Planner-698"><a href="#Planner-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner-699"><a href="#Planner-699"><span class="linenos">699</span></a>        <span class="n">target_pose</span><span class="p">,</span>
</span><span id="Planner-700"><a href="#Planner-700"><span class="linenos">700</span></a>        <span class="n">qpos</span><span class="p">,</span>
</span><span id="Planner-701"><a href="#Planner-701"><span class="linenos">701</span></a>        <span class="n">qpos_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner-702"><a href="#Planner-702"><span class="linenos">702</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner-703"><a href="#Planner-703"><span class="linenos">703</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-704"><a href="#Planner-704"><span class="linenos">704</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-705"><a href="#Planner-705"><span class="linenos">705</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner-706"><a href="#Planner-706"><span class="linenos">706</span></a>    <span class="p">):</span>
</span><span id="Planner-707"><a href="#Planner-707"><span class="linenos">707</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner-708"><a href="#Planner-708"><span class="linenos">708</span></a><span class="sd">        plan from a start configuration to a goal pose of the end-effector using screw motion</span>
</span><span id="Planner-709"><a href="#Planner-709"><span class="linenos">709</span></a>
</span><span id="Planner-710"><a href="#Planner-710"><span class="linenos">710</span></a><span class="sd">        Args:</span>
</span><span id="Planner-711"><a href="#Planner-711"><span class="linenos">711</span></a><span class="sd">            target_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="Planner-712"><a href="#Planner-712"><span class="linenos">712</span></a><span class="sd">            qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="Planner-713"><a href="#Planner-713"><span class="linenos">713</span></a><span class="sd">            qpos_step: size of the random step for RRT</span>
</span><span id="Planner-714"><a href="#Planner-714"><span class="linenos">714</span></a><span class="sd">            time_step: time step for the discretization</span>
</span><span id="Planner-715"><a href="#Planner-715"><span class="linenos">715</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="Planner-716"><a href="#Planner-716"><span class="linenos">716</span></a><span class="sd">            use_attach: if True, will use the attached tool to avoid collision</span>
</span><span id="Planner-717"><a href="#Planner-717"><span class="linenos">717</span></a><span class="sd">            verbose: if True, will print the log of TOPPRA</span>
</span><span id="Planner-718"><a href="#Planner-718"><span class="linenos">718</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner-719"><a href="#Planner-719"><span class="linenos">719</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">use_point_cloud</span><span class="p">)</span>
</span><span id="Planner-720"><a href="#Planner-720"><span class="linenos">720</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="Planner-721"><a href="#Planner-721"><span class="linenos">721</span></a>        <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="Planner-722"><a href="#Planner-722"><span class="linenos">722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner-723"><a href="#Planner-723"><span class="linenos">723</span></a>
</span><span id="Planner-724"><a href="#Planner-724"><span class="linenos">724</span></a>        <span class="k">def</span> <span class="nf">pose7D2mat</span><span class="p">(</span><span class="n">pose</span><span class="p">):</span>
</span><span id="Planner-725"><a href="#Planner-725"><span class="linenos">725</span></a>            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="Planner-726"><a href="#Planner-726"><span class="linenos">726</span></a>            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Planner-727"><a href="#Planner-727"><span class="linenos">727</span></a>            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="Planner-728"><a href="#Planner-728"><span class="linenos">728</span></a>            <span class="k">return</span> <span class="n">mat</span>
</span><span id="Planner-729"><a href="#Planner-729"><span class="linenos">729</span></a>
</span><span id="Planner-730"><a href="#Planner-730"><span class="linenos">730</span></a>        <span class="k">def</span> <span class="nf">skew</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
</span><span id="Planner-731"><a href="#Planner-731"><span class="linenos">731</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="Planner-732"><a href="#Planner-732"><span class="linenos">732</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="Planner-733"><a href="#Planner-733"><span class="linenos">733</span></a>                <span class="p">[</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="Planner-734"><a href="#Planner-734"><span class="linenos">734</span></a>                <span class="p">[</span><span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="Planner-735"><a href="#Planner-735"><span class="linenos">735</span></a>            <span class="p">])</span>
</span><span id="Planner-736"><a href="#Planner-736"><span class="linenos">736</span></a>
</span><span id="Planner-737"><a href="#Planner-737"><span class="linenos">737</span></a>        <span class="k">def</span> <span class="nf">pose2exp_coordinate</span><span class="p">(</span><span class="n">pose</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Planner-738"><a href="#Planner-738"><span class="linenos">738</span></a>            <span class="k">def</span> <span class="nf">rot2so3</span><span class="p">(</span><span class="n">rotation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="Planner-739"><a href="#Planner-739"><span class="linenos">739</span></a>                <span class="k">assert</span> <span class="n">rotation</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Planner-740"><a href="#Planner-740"><span class="linenos">740</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="Planner-741"><a href="#Planner-741"><span class="linenos">741</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span>
</span><span id="Planner-742"><a href="#Planner-742"><span class="linenos">742</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner-743"><a href="#Planner-743"><span class="linenos">743</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mf">1e6</span>
</span><span id="Planner-744"><a href="#Planner-744"><span class="linenos">744</span></a>                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Planner-745"><a href="#Planner-745"><span class="linenos">745</span></a>                <span class="n">omega</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner-746"><a href="#Planner-746"><span class="linenos">746</span></a>                    <span class="mi">1</span>
</span><span id="Planner-747"><a href="#Planner-747"><span class="linenos">747</span></a>                    <span class="o">/</span> <span class="mi">2</span>
</span><span id="Planner-748"><a href="#Planner-748"><span class="linenos">748</span></a>                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="Planner-749"><a href="#Planner-749"><span class="linenos">749</span></a>                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="Planner-750"><a href="#Planner-750"><span class="linenos">750</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="Planner-751"><a href="#Planner-751"><span class="linenos">751</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="Planner-752"><a href="#Planner-752"><span class="linenos">752</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="Planner-753"><a href="#Planner-753"><span class="linenos">753</span></a>                    <span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="Planner-754"><a href="#Planner-754"><span class="linenos">754</span></a>                <span class="p">)</span>
</span><span id="Planner-755"><a href="#Planner-755"><span class="linenos">755</span></a>                <span class="k">return</span> <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span>
</span><span id="Planner-756"><a href="#Planner-756"><span class="linenos">756</span></a>
</span><span id="Planner-757"><a href="#Planner-757"><span class="linenos">757</span></a>            <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">rot2so3</span><span class="p">(</span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="Planner-758"><a href="#Planner-758"><span class="linenos">758</span></a>            <span class="k">if</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e5</span><span class="p">:</span>
</span><span id="Planner-759"><a href="#Planner-759"><span class="linenos">759</span></a>                <span class="k">return</span> <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span>
</span><span id="Planner-760"><a href="#Planner-760"><span class="linenos">760</span></a>            <span class="n">ss</span> <span class="o">=</span> <span class="n">skew</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
</span><span id="Planner-761"><a href="#Planner-761"><span class="linenos">761</span></a>            <span class="n">inv_left_jacobian</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner-762"><a href="#Planner-762"><span class="linenos">762</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">theta</span>
</span><span id="Planner-763"><a href="#Planner-763"><span class="linenos">763</span></a>                <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ss</span>
</span><span id="Planner-764"><a href="#Planner-764"><span class="linenos">764</span></a>                <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">theta</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">ss</span> <span class="o">@</span> <span class="n">ss</span>
</span><span id="Planner-765"><a href="#Planner-765"><span class="linenos">765</span></a>            <span class="p">)</span>
</span><span id="Planner-766"><a href="#Planner-766"><span class="linenos">766</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">inv_left_jacobian</span> <span class="o">@</span> <span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Planner-767"><a href="#Planner-767"><span class="linenos">767</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">v</span><span class="p">,</span> <span class="n">omega</span><span class="p">]),</span> <span class="n">theta</span>
</span><span id="Planner-768"><a href="#Planner-768"><span class="linenos">768</span></a>
</span><span id="Planner-769"><a href="#Planner-769"><span class="linenos">769</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_forward_kinematics</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="Planner-770"><a href="#Planner-770"><span class="linenos">770</span></a>        <span class="n">ee_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="Planner-771"><a href="#Planner-771"><span class="linenos">771</span></a>        <span class="n">current_p</span> <span class="o">=</span> <span class="n">pose7D2mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_pose</span><span class="p">(</span><span class="n">ee_index</span><span class="p">))</span>
</span><span id="Planner-772"><a href="#Planner-772"><span class="linenos">772</span></a>        <span class="n">target_p</span> <span class="o">=</span> <span class="n">pose7D2mat</span><span class="p">(</span><span class="n">target_pose</span><span class="p">)</span>
</span><span id="Planner-773"><a href="#Planner-773"><span class="linenos">773</span></a>        <span class="n">relative_transform</span> <span class="o">=</span> <span class="n">target_p</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">current_p</span><span class="p">)</span>
</span><span id="Planner-774"><a href="#Planner-774"><span class="linenos">774</span></a>
</span><span id="Planner-775"><a href="#Planner-775"><span class="linenos">775</span></a>        <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">pose2exp_coordinate</span><span class="p">(</span><span class="n">relative_transform</span><span class="p">)</span>
</span><span id="Planner-776"><a href="#Planner-776"><span class="linenos">776</span></a>
</span><span id="Planner-777"><a href="#Planner-777"><span class="linenos">777</span></a>        <span class="k">if</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e4</span><span class="p">:</span>
</span><span id="Planner-778"><a href="#Planner-778"><span class="linenos">778</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;screw plan failed.&quot;</span><span class="p">}</span>
</span><span id="Planner-779"><a href="#Planner-779"><span class="linenos">779</span></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">theta</span>
</span><span id="Planner-780"><a href="#Planner-780"><span class="linenos">780</span></a>
</span><span id="Planner-781"><a href="#Planner-781"><span class="linenos">781</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner-782"><a href="#Planner-782"><span class="linenos">782</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">])]</span>
</span><span id="Planner-783"><a href="#Planner-783"><span class="linenos">783</span></a>
</span><span id="Planner-784"><a href="#Planner-784"><span class="linenos">784</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Planner-785"><a href="#Planner-785"><span class="linenos">785</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_full_jacobian</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="Planner-786"><a href="#Planner-786"><span class="linenos">786</span></a>            <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_jacobian</span><span class="p">(</span><span class="n">ee_index</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Planner-787"><a href="#Planner-787"><span class="linenos">787</span></a>            <span class="n">delta_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">@</span> <span class="n">omega</span>
</span><span id="Planner-788"><a href="#Planner-788"><span class="linenos">788</span></a>            <span class="n">delta_q</span> <span class="o">*=</span> <span class="n">qpos_step</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_q</span><span class="p">))</span>
</span><span id="Planner-789"><a href="#Planner-789"><span class="linenos">789</span></a>            <span class="n">delta_twist</span> <span class="o">=</span> <span class="n">J</span> <span class="o">@</span> <span class="n">delta_q</span>
</span><span id="Planner-790"><a href="#Planner-790"><span class="linenos">790</span></a>
</span><span id="Planner-791"><a href="#Planner-791"><span class="linenos">791</span></a>            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner-792"><a href="#Planner-792"><span class="linenos">792</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">omega</span><span class="p">):</span>
</span><span id="Planner-793"><a href="#Planner-793"><span class="linenos">793</span></a>                <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span>
</span><span id="Planner-794"><a href="#Planner-794"><span class="linenos">794</span></a>                <span class="n">delta_q</span> <span class="o">=</span> <span class="n">delta_q</span> <span class="o">*</span> <span class="n">ratio</span>
</span><span id="Planner-795"><a href="#Planner-795"><span class="linenos">795</span></a>                <span class="n">delta_twist</span> <span class="o">=</span> <span class="n">delta_twist</span> <span class="o">*</span> <span class="n">ratio</span>
</span><span id="Planner-796"><a href="#Planner-796"><span class="linenos">796</span></a>                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Planner-797"><a href="#Planner-797"><span class="linenos">797</span></a>
</span><span id="Planner-798"><a href="#Planner-798"><span class="linenos">798</span></a>            <span class="n">qpos</span> <span class="o">+=</span> <span class="n">delta_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Planner-799"><a href="#Planner-799"><span class="linenos">799</span></a>            <span class="n">omega</span> <span class="o">-=</span> <span class="n">delta_twist</span>
</span><span id="Planner-800"><a href="#Planner-800"><span class="linenos">800</span></a>
</span><span id="Planner-801"><a href="#Planner-801"><span class="linenos">801</span></a>            <span class="k">def</span> <span class="nf">check_joint_limit</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
</span><span id="Planner-802"><a href="#Planner-802"><span class="linenos">802</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span id="Planner-803"><a href="#Planner-803"><span class="linenos">803</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner-804"><a href="#Planner-804"><span class="linenos">804</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="Planner-805"><a href="#Planner-805"><span class="linenos">805</span></a>                        <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner-806"><a href="#Planner-806"><span class="linenos">806</span></a>                        <span class="ow">or</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner-807"><a href="#Planner-807"><span class="linenos">807</span></a>                    <span class="p">):</span>
</span><span id="Planner-808"><a href="#Planner-808"><span class="linenos">808</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Planner-809"><a href="#Planner-809"><span class="linenos">809</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Planner-810"><a href="#Planner-810"><span class="linenos">810</span></a>
</span><span id="Planner-811"><a href="#Planner-811"><span class="linenos">811</span></a>            <span class="n">within_joint_limit</span> <span class="o">=</span> <span class="n">check_joint_limit</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="Planner-812"><a href="#Planner-812"><span class="linenos">812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_qpos_all</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="Planner-813"><a href="#Planner-813"><span class="linenos">813</span></a>            <span class="n">collide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide</span><span class="p">()</span>
</span><span id="Planner-814"><a href="#Planner-814"><span class="linenos">814</span></a>
</span><span id="Planner-815"><a href="#Planner-815"><span class="linenos">815</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Planner-816"><a href="#Planner-816"><span class="linenos">816</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span>
</span><span id="Planner-817"><a href="#Planner-817"><span class="linenos">817</span></a>                <span class="ow">or</span> <span class="n">collide</span>
</span><span id="Planner-818"><a href="#Planner-818"><span class="linenos">818</span></a>                <span class="ow">or</span> <span class="n">within_joint_limit</span> <span class="o">==</span> <span class="kc">False</span>
</span><span id="Planner-819"><a href="#Planner-819"><span class="linenos">819</span></a>            <span class="p">):</span>
</span><span id="Planner-820"><a href="#Planner-820"><span class="linenos">820</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;screw plan failed&quot;</span><span class="p">}</span>
</span><span id="Planner-821"><a href="#Planner-821"><span class="linenos">821</span></a>
</span><span id="Planner-822"><a href="#Planner-822"><span class="linenos">822</span></a>            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</span><span id="Planner-823"><a href="#Planner-823"><span class="linenos">823</span></a>
</span><span id="Planner-824"><a href="#Planner-824"><span class="linenos">824</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="Planner-825"><a href="#Planner-825"><span class="linenos">825</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner-826"><a href="#Planner-826"><span class="linenos">826</span></a>                    <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
</span><span id="Planner-827"><a href="#Planner-827"><span class="linenos">827</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Planner-828"><a href="#Planner-828"><span class="linenos">828</span></a>                    <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</span><span id="Planner-829"><a href="#Planner-829"><span class="linenos">829</span></a>                <span class="n">times</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOPP</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">time_step</span><span class="p">)</span>
</span><span id="Planner-830"><a href="#Planner-830"><span class="linenos">830</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="Planner-831"><a href="#Planner-831"><span class="linenos">831</span></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span id="Planner-832"><a href="#Planner-832"><span class="linenos">832</span></a>                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
</span><span id="Planner-833"><a href="#Planner-833"><span class="linenos">833</span></a>                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="Planner-834"><a href="#Planner-834"><span class="linenos">834</span></a>                    <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span>
</span><span id="Planner-835"><a href="#Planner-835"><span class="linenos">835</span></a>                    <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span>
</span><span id="Planner-836"><a href="#Planner-836"><span class="linenos">836</span></a>                    <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="Planner-837"><a href="#Planner-837"><span class="linenos">837</span></a>                <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Motion planner.</p>
</div>


                            <div id="Planner.__init__" class="classattr">
                                        <input id="Planner.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Planner</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">urdf</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">move_group</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">srdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">package_keyword_replacement</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">user_link_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">user_joint_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">joint_vel_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="n">joint_acc_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Planner.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.__init__-20"><a href="#Planner.__init__-20"><span class="linenos"> 20</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Planner.__init__-21"><a href="#Planner.__init__-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner.__init__-22"><a href="#Planner.__init__-22"><span class="linenos"> 22</span></a>        <span class="n">urdf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Planner.__init__-23"><a href="#Planner.__init__-23"><span class="linenos"> 23</span></a>        <span class="n">move_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Planner.__init__-24"><a href="#Planner.__init__-24"><span class="linenos"> 24</span></a>        <span class="n">srdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Planner.__init__-25"><a href="#Planner.__init__-25"><span class="linenos"> 25</span></a>        <span class="n">package_keyword_replacement</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Planner.__init__-26"><a href="#Planner.__init__-26"><span class="linenos"> 26</span></a>        <span class="n">user_link_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner.__init__-27"><a href="#Planner.__init__-27"><span class="linenos"> 27</span></a>        <span class="n">user_joint_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner.__init__-28"><a href="#Planner.__init__-28"><span class="linenos"> 28</span></a>        <span class="n">joint_vel_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner.__init__-29"><a href="#Planner.__init__-29"><span class="linenos"> 29</span></a>        <span class="n">joint_acc_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="Planner.__init__-30"><a href="#Planner.__init__-30"><span class="linenos"> 30</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Planner.__init__-31"><a href="#Planner.__init__-31"><span class="linenos"> 31</span></a>    <span class="p">):</span>
</span><span id="Planner.__init__-32"><a href="#Planner.__init__-32"><span class="linenos"> 32</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Motion planner for robots.</span>
</span><span id="Planner.__init__-33"><a href="#Planner.__init__-33"><span class="linenos"> 33</span></a>
</span><span id="Planner.__init__-34"><a href="#Planner.__init__-34"><span class="linenos"> 34</span></a><span class="sd">        Args:</span>
</span><span id="Planner.__init__-35"><a href="#Planner.__init__-35"><span class="linenos"> 35</span></a><span class="sd">            urdf: Unified Robot Description Format file.</span>
</span><span id="Planner.__init__-36"><a href="#Planner.__init__-36"><span class="linenos"> 36</span></a><span class="sd">            user_link_names: names of links, the order. if empty, all links will be used.</span>
</span><span id="Planner.__init__-37"><a href="#Planner.__init__-37"><span class="linenos"> 37</span></a><span class="sd">            user_joint_names: names of the joints to plan.  if empty, all active joints will be used.</span>
</span><span id="Planner.__init__-38"><a href="#Planner.__init__-38"><span class="linenos"> 38</span></a><span class="sd">            move_group: target link to move, usually the end-effector.</span>
</span><span id="Planner.__init__-39"><a href="#Planner.__init__-39"><span class="linenos"> 39</span></a><span class="sd">            joint_vel_limits: maximum joint velocities for time parameterization,</span>
</span><span id="Planner.__init__-40"><a href="#Planner.__init__-40"><span class="linenos"> 40</span></a><span class="sd">                which should have the same length as</span>
</span><span id="Planner.__init__-41"><a href="#Planner.__init__-41"><span class="linenos"> 41</span></a><span class="sd">            joint_acc_limits: maximum joint accelerations for time parameterization,</span>
</span><span id="Planner.__init__-42"><a href="#Planner.__init__-42"><span class="linenos"> 42</span></a><span class="sd">                which should have the same length as</span>
</span><span id="Planner.__init__-43"><a href="#Planner.__init__-43"><span class="linenos"> 43</span></a><span class="sd">            srdf: Semantic Robot Description Format file.</span>
</span><span id="Planner.__init__-44"><a href="#Planner.__init__-44"><span class="linenos"> 44</span></a><span class="sd">        References:</span>
</span><span id="Planner.__init__-45"><a href="#Planner.__init__-45"><span class="linenos"> 45</span></a><span class="sd">            http://docs.ros.org/en/kinetic/api/moveit_tutorials/html/doc/urdf_srdf/urdf_srdf_tutorial.html</span>
</span><span id="Planner.__init__-46"><a href="#Planner.__init__-46"><span class="linenos"> 46</span></a>
</span><span id="Planner.__init__-47"><a href="#Planner.__init__-47"><span class="linenos"> 47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.__init__-48"><a href="#Planner.__init__-48"><span class="linenos"> 48</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span> <span class="o">=</span> <span class="n">urdf</span>
</span><span id="Planner.__init__-49"><a href="#Planner.__init__-49"><span class="linenos"> 49</span></a>        <span class="k">if</span> <span class="n">srdf</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)):</span>
</span><span id="Planner.__init__-50"><a href="#Planner.__init__-50"><span class="linenos"> 50</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span> <span class="o">=</span> <span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)</span>
</span><span id="Planner.__init__-51"><a href="#Planner.__init__-51"><span class="linenos"> 51</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No SRDF file provided but found </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Planner.__init__-52"><a href="#Planner.__init__-52"><span class="linenos"> 52</span></a>
</span><span id="Planner.__init__-53"><a href="#Planner.__init__-53"><span class="linenos"> 53</span></a>        <span class="c1"># replace package:// keyword if exists</span>
</span><span id="Planner.__init__-54"><a href="#Planner.__init__-54"><span class="linenos"> 54</span></a>        <span class="n">urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_package_keyword</span><span class="p">(</span><span class="n">package_keyword_replacement</span><span class="p">)</span>
</span><span id="Planner.__init__-55"><a href="#Planner.__init__-55"><span class="linenos"> 55</span></a>
</span><span id="Planner.__init__-56"><a href="#Planner.__init__-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span><span class="p">(</span>
</span><span id="Planner.__init__-57"><a href="#Planner.__init__-57"><span class="linenos"> 57</span></a>            <span class="n">urdf</span><span class="p">,</span>
</span><span id="Planner.__init__-58"><a href="#Planner.__init__-58"><span class="linenos"> 58</span></a>            <span class="n">srdf</span><span class="p">,</span>
</span><span id="Planner.__init__-59"><a href="#Planner.__init__-59"><span class="linenos"> 59</span></a>            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">],</span>
</span><span id="Planner.__init__-60"><a href="#Planner.__init__-60"><span class="linenos"> 60</span></a>            <span class="n">user_joint_names</span><span class="p">,</span>
</span><span id="Planner.__init__-61"><a href="#Planner.__init__-61"><span class="linenos"> 61</span></a>            <span class="n">user_link_names</span><span class="p">,</span>
</span><span id="Planner.__init__-62"><a href="#Planner.__init__-62"><span class="linenos"> 62</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.__init__-63"><a href="#Planner.__init__-63"><span class="linenos"> 63</span></a>            <span class="n">convex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Planner.__init__-64"><a href="#Planner.__init__-64"><span class="linenos"> 64</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-65"><a href="#Planner.__init__-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_pinocchio_model</span><span class="p">()</span>
</span><span id="Planner.__init__-66"><a href="#Planner.__init__-66"><span class="linenos"> 66</span></a>
</span><span id="Planner.__init__-67"><a href="#Planner.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span> <span class="o">=</span> <span class="n">planning_world</span><span class="o">.</span><span class="n">PlanningWorld</span><span class="p">(</span>
</span><span id="Planner.__init__-68"><a href="#Planner.__init__-68"><span class="linenos"> 68</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">],</span>
</span><span id="Planner.__init__-69"><a href="#Planner.__init__-69"><span class="linenos"> 69</span></a>            <span class="p">[</span><span class="s2">&quot;robot&quot;</span><span class="p">],</span>
</span><span id="Planner.__init__-70"><a href="#Planner.__init__-70"><span class="linenos"> 70</span></a>            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normal_objects&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Planner.__init__-71"><a href="#Planner.__init__-71"><span class="linenos"> 71</span></a>            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;normal_object_names&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Planner.__init__-72"><a href="#Planner.__init__-72"><span class="linenos"> 72</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-73"><a href="#Planner.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="Planner.__init__-74"><a href="#Planner.__init__-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="n">srdf</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="Planner.__init__-75"><a href="#Planner.__init__-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">generate_collision_pair</span><span class="p">()</span>
</span><span id="Planner.__init__-76"><a href="#Planner.__init__-76"><span class="linenos"> 76</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">update_SRDF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">)</span>
</span><span id="Planner.__init__-77"><a href="#Planner.__init__-77"><span class="linenos"> 77</span></a>
</span><span id="Planner.__init__-78"><a href="#Planner.__init__-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_pinocchio_model</span><span class="p">()</span>
</span><span id="Planner.__init__-79"><a href="#Planner.__init__-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_names</span><span class="p">()</span>
</span><span id="Planner.__init__-80"><a href="#Planner.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_joint_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_names</span><span class="p">()</span>
</span><span id="Planner.__init__-81"><a href="#Planner.__init__-81"><span class="linenos"> 81</span></a>
</span><span id="Planner.__init__-82"><a href="#Planner.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_name_2_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Planner.__init__-83"><a href="#Planner.__init__-83"><span class="linenos"> 83</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">joint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_joint_names</span><span class="p">):</span>
</span><span id="Planner.__init__-84"><a href="#Planner.__init__-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">joint_name_2_idx</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="Planner.__init__-85"><a href="#Planner.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Planner.__init__-86"><a href="#Planner.__init__-86"><span class="linenos"> 86</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">):</span>
</span><span id="Planner.__init__-87"><a href="#Planner.__init__-87"><span class="linenos"> 87</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="Planner.__init__-88"><a href="#Planner.__init__-88"><span class="linenos"> 88</span></a>
</span><span id="Planner.__init__-89"><a href="#Planner.__init__-89"><span class="linenos"> 89</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="Planner.__init__-90"><a href="#Planner.__init__-90"><span class="linenos"> 90</span></a>            <span class="n">move_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span>
</span><span id="Planner.__init__-91"><a href="#Planner.__init__-91"><span class="linenos"> 91</span></a>        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;end-effector not found as one of the links in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Planner.__init__-92"><a href="#Planner.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group</span> <span class="o">=</span> <span class="n">move_group</span>
</span><span id="Planner.__init__-93"><a href="#Planner.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_move_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">)</span>
</span><span id="Planner.__init__-94"><a href="#Planner.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_move_group_joint_indices</span><span class="p">()</span>
</span><span id="Planner.__init__-95"><a href="#Planner.__init__-95"><span class="linenos"> 95</span></a>
</span><span id="Planner.__init__-96"><a href="#Planner.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_types</span><span class="p">()</span>
</span><span id="Planner.__init__-97"><a href="#Planner.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_joint_limits</span><span class="p">())</span>
</span><span id="Planner.__init__-98"><a href="#Planner.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner.__init__-99"><a href="#Planner.__init__-99"><span class="linenos"> 99</span></a>            <span class="n">joint_vel_limits</span>
</span><span id="Planner.__init__-100"><a href="#Planner.__init__-100"><span class="linenos">100</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="Planner.__init__-101"><a href="#Planner.__init__-101"><span class="linenos">101</span></a>            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">))</span>
</span><span id="Planner.__init__-102"><a href="#Planner.__init__-102"><span class="linenos">102</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-103"><a href="#Planner.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner.__init__-104"><a href="#Planner.__init__-104"><span class="linenos">104</span></a>            <span class="n">joint_acc_limits</span>
</span><span id="Planner.__init__-105"><a href="#Planner.__init__-105"><span class="linenos">105</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="Planner.__init__-106"><a href="#Planner.__init__-106"><span class="linenos">106</span></a>            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">))</span>
</span><span id="Planner.__init__-107"><a href="#Planner.__init__-107"><span class="linenos">107</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-108"><a href="#Planner.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="Planner.__init__-109"><a href="#Planner.__init__-109"><span class="linenos">109</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner.__init__-110"><a href="#Planner.__init__-110"><span class="linenos">110</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="Planner.__init__-111"><a href="#Planner.__init__-111"><span class="linenos">111</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_acc_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner.__init__-112"><a href="#Planner.__init__-112"><span class="linenos">112</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-113"><a href="#Planner.__init__-113"><span class="linenos">113</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner.__init__-114"><a href="#Planner.__init__-114"><span class="linenos">114</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="Planner.__init__-115"><a href="#Planner.__init__-115"><span class="linenos">115</span></a>            <span class="sa">f</span><span class="s2">&quot;length of move_group (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner.__init__-116"><a href="#Planner.__init__-116"><span class="linenos">116</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-117"><a href="#Planner.__init__-117"><span class="linenos">117</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner.__init__-118"><a href="#Planner.__init__-118"><span class="linenos">118</span></a>            <span class="sa">f</span><span class="s2">&quot;length of joint_vel_limits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">) &gt; &quot;</span>
</span><span id="Planner.__init__-119"><a href="#Planner.__init__-119"><span class="linenos">119</span></a>            <span class="sa">f</span><span class="s2">&quot;number of total joints (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner.__init__-120"><a href="#Planner.__init__-120"><span class="linenos">120</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-121"><a href="#Planner.__init__-121"><span class="linenos">121</span></a>
</span><span id="Planner.__init__-122"><a href="#Planner.__init__-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span> <span class="o">=</span> <span class="n">planning_world</span><span class="o">.</span><span class="n">PlanningWorld</span><span class="p">(</span>
</span><span id="Planner.__init__-123"><a href="#Planner.__init__-123"><span class="linenos">123</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;robot&quot;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Planner.__init__-124"><a href="#Planner.__init__-124"><span class="linenos">124</span></a>        <span class="p">)</span>
</span><span id="Planner.__init__-125"><a href="#Planner.__init__-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planner</span> <span class="o">=</span> <span class="n">ompl</span><span class="o">.</span><span class="n">OMPLPlanner</span><span class="p">(</span><span class="n">world</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Motion planner for robots.</p>

<pre><code>    Args:
        urdf: Unified Robot Description Format file.
        user_link_names: names of links, the order. if empty, all links will be used.
        user_joint_names: names of the joints to plan.  if empty, all active joints will be used.
        move_group: target link to move, usually the end-effector.
        joint_vel_limits: maximum joint velocities for time parameterization,
            which should have the same length as
        joint_acc_limits: maximum joint accelerations for time parameterization,
            which should have the same length as
        srdf: Semantic Robot Description Format file.
    References:
        http://docs.ros.org/en/kinetic/api/moveit_tutorials/html/doc/urdf_srdf/urdf_srdf_tutorial.html
</code></pre>
</div>


                            </div>
                            <div id="Planner.urdf" class="classattr">
                                <div class="attr variable">
            <span class="name">urdf</span>

        
    </div>
    <a class="headerlink" href="#Planner.urdf"></a>
    
    

                            </div>
                            <div id="Planner.robot" class="classattr">
                                <div class="attr variable">
            <span class="name">robot</span>

        
    </div>
    <a class="headerlink" href="#Planner.robot"></a>
    
    

                            </div>
                            <div id="Planner.pinocchio_model" class="classattr">
                                <div class="attr variable">
            <span class="name">pinocchio_model</span>

        
    </div>
    <a class="headerlink" href="#Planner.pinocchio_model"></a>
    
    

                            </div>
                            <div id="Planner.planning_world" class="classattr">
                                <div class="attr variable">
            <span class="name">planning_world</span>

        
    </div>
    <a class="headerlink" href="#Planner.planning_world"></a>
    
    

                            </div>
                            <div id="Planner.user_link_names" class="classattr">
                                <div class="attr variable">
            <span class="name">user_link_names</span>

        
    </div>
    <a class="headerlink" href="#Planner.user_link_names"></a>
    
    

                            </div>
                            <div id="Planner.user_joint_names" class="classattr">
                                <div class="attr variable">
            <span class="name">user_joint_names</span>

        
    </div>
    <a class="headerlink" href="#Planner.user_joint_names"></a>
    
    

                            </div>
                            <div id="Planner.joint_name_2_idx" class="classattr">
                                <div class="attr variable">
            <span class="name">joint_name_2_idx</span>

        
    </div>
    <a class="headerlink" href="#Planner.joint_name_2_idx"></a>
    
    

                            </div>
                            <div id="Planner.link_name_2_idx" class="classattr">
                                <div class="attr variable">
            <span class="name">link_name_2_idx</span>

        
    </div>
    <a class="headerlink" href="#Planner.link_name_2_idx"></a>
    
    

                            </div>
                            <div id="Planner.move_group" class="classattr">
                                <div class="attr variable">
            <span class="name">move_group</span>

        
    </div>
    <a class="headerlink" href="#Planner.move_group"></a>
    
    

                            </div>
                            <div id="Planner.move_group_joint_indices" class="classattr">
                                <div class="attr variable">
            <span class="name">move_group_joint_indices</span>

        
    </div>
    <a class="headerlink" href="#Planner.move_group_joint_indices"></a>
    
    

                            </div>
                            <div id="Planner.joint_types" class="classattr">
                                <div class="attr variable">
            <span class="name">joint_types</span>

        
    </div>
    <a class="headerlink" href="#Planner.joint_types"></a>
    
    

                            </div>
                            <div id="Planner.joint_limits" class="classattr">
                                <div class="attr variable">
            <span class="name">joint_limits</span>

        
    </div>
    <a class="headerlink" href="#Planner.joint_limits"></a>
    
    

                            </div>
                            <div id="Planner.joint_vel_limits" class="classattr">
                                <div class="attr variable">
            <span class="name">joint_vel_limits</span>

        
    </div>
    <a class="headerlink" href="#Planner.joint_vel_limits"></a>
    
    

                            </div>
                            <div id="Planner.joint_acc_limits" class="classattr">
                                <div class="attr variable">
            <span class="name">joint_acc_limits</span>

        
    </div>
    <a class="headerlink" href="#Planner.joint_acc_limits"></a>
    
    

                            </div>
                            <div id="Planner.move_group_link_id" class="classattr">
                                <div class="attr variable">
            <span class="name">move_group_link_id</span>

        
    </div>
    <a class="headerlink" href="#Planner.move_group_link_id"></a>
    
    

                            </div>
                            <div id="Planner.planner" class="classattr">
                                <div class="attr variable">
            <span class="name">planner</span>

        
    </div>
    <a class="headerlink" href="#Planner.planner"></a>
    
    

                            </div>
                            <div id="Planner.replace_package_keyword" class="classattr">
                                        <input id="Planner.replace_package_keyword-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">replace_package_keyword</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">package_keyword_replacement</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.replace_package_keyword-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.replace_package_keyword"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.replace_package_keyword-127"><a href="#Planner.replace_package_keyword-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">replace_package_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_keyword_replacement</span><span class="p">):</span>
</span><span id="Planner.replace_package_keyword-128"><a href="#Planner.replace_package_keyword-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.replace_package_keyword-129"><a href="#Planner.replace_package_keyword-129"><span class="linenos">129</span></a><span class="sd">        some ROS URDF files use package:// keyword to refer the package dir</span>
</span><span id="Planner.replace_package_keyword-130"><a href="#Planner.replace_package_keyword-130"><span class="linenos">130</span></a><span class="sd">        replace it with the given string (default is empty)</span>
</span><span id="Planner.replace_package_keyword-131"><a href="#Planner.replace_package_keyword-131"><span class="linenos">131</span></a>
</span><span id="Planner.replace_package_keyword-132"><a href="#Planner.replace_package_keyword-132"><span class="linenos">132</span></a><span class="sd">        Args:</span>
</span><span id="Planner.replace_package_keyword-133"><a href="#Planner.replace_package_keyword-133"><span class="linenos">133</span></a><span class="sd">            package_keyword_replacement: the string to replace &#39;package://&#39; keyword</span>
</span><span id="Planner.replace_package_keyword-134"><a href="#Planner.replace_package_keyword-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.replace_package_keyword-135"><a href="#Planner.replace_package_keyword-135"><span class="linenos">135</span></a>        <span class="n">rtn_urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span>
</span><span id="Planner.replace_package_keyword-136"><a href="#Planner.replace_package_keyword-136"><span class="linenos">136</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_f</span><span class="p">:</span>
</span><span id="Planner.replace_package_keyword-137"><a href="#Planner.replace_package_keyword-137"><span class="linenos">137</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">in_f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Planner.replace_package_keyword-138"><a href="#Planner.replace_package_keyword-138"><span class="linenos">138</span></a>            <span class="k">if</span> <span class="s2">&quot;package://&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
</span><span id="Planner.replace_package_keyword-139"><a href="#Planner.replace_package_keyword-139"><span class="linenos">139</span></a>                <span class="n">rtn_urdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;_package_keyword_replaced.urdf&quot;</span><span class="p">)</span>
</span><span id="Planner.replace_package_keyword-140"><a href="#Planner.replace_package_keyword-140"><span class="linenos">140</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;package://&quot;</span><span class="p">,</span> <span class="n">package_keyword_replacement</span><span class="p">)</span>
</span><span id="Planner.replace_package_keyword-141"><a href="#Planner.replace_package_keyword-141"><span class="linenos">141</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rtn_urdf</span><span class="p">):</span>
</span><span id="Planner.replace_package_keyword-142"><a href="#Planner.replace_package_keyword-142"><span class="linenos">142</span></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rtn_urdf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_f</span><span class="p">:</span>
</span><span id="Planner.replace_package_keyword-143"><a href="#Planner.replace_package_keyword-143"><span class="linenos">143</span></a>                        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="Planner.replace_package_keyword-144"><a href="#Planner.replace_package_keyword-144"><span class="linenos">144</span></a>        <span class="k">return</span> <span class="n">rtn_urdf</span>
</span></pre></div>


            <div class="docstring"><p>some ROS URDF files use package:// keyword to refer the package dir
replace it with the given string (default is empty)</p>

<p>Args:
    package_keyword_replacement: the string to replace 'package://' keyword</p>
</div>


                            </div>
                            <div id="Planner.generate_collision_pair" class="classattr">
                                        <input id="Planner.generate_collision_pair-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_collision_pair</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">sample_time</span><span class="o">=</span><span class="mi">1000000</span>, </span><span class="param"><span class="n">echo_freq</span><span class="o">=</span><span class="mi">100000</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.generate_collision_pair-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.generate_collision_pair"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.generate_collision_pair-146"><a href="#Planner.generate_collision_pair-146"><span class="linenos">146</span></a>    <span class="k">def</span> <span class="nf">generate_collision_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">echo_freq</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
</span><span id="Planner.generate_collision_pair-147"><a href="#Planner.generate_collision_pair-147"><span class="linenos">147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.generate_collision_pair-148"><a href="#Planner.generate_collision_pair-148"><span class="linenos">148</span></a><span class="sd">        we read the srdf file to get the link pairs that should not collide.</span>
</span><span id="Planner.generate_collision_pair-149"><a href="#Planner.generate_collision_pair-149"><span class="linenos">149</span></a><span class="sd">        if not provided, we need to randomly sample configurations to find the link pairs that will always collide.</span>
</span><span id="Planner.generate_collision_pair-150"><a href="#Planner.generate_collision_pair-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.generate_collision_pair-151"><a href="#Planner.generate_collision_pair-151"><span class="linenos">151</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="Planner.generate_collision_pair-152"><a href="#Planner.generate_collision_pair-152"><span class="linenos">152</span></a>            <span class="s2">&quot;Since no SRDF file is provided. We will first detect link pairs that will&quot;</span>
</span><span id="Planner.generate_collision_pair-153"><a href="#Planner.generate_collision_pair-153"><span class="linenos">153</span></a>            <span class="s2">&quot; always collide. This may take several minutes.&quot;</span>
</span><span id="Planner.generate_collision_pair-154"><a href="#Planner.generate_collision_pair-154"><span class="linenos">154</span></a>        <span class="p">)</span>
</span><span id="Planner.generate_collision_pair-155"><a href="#Planner.generate_collision_pair-155"><span class="linenos">155</span></a>        <span class="n">n_link</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-156"><a href="#Planner.generate_collision_pair-156"><span class="linenos">156</span></a>        <span class="n">cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_link</span><span class="p">,</span> <span class="n">n_link</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-157"><a href="#Planner.generate_collision_pair-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_time</span><span class="p">):</span>
</span><span id="Planner.generate_collision_pair-158"><a href="#Planner.generate_collision_pair-158"><span class="linenos">158</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_random_configuration</span><span class="p">()</span>
</span><span id="Planner.generate_collision_pair-159"><a href="#Planner.generate_collision_pair-159"><span class="linenos">159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-160"><a href="#Planner.generate_collision_pair-160"><span class="linenos">160</span></a>            <span class="n">collisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">()</span>
</span><span id="Planner.generate_collision_pair-161"><a href="#Planner.generate_collision_pair-161"><span class="linenos">161</span></a>            <span class="k">for</span> <span class="n">collision</span> <span class="ow">in</span> <span class="n">collisions</span><span class="p">:</span>
</span><span id="Planner.generate_collision_pair-162"><a href="#Planner.generate_collision_pair-162"><span class="linenos">162</span></a>                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name1</span><span class="p">]</span>
</span><span id="Planner.generate_collision_pair-163"><a href="#Planner.generate_collision_pair-163"><span class="linenos">163</span></a>                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name2</span><span class="p">]</span>
</span><span id="Planner.generate_collision_pair-164"><a href="#Planner.generate_collision_pair-164"><span class="linenos">164</span></a>                <span class="n">cnt</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Planner.generate_collision_pair-165"><a href="#Planner.generate_collision_pair-165"><span class="linenos">165</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">echo_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner.generate_collision_pair-166"><a href="#Planner.generate_collision_pair-166"><span class="linenos">166</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finish </span><span class="si">%.1f%%</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">sample_time</span><span class="p">))</span>
</span><span id="Planner.generate_collision_pair-167"><a href="#Planner.generate_collision_pair-167"><span class="linenos">167</span></a>
</span><span id="Planner.generate_collision_pair-168"><a href="#Planner.generate_collision_pair-168"><span class="linenos">168</span></a>        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
</span><span id="Planner.generate_collision_pair-169"><a href="#Planner.generate_collision_pair-169"><span class="linenos">169</span></a>        <span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>
</span><span id="Planner.generate_collision_pair-170"><a href="#Planner.generate_collision_pair-170"><span class="linenos">170</span></a>
</span><span id="Planner.generate_collision_pair-171"><a href="#Planner.generate_collision_pair-171"><span class="linenos">171</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;robot&quot;</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-172"><a href="#Planner.generate_collision_pair-172"><span class="linenos">172</span></a>        <span class="n">robot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner.generate_collision_pair-173"><a href="#Planner.generate_collision_pair-173"><span class="linenos">173</span></a>        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">robot_name</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-174"><a href="#Planner.generate_collision_pair-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urdf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;.srdf&quot;</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-175"><a href="#Planner.generate_collision_pair-175"><span class="linenos">175</span></a>
</span><span id="Planner.generate_collision_pair-176"><a href="#Planner.generate_collision_pair-176"><span class="linenos">176</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_link</span><span class="p">):</span>
</span><span id="Planner.generate_collision_pair-177"><a href="#Planner.generate_collision_pair-177"><span class="linenos">177</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_link</span><span class="p">):</span>
</span><span id="Planner.generate_collision_pair-178"><a href="#Planner.generate_collision_pair-178"><span class="linenos">178</span></a>                <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">sample_time</span><span class="p">:</span>
</span><span id="Planner.generate_collision_pair-179"><a href="#Planner.generate_collision_pair-179"><span class="linenos">179</span></a>                    <span class="n">link1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Planner.generate_collision_pair-180"><a href="#Planner.generate_collision_pair-180"><span class="linenos">180</span></a>                    <span class="n">link2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_link_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Planner.generate_collision_pair-181"><a href="#Planner.generate_collision_pair-181"><span class="linenos">181</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="Planner.generate_collision_pair-182"><a href="#Planner.generate_collision_pair-182"><span class="linenos">182</span></a>                        <span class="s2">&quot;Ignore collision pair: (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">), reason:  always collide&quot;</span>
</span><span id="Planner.generate_collision_pair-183"><a href="#Planner.generate_collision_pair-183"><span class="linenos">183</span></a>                        <span class="o">%</span> <span class="p">(</span><span class="n">link1</span><span class="p">,</span> <span class="n">link2</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-184"><a href="#Planner.generate_collision_pair-184"><span class="linenos">184</span></a>                    <span class="p">)</span>
</span><span id="Planner.generate_collision_pair-185"><a href="#Planner.generate_collision_pair-185"><span class="linenos">185</span></a>                    <span class="n">collision</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;disable_collisions&quot;</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-186"><a href="#Planner.generate_collision_pair-186"><span class="linenos">186</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;link1&quot;</span><span class="p">,</span> <span class="n">link1</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-187"><a href="#Planner.generate_collision_pair-187"><span class="linenos">187</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;link2&quot;</span><span class="p">,</span> <span class="n">link2</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-188"><a href="#Planner.generate_collision_pair-188"><span class="linenos">188</span></a>                    <span class="n">collision</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="s2">&quot;Default&quot;</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-189"><a href="#Planner.generate_collision_pair-189"><span class="linenos">189</span></a>        <span class="n">srdffile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-190"><a href="#Planner.generate_collision_pair-190"><span class="linenos">190</span></a>        <span class="n">srdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="Planner.generate_collision_pair-191"><a href="#Planner.generate_collision_pair-191"><span class="linenos">191</span></a>            <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">))</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">)</span>
</span><span id="Planner.generate_collision_pair-192"><a href="#Planner.generate_collision_pair-192"><span class="linenos">192</span></a>        <span class="p">)</span>
</span><span id="Planner.generate_collision_pair-193"><a href="#Planner.generate_collision_pair-193"><span class="linenos">193</span></a>        <span class="n">srdffile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Planner.generate_collision_pair-194"><a href="#Planner.generate_collision_pair-194"><span class="linenos">194</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving the SRDF file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">srdf</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>we read the srdf file to get the link pairs that should not collide.
if not provided, we need to randomly sample configurations to find the link pairs that will always collide.</p>
</div>


                            </div>
                            <div id="Planner.distance_6D" class="classattr">
                                        <input id="Planner.distance_6D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">distance_6D</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">p1</span>, </span><span class="param"><span class="n">q1</span>, </span><span class="param"><span class="n">p2</span>, </span><span class="param"><span class="n">q2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.distance_6D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.distance_6D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.distance_6D-196"><a href="#Planner.distance_6D-196"><span class="linenos">196</span></a>    <span class="k">def</span> <span class="nf">distance_6D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">q2</span><span class="p">):</span>
</span><span id="Planner.distance_6D-197"><a href="#Planner.distance_6D-197"><span class="linenos">197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.distance_6D-198"><a href="#Planner.distance_6D-198"><span class="linenos">198</span></a><span class="sd">        compute the distance between two poses</span>
</span><span id="Planner.distance_6D-199"><a href="#Planner.distance_6D-199"><span class="linenos">199</span></a>
</span><span id="Planner.distance_6D-200"><a href="#Planner.distance_6D-200"><span class="linenos">200</span></a><span class="sd">        Args:</span>
</span><span id="Planner.distance_6D-201"><a href="#Planner.distance_6D-201"><span class="linenos">201</span></a><span class="sd">            p1: position of pose 1</span>
</span><span id="Planner.distance_6D-202"><a href="#Planner.distance_6D-202"><span class="linenos">202</span></a><span class="sd">            q1: quaternion of pose 1</span>
</span><span id="Planner.distance_6D-203"><a href="#Planner.distance_6D-203"><span class="linenos">203</span></a><span class="sd">            p2: position of pose 2</span>
</span><span id="Planner.distance_6D-204"><a href="#Planner.distance_6D-204"><span class="linenos">204</span></a><span class="sd">            q2: quaternion of pose 2</span>
</span><span id="Planner.distance_6D-205"><a href="#Planner.distance_6D-205"><span class="linenos">205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.distance_6D-206"><a href="#Planner.distance_6D-206"><span class="linenos">206</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="Planner.distance_6D-207"><a href="#Planner.distance_6D-207"><span class="linenos">207</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q1</span> <span class="o">-</span> <span class="n">q2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q1</span> <span class="o">+</span> <span class="n">q2</span><span class="p">)</span>
</span><span id="Planner.distance_6D-208"><a href="#Planner.distance_6D-208"><span class="linenos">208</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>compute the distance between two poses</p>

<p>Args:
    p1: position of pose 1
    q1: quaternion of pose 1
    p2: position of pose 2
    q2: quaternion of pose 2</p>
</div>


                            </div>
                            <div id="Planner.check_joint_limit" class="classattr">
                                        <input id="Planner.check_joint_limit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_joint_limit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">q</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.check_joint_limit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.check_joint_limit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.check_joint_limit-210"><a href="#Planner.check_joint_limit-210"><span class="linenos">210</span></a>    <span class="k">def</span> <span class="nf">check_joint_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
</span><span id="Planner.check_joint_limit-211"><a href="#Planner.check_joint_limit-211"><span class="linenos">211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.check_joint_limit-212"><a href="#Planner.check_joint_limit-212"><span class="linenos">212</span></a><span class="sd">        check if the joint configuration is within the joint limits</span>
</span><span id="Planner.check_joint_limit-213"><a href="#Planner.check_joint_limit-213"><span class="linenos">213</span></a>
</span><span id="Planner.check_joint_limit-214"><a href="#Planner.check_joint_limit-214"><span class="linenos">214</span></a><span class="sd">        Args:</span>
</span><span id="Planner.check_joint_limit-215"><a href="#Planner.check_joint_limit-215"><span class="linenos">215</span></a><span class="sd">            q: joint configuration</span>
</span><span id="Planner.check_joint_limit-216"><a href="#Planner.check_joint_limit-216"><span class="linenos">216</span></a>
</span><span id="Planner.check_joint_limit-217"><a href="#Planner.check_joint_limit-217"><span class="linenos">217</span></a><span class="sd">        Returns:</span>
</span><span id="Planner.check_joint_limit-218"><a href="#Planner.check_joint_limit-218"><span class="linenos">218</span></a><span class="sd">            True if the joint configuration is within the joint limits</span>
</span><span id="Planner.check_joint_limit-219"><a href="#Planner.check_joint_limit-219"><span class="linenos">219</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.check_joint_limit-220"><a href="#Planner.check_joint_limit-220"><span class="linenos">220</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span id="Planner.check_joint_limit-221"><a href="#Planner.check_joint_limit-221"><span class="linenos">221</span></a>        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Planner.check_joint_limit-222"><a href="#Planner.check_joint_limit-222"><span class="linenos">222</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner.check_joint_limit-223"><a href="#Planner.check_joint_limit-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JointModelR&quot;</span><span class="p">):</span>
</span><span id="Planner.check_joint_limit-224"><a href="#Planner.check_joint_limit-224"><span class="linenos">224</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
</span><span id="Planner.check_joint_limit-225"><a href="#Planner.check_joint_limit-225"><span class="linenos">225</span></a>                    <span class="k">continue</span>
</span><span id="Planner.check_joint_limit-226"><a href="#Planner.check_joint_limit-226"><span class="linenos">226</span></a>                <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span>
</span><span id="Planner.check_joint_limit-227"><a href="#Planner.check_joint_limit-227"><span class="linenos">227</span></a>                    <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
</span><span id="Planner.check_joint_limit-228"><a href="#Planner.check_joint_limit-228"><span class="linenos">228</span></a>                <span class="p">)</span>
</span><span id="Planner.check_joint_limit-229"><a href="#Planner.check_joint_limit-229"><span class="linenos">229</span></a>                <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">:</span>
</span><span id="Planner.check_joint_limit-230"><a href="#Planner.check_joint_limit-230"><span class="linenos">230</span></a>                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner.check_joint_limit-231"><a href="#Planner.check_joint_limit-231"><span class="linenos">231</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Planner.check_joint_limit-232"><a href="#Planner.check_joint_limit-232"><span class="linenos">232</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="Planner.check_joint_limit-233"><a href="#Planner.check_joint_limit-233"><span class="linenos">233</span></a>                    <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner.check_joint_limit-234"><a href="#Planner.check_joint_limit-234"><span class="linenos">234</span></a>                    <span class="ow">or</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner.check_joint_limit-235"><a href="#Planner.check_joint_limit-235"><span class="linenos">235</span></a>                <span class="p">):</span>
</span><span id="Planner.check_joint_limit-236"><a href="#Planner.check_joint_limit-236"><span class="linenos">236</span></a>                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner.check_joint_limit-237"><a href="#Planner.check_joint_limit-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">flag</span>
</span></pre></div>


            <div class="docstring"><p>check if the joint configuration is within the joint limits</p>

<p>Args:
    q: joint configuration</p>

<p>Returns:
    True if the joint configuration is within the joint limits</p>
</div>


                            </div>
                            <div id="Planner.pad_qpos" class="classattr">
                                        <input id="Planner.pad_qpos-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pad_qpos</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">qpos</span>, </span><span class="param"><span class="n">articulation</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.pad_qpos-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.pad_qpos"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.pad_qpos-239"><a href="#Planner.pad_qpos-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">pad_qpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qpos</span><span class="p">,</span> <span class="n">articulation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Planner.pad_qpos-240"><a href="#Planner.pad_qpos-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.pad_qpos-241"><a href="#Planner.pad_qpos-241"><span class="linenos">241</span></a><span class="sd">        if the user does not provide the full qpos but only the move_group joints,</span>
</span><span id="Planner.pad_qpos-242"><a href="#Planner.pad_qpos-242"><span class="linenos">242</span></a><span class="sd">        pad the qpos with the rest of the joints</span>
</span><span id="Planner.pad_qpos-243"><a href="#Planner.pad_qpos-243"><span class="linenos">243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.pad_qpos-244"><a href="#Planner.pad_qpos-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span><span class="p">):</span>
</span><span id="Planner.pad_qpos-245"><a href="#Planner.pad_qpos-245"><span class="linenos">245</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner.pad_qpos-246"><a href="#Planner.pad_qpos-246"><span class="linenos">246</span></a>                <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner.pad_qpos-247"><a href="#Planner.pad_qpos-247"><span class="linenos">247</span></a>                <span class="k">if</span> <span class="n">articulation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="Planner.pad_qpos-248"><a href="#Planner.pad_qpos-248"><span class="linenos">248</span></a>                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner.pad_qpos-249"><a href="#Planner.pad_qpos-249"><span class="linenos">249</span></a>            <span class="p">)</span>
</span><span id="Planner.pad_qpos-250"><a href="#Planner.pad_qpos-250"><span class="linenos">250</span></a>            <span class="n">tmp</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">qpos</span>
</span><span id="Planner.pad_qpos-251"><a href="#Planner.pad_qpos-251"><span class="linenos">251</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="Planner.pad_qpos-252"><a href="#Planner.pad_qpos-252"><span class="linenos">252</span></a>
</span><span id="Planner.pad_qpos-253"><a href="#Planner.pad_qpos-253"><span class="linenos">253</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">),</span> <span class="p">(</span>
</span><span id="Planner.pad_qpos-254"><a href="#Planner.pad_qpos-254"><span class="linenos">254</span></a>            <span class="sa">f</span><span class="s2">&quot;length of qpos (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span><span class="si">}</span><span class="s2">) =/= &quot;</span>
</span><span id="Planner.pad_qpos-255"><a href="#Planner.pad_qpos-255"><span class="linenos">255</span></a>            <span class="sa">f</span><span class="s2">&quot;number of total joints (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Planner.pad_qpos-256"><a href="#Planner.pad_qpos-256"><span class="linenos">256</span></a>        <span class="p">)</span>
</span><span id="Planner.pad_qpos-257"><a href="#Planner.pad_qpos-257"><span class="linenos">257</span></a>
</span><span id="Planner.pad_qpos-258"><a href="#Planner.pad_qpos-258"><span class="linenos">258</span></a>        <span class="k">return</span> <span class="n">qpos</span>
</span></pre></div>


            <div class="docstring"><p>if the user does not provide the full qpos but only the move_group joints,
pad the qpos with the rest of the joints</p>
</div>


                            </div>
                            <div id="Planner.check_for_collision" class="classattr">
                                        <input id="Planner.check_for_collision-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_for_collision</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">collision_function</span>,</span><span class="param">	<span class="n">articulation</span><span class="p">:</span> <span class="n">mplib</span><span class="o">.</span><span class="n">pymp</span><span class="o">.</span><span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">qpos</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Planner.check_for_collision-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.check_for_collision"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.check_for_collision-260"><a href="#Planner.check_for_collision-260"><span class="linenos">260</span></a>    <span class="k">def</span> <span class="nf">check_for_collision</span><span class="p">(</span>
</span><span id="Planner.check_for_collision-261"><a href="#Planner.check_for_collision-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner.check_for_collision-262"><a href="#Planner.check_for_collision-262"><span class="linenos">262</span></a>        <span class="n">collision_function</span><span class="p">,</span>
</span><span id="Planner.check_for_collision-263"><a href="#Planner.check_for_collision-263"><span class="linenos">263</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.check_for_collision-264"><a href="#Planner.check_for_collision-264"><span class="linenos">264</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.check_for_collision-265"><a href="#Planner.check_for_collision-265"><span class="linenos">265</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Planner.check_for_collision-266"><a href="#Planner.check_for_collision-266"><span class="linenos">266</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to check for collision&quot;&quot;&quot;</span>
</span><span id="Planner.check_for_collision-267"><a href="#Planner.check_for_collision-267"><span class="linenos">267</span></a>        <span class="c1"># handle no user input</span>
</span><span id="Planner.check_for_collision-268"><a href="#Planner.check_for_collision-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">articulation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Planner.check_for_collision-269"><a href="#Planner.check_for_collision-269"><span class="linenos">269</span></a>            <span class="n">articulation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span>
</span><span id="Planner.check_for_collision-270"><a href="#Planner.check_for_collision-270"><span class="linenos">270</span></a>        <span class="k">if</span> <span class="n">qpos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Planner.check_for_collision-271"><a href="#Planner.check_for_collision-271"><span class="linenos">271</span></a>            <span class="n">qpos</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner.check_for_collision-272"><a href="#Planner.check_for_collision-272"><span class="linenos">272</span></a>        <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="n">articulation</span><span class="p">)</span>
</span><span id="Planner.check_for_collision-273"><a href="#Planner.check_for_collision-273"><span class="linenos">273</span></a>
</span><span id="Planner.check_for_collision-274"><a href="#Planner.check_for_collision-274"><span class="linenos">274</span></a>        <span class="c1"># first save the current qpos</span>
</span><span id="Planner.check_for_collision-275"><a href="#Planner.check_for_collision-275"><span class="linenos">275</span></a>        <span class="n">old_qpos</span> <span class="o">=</span> <span class="n">articulation</span><span class="o">.</span><span class="n">get_qpos</span><span class="p">()</span>
</span><span id="Planner.check_for_collision-276"><a href="#Planner.check_for_collision-276"><span class="linenos">276</span></a>        <span class="c1"># set robot to new qpos</span>
</span><span id="Planner.check_for_collision-277"><a href="#Planner.check_for_collision-277"><span class="linenos">277</span></a>        <span class="n">articulation</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner.check_for_collision-278"><a href="#Planner.check_for_collision-278"><span class="linenos">278</span></a>        <span class="c1"># find the index of the articulation inside the array</span>
</span><span id="Planner.check_for_collision-279"><a href="#Planner.check_for_collision-279"><span class="linenos">279</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">get_articulations</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">articulation</span><span class="p">)</span>
</span><span id="Planner.check_for_collision-280"><a href="#Planner.check_for_collision-280"><span class="linenos">280</span></a>        <span class="c1"># check for self-collision</span>
</span><span id="Planner.check_for_collision-281"><a href="#Planner.check_for_collision-281"><span class="linenos">281</span></a>        <span class="n">collisions</span> <span class="o">=</span> <span class="n">collision_function</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="Planner.check_for_collision-282"><a href="#Planner.check_for_collision-282"><span class="linenos">282</span></a>        <span class="c1"># reset qpos</span>
</span><span id="Planner.check_for_collision-283"><a href="#Planner.check_for_collision-283"><span class="linenos">283</span></a>        <span class="n">articulation</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">old_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner.check_for_collision-284"><a href="#Planner.check_for_collision-284"><span class="linenos">284</span></a>        <span class="k">return</span> <span class="n">collisions</span>
</span></pre></div>


            <div class="docstring"><p>helper function to check for collision</p>
</div>


                            </div>
                            <div id="Planner.check_for_self_collision" class="classattr">
                                        <input id="Planner.check_for_self_collision-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_for_self_collision</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">articulation</span><span class="p">:</span> <span class="n">mplib</span><span class="o">.</span><span class="n">pymp</span><span class="o">.</span><span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">qpos</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Planner.check_for_self_collision-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.check_for_self_collision"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.check_for_self_collision-286"><a href="#Planner.check_for_self_collision-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">check_for_self_collision</span><span class="p">(</span>
</span><span id="Planner.check_for_self_collision-287"><a href="#Planner.check_for_self_collision-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner.check_for_self_collision-288"><a href="#Planner.check_for_self_collision-288"><span class="linenos">288</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.check_for_self_collision-289"><a href="#Planner.check_for_self_collision-289"><span class="linenos">289</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.check_for_self_collision-290"><a href="#Planner.check_for_self_collision-290"><span class="linenos">290</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Planner.check_for_self_collision-291"><a href="#Planner.check_for_self_collision-291"><span class="linenos">291</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the robot is in self-collision.</span>
</span><span id="Planner.check_for_self_collision-292"><a href="#Planner.check_for_self_collision-292"><span class="linenos">292</span></a>
</span><span id="Planner.check_for_self_collision-293"><a href="#Planner.check_for_self_collision-293"><span class="linenos">293</span></a><span class="sd">        Args:</span>
</span><span id="Planner.check_for_self_collision-294"><a href="#Planner.check_for_self_collision-294"><span class="linenos">294</span></a><span class="sd">            articulation: robot model. if none will be self.robot</span>
</span><span id="Planner.check_for_self_collision-295"><a href="#Planner.check_for_self_collision-295"><span class="linenos">295</span></a><span class="sd">            qpos: robot configuration. if none will be the current pose</span>
</span><span id="Planner.check_for_self_collision-296"><a href="#Planner.check_for_self_collision-296"><span class="linenos">296</span></a>
</span><span id="Planner.check_for_self_collision-297"><a href="#Planner.check_for_self_collision-297"><span class="linenos">297</span></a><span class="sd">        Returns:</span>
</span><span id="Planner.check_for_self_collision-298"><a href="#Planner.check_for_self_collision-298"><span class="linenos">298</span></a><span class="sd">            A list of collisions.</span>
</span><span id="Planner.check_for_self_collision-299"><a href="#Planner.check_for_self_collision-299"><span class="linenos">299</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.check_for_self_collision-300"><a href="#Planner.check_for_self_collision-300"><span class="linenos">300</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_collision</span><span class="p">(</span>
</span><span id="Planner.check_for_self_collision-301"><a href="#Planner.check_for_self_collision-301"><span class="linenos">301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">self_collide</span><span class="p">,</span> <span class="n">articulation</span><span class="p">,</span> <span class="n">qpos</span>
</span><span id="Planner.check_for_self_collision-302"><a href="#Planner.check_for_self_collision-302"><span class="linenos">302</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check if the robot is in self-collision.</p>

<pre><code>    Args:
        articulation: robot model. if none will be self.robot
        qpos: robot configuration. if none will be the current pose

    Returns:
        A list of collisions.
</code></pre>
</div>


                            </div>
                            <div id="Planner.check_for_env_collision" class="classattr">
                                        <input id="Planner.check_for_env_collision-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_for_env_collision</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">articulation</span><span class="p">:</span> <span class="n">mplib</span><span class="o">.</span><span class="n">pymp</span><span class="o">.</span><span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">qpos</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">with_point_cloud</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Planner.check_for_env_collision-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.check_for_env_collision"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.check_for_env_collision-304"><a href="#Planner.check_for_env_collision-304"><span class="linenos">304</span></a>    <span class="k">def</span> <span class="nf">check_for_env_collision</span><span class="p">(</span>
</span><span id="Planner.check_for_env_collision-305"><a href="#Planner.check_for_env_collision-305"><span class="linenos">305</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner.check_for_env_collision-306"><a href="#Planner.check_for_env_collision-306"><span class="linenos">306</span></a>        <span class="n">articulation</span><span class="p">:</span> <span class="n">articulation</span><span class="o">.</span><span class="n">ArticulatedModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.check_for_env_collision-307"><a href="#Planner.check_for_env_collision-307"><span class="linenos">307</span></a>        <span class="n">qpos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.check_for_env_collision-308"><a href="#Planner.check_for_env_collision-308"><span class="linenos">308</span></a>        <span class="n">with_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.check_for_env_collision-309"><a href="#Planner.check_for_env_collision-309"><span class="linenos">309</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.check_for_env_collision-310"><a href="#Planner.check_for_env_collision-310"><span class="linenos">310</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Planner.check_for_env_collision-311"><a href="#Planner.check_for_env_collision-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the robot is in collision with the environment</span>
</span><span id="Planner.check_for_env_collision-312"><a href="#Planner.check_for_env_collision-312"><span class="linenos">312</span></a>
</span><span id="Planner.check_for_env_collision-313"><a href="#Planner.check_for_env_collision-313"><span class="linenos">313</span></a><span class="sd">        Args:</span>
</span><span id="Planner.check_for_env_collision-314"><a href="#Planner.check_for_env_collision-314"><span class="linenos">314</span></a><span class="sd">            articulation: robot model. if none will be self.robot</span>
</span><span id="Planner.check_for_env_collision-315"><a href="#Planner.check_for_env_collision-315"><span class="linenos">315</span></a><span class="sd">            qpos: robot configuration. if none will be the current pose</span>
</span><span id="Planner.check_for_env_collision-316"><a href="#Planner.check_for_env_collision-316"><span class="linenos">316</span></a><span class="sd">            with_point_cloud: whether to check collision against point cloud</span>
</span><span id="Planner.check_for_env_collision-317"><a href="#Planner.check_for_env_collision-317"><span class="linenos">317</span></a><span class="sd">            use_attach: whether to include the object attached to the end effector in collision checking</span>
</span><span id="Planner.check_for_env_collision-318"><a href="#Planner.check_for_env_collision-318"><span class="linenos">318</span></a><span class="sd">        Returns:</span>
</span><span id="Planner.check_for_env_collision-319"><a href="#Planner.check_for_env_collision-319"><span class="linenos">319</span></a><span class="sd">            A list of collisions.</span>
</span><span id="Planner.check_for_env_collision-320"><a href="#Planner.check_for_env_collision-320"><span class="linenos">320</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.check_for_env_collision-321"><a href="#Planner.check_for_env_collision-321"><span class="linenos">321</span></a>        <span class="c1"># store previous results</span>
</span><span id="Planner.check_for_env_collision-322"><a href="#Planner.check_for_env_collision-322"><span class="linenos">322</span></a>        <span class="n">prev_use_point_cloud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">use_point_cloud</span>
</span><span id="Planner.check_for_env_collision-323"><a href="#Planner.check_for_env_collision-323"><span class="linenos">323</span></a>        <span class="n">prev_use_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">use_attach</span>
</span><span id="Planner.check_for_env_collision-324"><a href="#Planner.check_for_env_collision-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">with_point_cloud</span><span class="p">)</span>
</span><span id="Planner.check_for_env_collision-325"><a href="#Planner.check_for_env_collision-325"><span class="linenos">325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="Planner.check_for_env_collision-326"><a href="#Planner.check_for_env_collision-326"><span class="linenos">326</span></a>
</span><span id="Planner.check_for_env_collision-327"><a href="#Planner.check_for_env_collision-327"><span class="linenos">327</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_collision</span><span class="p">(</span>
</span><span id="Planner.check_for_env_collision-328"><a href="#Planner.check_for_env_collision-328"><span class="linenos">328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_with_others</span><span class="p">,</span> <span class="n">articulation</span><span class="p">,</span> <span class="n">qpos</span>
</span><span id="Planner.check_for_env_collision-329"><a href="#Planner.check_for_env_collision-329"><span class="linenos">329</span></a>        <span class="p">)</span>
</span><span id="Planner.check_for_env_collision-330"><a href="#Planner.check_for_env_collision-330"><span class="linenos">330</span></a>
</span><span id="Planner.check_for_env_collision-331"><a href="#Planner.check_for_env_collision-331"><span class="linenos">331</span></a>        <span class="c1"># restore</span>
</span><span id="Planner.check_for_env_collision-332"><a href="#Planner.check_for_env_collision-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">prev_use_point_cloud</span><span class="p">)</span>
</span><span id="Planner.check_for_env_collision-333"><a href="#Planner.check_for_env_collision-333"><span class="linenos">333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">prev_use_attach</span><span class="p">)</span>
</span><span id="Planner.check_for_env_collision-334"><a href="#Planner.check_for_env_collision-334"><span class="linenos">334</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Check if the robot is in collision with the environment</p>

<pre><code>    Args:
        articulation: robot model. if none will be self.robot
        qpos: robot configuration. if none will be the current pose
        with_point_cloud: whether to check collision against point cloud
        use_attach: whether to include the object attached to the end effector in collision checking
    Returns:
        A list of collisions.
</code></pre>
</div>


                            </div>
                            <div id="Planner.IK" class="classattr">
                                        <input id="Planner.IK-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">IK</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">goal_pose</span>,</span><span class="param">	<span class="n">start_qpos</span>,</span><span class="param">	<span class="n">mask</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">n_init_qpos</span><span class="o">=</span><span class="mi">20</span>,</span><span class="param">	<span class="n">threshold</span><span class="o">=</span><span class="mf">0.001</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.IK-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.IK"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.IK-336"><a href="#Planner.IK-336"><span class="linenos">336</span></a>    <span class="k">def</span> <span class="nf">IK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">start_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">[],</span> <span class="n">n_init_qpos</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="Planner.IK-337"><a href="#Planner.IK-337"><span class="linenos">337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.IK-338"><a href="#Planner.IK-338"><span class="linenos">338</span></a><span class="sd">        Inverse kinematics</span>
</span><span id="Planner.IK-339"><a href="#Planner.IK-339"><span class="linenos">339</span></a>
</span><span id="Planner.IK-340"><a href="#Planner.IK-340"><span class="linenos">340</span></a><span class="sd">        Args:</span>
</span><span id="Planner.IK-341"><a href="#Planner.IK-341"><span class="linenos">341</span></a><span class="sd">            goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="Planner.IK-342"><a href="#Planner.IK-342"><span class="linenos">342</span></a><span class="sd">            start_qpos: initial configuration</span>
</span><span id="Planner.IK-343"><a href="#Planner.IK-343"><span class="linenos">343</span></a><span class="sd">            mask: if the value at a given index is True, the joint is *not* used in the IK</span>
</span><span id="Planner.IK-344"><a href="#Planner.IK-344"><span class="linenos">344</span></a><span class="sd">            n_init_qpos: number of random initial configurations</span>
</span><span id="Planner.IK-345"><a href="#Planner.IK-345"><span class="linenos">345</span></a><span class="sd">            threshold: threshold for the distance between the goal pose and the result pose</span>
</span><span id="Planner.IK-346"><a href="#Planner.IK-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.IK-347"><a href="#Planner.IK-347"><span class="linenos">347</span></a>
</span><span id="Planner.IK-348"><a href="#Planner.IK-348"><span class="linenos">348</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="Planner.IK-349"><a href="#Planner.IK-349"><span class="linenos">349</span></a>        <span class="n">min_dis</span> <span class="o">=</span> <span class="mf">1e9</span>
</span><span id="Planner.IK-350"><a href="#Planner.IK-350"><span class="linenos">350</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner.IK-351"><a href="#Planner.IK-351"><span class="linenos">351</span></a>        <span class="n">qpos0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">start_qpos</span><span class="p">)</span>
</span><span id="Planner.IK-352"><a href="#Planner.IK-352"><span class="linenos">352</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Planner.IK-353"><a href="#Planner.IK-353"><span class="linenos">353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">start_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner.IK-354"><a href="#Planner.IK-354"><span class="linenos">354</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_init_qpos</span><span class="p">):</span>
</span><span id="Planner.IK-355"><a href="#Planner.IK-355"><span class="linenos">355</span></a>            <span class="n">ik_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_IK_CLIK</span><span class="p">(</span>
</span><span id="Planner.IK-356"><a href="#Planner.IK-356"><span class="linenos">356</span></a>                <span class="n">index</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">start_qpos</span><span class="p">,</span> <span class="n">mask</span>
</span><span id="Planner.IK-357"><a href="#Planner.IK-357"><span class="linenos">357</span></a>            <span class="p">)</span>
</span><span id="Planner.IK-358"><a href="#Planner.IK-358"><span class="linenos">358</span></a>            <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_joint_limit</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># will clip qpos</span>
</span><span id="Planner.IK-359"><a href="#Planner.IK-359"><span class="linenos">359</span></a>
</span><span id="Planner.IK-360"><a href="#Planner.IK-360"><span class="linenos">360</span></a>            <span class="c1"># check collision</span>
</span><span id="Planner.IK-361"><a href="#Planner.IK-361"><span class="linenos">361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_qpos_all</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Planner.IK-362"><a href="#Planner.IK-362"><span class="linenos">362</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner.IK-363"><a href="#Planner.IK-363"><span class="linenos">363</span></a>                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner.IK-364"><a href="#Planner.IK-364"><span class="linenos">364</span></a>
</span><span id="Planner.IK-365"><a href="#Planner.IK-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="Planner.IK-366"><a href="#Planner.IK-366"><span class="linenos">366</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_forward_kinematics</span><span class="p">(</span><span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Planner.IK-367"><a href="#Planner.IK-367"><span class="linenos">367</span></a>                <span class="n">new_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_pose</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span id="Planner.IK-368"><a href="#Planner.IK-368"><span class="linenos">368</span></a>                <span class="n">tmp_dis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_6D</span><span class="p">(</span>
</span><span id="Planner.IK-369"><a href="#Planner.IK-369"><span class="linenos">369</span></a>                    <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">new_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">new_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
</span><span id="Planner.IK-370"><a href="#Planner.IK-370"><span class="linenos">370</span></a>                <span class="p">)</span>
</span><span id="Planner.IK-371"><a href="#Planner.IK-371"><span class="linenos">371</span></a>                <span class="k">if</span> <span class="n">tmp_dis</span> <span class="o">&lt;</span> <span class="n">min_dis</span><span class="p">:</span>
</span><span id="Planner.IK-372"><a href="#Planner.IK-372"><span class="linenos">372</span></a>                    <span class="n">min_dis</span> <span class="o">=</span> <span class="n">tmp_dis</span>
</span><span id="Planner.IK-373"><a href="#Planner.IK-373"><span class="linenos">373</span></a>                <span class="k">if</span> <span class="n">tmp_dis</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="Planner.IK-374"><a href="#Planner.IK-374"><span class="linenos">374</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">ik_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner.IK-375"><a href="#Planner.IK-375"><span class="linenos">375</span></a>                    <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Planner.IK-376"><a href="#Planner.IK-376"><span class="linenos">376</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
</span><span id="Planner.IK-377"><a href="#Planner.IK-377"><span class="linenos">377</span></a>                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="Planner.IK-378"><a href="#Planner.IK-378"><span class="linenos">378</span></a>                            <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner.IK-379"><a href="#Planner.IK-379"><span class="linenos">379</span></a>                    <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
</span><span id="Planner.IK-380"><a href="#Planner.IK-380"><span class="linenos">380</span></a>                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="Planner.IK-381"><a href="#Planner.IK-381"><span class="linenos">381</span></a>            <span class="n">start_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_random_configuration</span><span class="p">()</span>
</span><span id="Planner.IK-382"><a href="#Planner.IK-382"><span class="linenos">382</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="Planner.IK-383"><a href="#Planner.IK-383"><span class="linenos">383</span></a>            <span class="k">if</span> <span class="n">mask_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner.IK-384"><a href="#Planner.IK-384"><span class="linenos">384</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_len</span><span class="p">):</span>
</span><span id="Planner.IK-385"><a href="#Planner.IK-385"><span class="linenos">385</span></a>                    <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span id="Planner.IK-386"><a href="#Planner.IK-386"><span class="linenos">386</span></a>                        <span class="n">start_qpos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpos0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Planner.IK-387"><a href="#Planner.IK-387"><span class="linenos">387</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner.IK-388"><a href="#Planner.IK-388"><span class="linenos">388</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
</span><span id="Planner.IK-389"><a href="#Planner.IK-389"><span class="linenos">389</span></a>        <span class="k">elif</span> <span class="n">min_dis</span> <span class="o">!=</span> <span class="mf">1e9</span><span class="p">:</span>
</span><span id="Planner.IK-390"><a href="#Planner.IK-390"><span class="linenos">390</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;IK Failed! Distance </span><span class="si">%lf</span><span class="s2"> is greater than threshold </span><span class="si">%lf</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="Planner.IK-391"><a href="#Planner.IK-391"><span class="linenos">391</span></a>                <span class="n">min_dis</span><span class="p">,</span>
</span><span id="Planner.IK-392"><a href="#Planner.IK-392"><span class="linenos">392</span></a>                <span class="n">threshold</span><span class="p">,</span>
</span><span id="Planner.IK-393"><a href="#Planner.IK-393"><span class="linenos">393</span></a>            <span class="p">)</span>
</span><span id="Planner.IK-394"><a href="#Planner.IK-394"><span class="linenos">394</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Planner.IK-395"><a href="#Planner.IK-395"><span class="linenos">395</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;IK Failed! Cannot find valid solution.&quot;</span>
</span><span id="Planner.IK-396"><a href="#Planner.IK-396"><span class="linenos">396</span></a>        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Inverse kinematics</p>

<p>Args:
    goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal
    start_qpos: initial configuration
    mask: if the value at a given index is True, the joint is <em>not</em> used in the IK
    n_init_qpos: number of random initial configurations
    threshold: threshold for the distance between the goal pose and the result pose</p>
</div>


                            </div>
                            <div id="Planner.TOPP" class="classattr">
                                        <input id="Planner.TOPP-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">TOPP</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path</span>, </span><span class="param"><span class="n">step</span><span class="o">=</span><span class="mf">0.1</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.TOPP-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.TOPP"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.TOPP-398"><a href="#Planner.TOPP-398"><span class="linenos">398</span></a>    <span class="k">def</span> <span class="nf">TOPP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Planner.TOPP-399"><a href="#Planner.TOPP-399"><span class="linenos">399</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.TOPP-400"><a href="#Planner.TOPP-400"><span class="linenos">400</span></a><span class="sd">        Time-Optimal Path Parameterization</span>
</span><span id="Planner.TOPP-401"><a href="#Planner.TOPP-401"><span class="linenos">401</span></a>
</span><span id="Planner.TOPP-402"><a href="#Planner.TOPP-402"><span class="linenos">402</span></a><span class="sd">        Args:</span>
</span><span id="Planner.TOPP-403"><a href="#Planner.TOPP-403"><span class="linenos">403</span></a><span class="sd">            path: numpy array of shape (n, dof)</span>
</span><span id="Planner.TOPP-404"><a href="#Planner.TOPP-404"><span class="linenos">404</span></a><span class="sd">            step: step size for the discretization</span>
</span><span id="Planner.TOPP-405"><a href="#Planner.TOPP-405"><span class="linenos">405</span></a><span class="sd">            verbose: if True, will print the log of TOPPRA</span>
</span><span id="Planner.TOPP-406"><a href="#Planner.TOPP-406"><span class="linenos">406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.TOPP-407"><a href="#Planner.TOPP-407"><span class="linenos">407</span></a>
</span><span id="Planner.TOPP-408"><a href="#Planner.TOPP-408"><span class="linenos">408</span></a>        <span class="n">N_samples</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner.TOPP-409"><a href="#Planner.TOPP-409"><span class="linenos">409</span></a>        <span class="n">dof</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Planner.TOPP-410"><a href="#Planner.TOPP-410"><span class="linenos">410</span></a>        <span class="k">assert</span> <span class="n">dof</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="Planner.TOPP-411"><a href="#Planner.TOPP-411"><span class="linenos">411</span></a>        <span class="k">assert</span> <span class="n">dof</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="Planner.TOPP-412"><a href="#Planner.TOPP-412"><span class="linenos">412</span></a>        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_samples</span><span class="p">)</span>
</span><span id="Planner.TOPP-413"><a href="#Planner.TOPP-413"><span class="linenos">413</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">SplineInterpolator</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span><span id="Planner.TOPP-414"><a href="#Planner.TOPP-414"><span class="linenos">414</span></a>        <span class="n">pc_vel</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">JointVelocityConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_vel_limits</span><span class="p">)</span>
</span><span id="Planner.TOPP-415"><a href="#Planner.TOPP-415"><span class="linenos">415</span></a>        <span class="n">pc_acc</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">JointAccelerationConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_acc_limits</span><span class="p">)</span>
</span><span id="Planner.TOPP-416"><a href="#Planner.TOPP-416"><span class="linenos">416</span></a>        <span class="n">instance</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">TOPPRA</span><span class="p">(</span>
</span><span id="Planner.TOPP-417"><a href="#Planner.TOPP-417"><span class="linenos">417</span></a>            <span class="p">[</span><span class="n">pc_vel</span><span class="p">,</span> <span class="n">pc_acc</span><span class="p">],</span> <span class="n">path</span><span class="p">,</span> <span class="n">parametrizer</span><span class="o">=</span><span class="s2">&quot;ParametrizeConstAccel&quot;</span>
</span><span id="Planner.TOPP-418"><a href="#Planner.TOPP-418"><span class="linenos">418</span></a>        <span class="p">)</span>
</span><span id="Planner.TOPP-419"><a href="#Planner.TOPP-419"><span class="linenos">419</span></a>        <span class="n">jnt_traj</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">compute_trajectory</span><span class="p">()</span>
</span><span id="Planner.TOPP-420"><a href="#Planner.TOPP-420"><span class="linenos">420</span></a>        <span class="n">ts_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="n">step</span><span class="p">))</span>
</span><span id="Planner.TOPP-421"><a href="#Planner.TOPP-421"><span class="linenos">421</span></a>        <span class="n">qs_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">)</span>
</span><span id="Planner.TOPP-422"><a href="#Planner.TOPP-422"><span class="linenos">422</span></a>        <span class="n">qds_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Planner.TOPP-423"><a href="#Planner.TOPP-423"><span class="linenos">423</span></a>        <span class="n">qdds_sample</span> <span class="o">=</span> <span class="n">jnt_traj</span><span class="p">(</span><span class="n">ts_sample</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Planner.TOPP-424"><a href="#Planner.TOPP-424"><span class="linenos">424</span></a>        <span class="k">return</span> <span class="n">ts_sample</span><span class="p">,</span> <span class="n">qs_sample</span><span class="p">,</span> <span class="n">qds_sample</span><span class="p">,</span> <span class="n">qdds_sample</span><span class="p">,</span> <span class="n">jnt_traj</span><span class="o">.</span><span class="n">duration</span>
</span></pre></div>


            <div class="docstring"><p>Time-Optimal Path Parameterization</p>

<p>Args:
    path: numpy array of shape (n, dof)
    step: step size for the discretization
    verbose: if True, will print the log of TOPPRA</p>
</div>


                            </div>
                            <div id="Planner.update_point_cloud" class="classattr">
                                        <input id="Planner.update_point_cloud-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_point_cloud</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pc</span>, </span><span class="param"><span class="n">radius</span><span class="o">=</span><span class="mf">0.001</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.update_point_cloud-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.update_point_cloud"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.update_point_cloud-426"><a href="#Planner.update_point_cloud-426"><span class="linenos">426</span></a>    <span class="k">def</span> <span class="nf">update_point_cloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
</span><span id="Planner.update_point_cloud-427"><a href="#Planner.update_point_cloud-427"><span class="linenos">427</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.update_point_cloud-428"><a href="#Planner.update_point_cloud-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="Planner.update_point_cloud-429"><a href="#Planner.update_point_cloud-429"><span class="linenos">429</span></a><span class="sd">            pc: numpy array of shape (n, 3)</span>
</span><span id="Planner.update_point_cloud-430"><a href="#Planner.update_point_cloud-430"><span class="linenos">430</span></a><span class="sd">            radius: radius of each point. This gives a buffer around each point that planner will avoid</span>
</span><span id="Planner.update_point_cloud-431"><a href="#Planner.update_point_cloud-431"><span class="linenos">431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.update_point_cloud-432"><a href="#Planner.update_point_cloud-432"><span class="linenos">432</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_point_cloud</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Args:
    pc: numpy array of shape (n, 3)
    radius: radius of each point. This gives a buffer around each point that planner will avoid</p>
</div>


                            </div>
                            <div id="Planner.update_attached_tool" class="classattr">
                                        <input id="Planner.update_attached_tool-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_attached_tool</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fcl_collision_geometry</span>, </span><span class="param"><span class="n">pose</span>, </span><span class="param"><span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.update_attached_tool-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.update_attached_tool"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.update_attached_tool-434"><a href="#Planner.update_attached_tool-434"><span class="linenos">434</span></a>    <span class="k">def</span> <span class="nf">update_attached_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fcl_collision_geometry</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner.update_attached_tool-435"><a href="#Planner.update_attached_tool-435"><span class="linenos">435</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;helper function to update the attached tool&quot;&quot;&quot;</span>
</span><span id="Planner.update_attached_tool-436"><a href="#Planner.update_attached_tool-436"><span class="linenos">436</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner.update_attached_tool-437"><a href="#Planner.update_attached_tool-437"><span class="linenos">437</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner.update_attached_tool-438"><a href="#Planner.update_attached_tool-438"><span class="linenos">438</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_tool</span><span class="p">(</span><span class="n">fcl_collision_geometry</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>helper function to update the attached tool</p>
</div>


                            </div>
                            <div id="Planner.update_attached_sphere" class="classattr">
                                        <input id="Planner.update_attached_sphere-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_attached_sphere</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">radius</span>, </span><span class="param"><span class="n">pose</span>, </span><span class="param"><span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.update_attached_sphere-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.update_attached_sphere"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.update_attached_sphere-440"><a href="#Planner.update_attached_sphere-440"><span class="linenos">440</span></a>    <span class="k">def</span> <span class="nf">update_attached_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner.update_attached_sphere-441"><a href="#Planner.update_attached_sphere-441"><span class="linenos">441</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.update_attached_sphere-442"><a href="#Planner.update_attached_sphere-442"><span class="linenos">442</span></a><span class="sd">        attach a sphere to some link</span>
</span><span id="Planner.update_attached_sphere-443"><a href="#Planner.update_attached_sphere-443"><span class="linenos">443</span></a>
</span><span id="Planner.update_attached_sphere-444"><a href="#Planner.update_attached_sphere-444"><span class="linenos">444</span></a><span class="sd">        Args:</span>
</span><span id="Planner.update_attached_sphere-445"><a href="#Planner.update_attached_sphere-445"><span class="linenos">445</span></a><span class="sd">            radius: radius of the sphere</span>
</span><span id="Planner.update_attached_sphere-446"><a href="#Planner.update_attached_sphere-446"><span class="linenos">446</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the sphere</span>
</span><span id="Planner.update_attached_sphere-447"><a href="#Planner.update_attached_sphere-447"><span class="linenos">447</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="Planner.update_attached_sphere-448"><a href="#Planner.update_attached_sphere-448"><span class="linenos">448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.update_attached_sphere-449"><a href="#Planner.update_attached_sphere-449"><span class="linenos">449</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner.update_attached_sphere-450"><a href="#Planner.update_attached_sphere-450"><span class="linenos">450</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner.update_attached_sphere-451"><a href="#Planner.update_attached_sphere-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>attach a sphere to some link</p>

<p>Args:
    radius: radius of the sphere
    pose: [x,y,z,qw,qx,qy,qz] pose of the sphere
    link_id: if not provided, the end effector will be the target.</p>
</div>


                            </div>
                            <div id="Planner.update_attached_box" class="classattr">
                                        <input id="Planner.update_attached_box-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_attached_box</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">size</span>, </span><span class="param"><span class="n">pose</span>, </span><span class="param"><span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.update_attached_box-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.update_attached_box"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.update_attached_box-453"><a href="#Planner.update_attached_box-453"><span class="linenos">453</span></a>    <span class="k">def</span> <span class="nf">update_attached_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner.update_attached_box-454"><a href="#Planner.update_attached_box-454"><span class="linenos">454</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.update_attached_box-455"><a href="#Planner.update_attached_box-455"><span class="linenos">455</span></a><span class="sd">        attach a box to some link</span>
</span><span id="Planner.update_attached_box-456"><a href="#Planner.update_attached_box-456"><span class="linenos">456</span></a>
</span><span id="Planner.update_attached_box-457"><a href="#Planner.update_attached_box-457"><span class="linenos">457</span></a><span class="sd">        Args:</span>
</span><span id="Planner.update_attached_box-458"><a href="#Planner.update_attached_box-458"><span class="linenos">458</span></a><span class="sd">            size: [x,y,z] size of the box</span>
</span><span id="Planner.update_attached_box-459"><a href="#Planner.update_attached_box-459"><span class="linenos">459</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the box</span>
</span><span id="Planner.update_attached_box-460"><a href="#Planner.update_attached_box-460"><span class="linenos">460</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="Planner.update_attached_box-461"><a href="#Planner.update_attached_box-461"><span class="linenos">461</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.update_attached_box-462"><a href="#Planner.update_attached_box-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner.update_attached_box-463"><a href="#Planner.update_attached_box-463"><span class="linenos">463</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner.update_attached_box-464"><a href="#Planner.update_attached_box-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_box</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>attach a box to some link</p>

<p>Args:
    size: [x,y,z] size of the box
    pose: [x,y,z,qw,qx,qy,qz] pose of the box
    link_id: if not provided, the end effector will be the target.</p>
</div>


                            </div>
                            <div id="Planner.update_attached_mesh" class="classattr">
                                        <input id="Planner.update_attached_mesh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_attached_mesh</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mesh_path</span>, </span><span class="param"><span class="n">pose</span>, </span><span class="param"><span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.update_attached_mesh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.update_attached_mesh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.update_attached_mesh-466"><a href="#Planner.update_attached_mesh-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">update_attached_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_path</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">link_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner.update_attached_mesh-467"><a href="#Planner.update_attached_mesh-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.update_attached_mesh-468"><a href="#Planner.update_attached_mesh-468"><span class="linenos">468</span></a><span class="sd">        attach a mesh to some link</span>
</span><span id="Planner.update_attached_mesh-469"><a href="#Planner.update_attached_mesh-469"><span class="linenos">469</span></a>
</span><span id="Planner.update_attached_mesh-470"><a href="#Planner.update_attached_mesh-470"><span class="linenos">470</span></a><span class="sd">        Args:</span>
</span><span id="Planner.update_attached_mesh-471"><a href="#Planner.update_attached_mesh-471"><span class="linenos">471</span></a><span class="sd">            mesh_path: path to the mesh</span>
</span><span id="Planner.update_attached_mesh-472"><a href="#Planner.update_attached_mesh-472"><span class="linenos">472</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the mesh</span>
</span><span id="Planner.update_attached_mesh-473"><a href="#Planner.update_attached_mesh-473"><span class="linenos">473</span></a><span class="sd">            link_id: if not provided, the end effector will be the target.</span>
</span><span id="Planner.update_attached_mesh-474"><a href="#Planner.update_attached_mesh-474"><span class="linenos">474</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.update_attached_mesh-475"><a href="#Planner.update_attached_mesh-475"><span class="linenos">475</span></a>        <span class="k">if</span> <span class="n">link_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Planner.update_attached_mesh-476"><a href="#Planner.update_attached_mesh-476"><span class="linenos">476</span></a>            <span class="n">link_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_link_id</span>
</span><span id="Planner.update_attached_mesh-477"><a href="#Planner.update_attached_mesh-477"><span class="linenos">477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">update_attached_mesh</span><span class="p">(</span><span class="n">mesh_path</span><span class="p">,</span> <span class="n">link_id</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>attach a mesh to some link</p>

<p>Args:
    mesh_path: path to the mesh
    pose: [x,y,z,qw,qx,qy,qz] pose of the mesh
    link_id: if not provided, the end effector will be the target.</p>
</div>


                            </div>
                            <div id="Planner.set_base_pose" class="classattr">
                                        <input id="Planner.set_base_pose-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_base_pose</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pose</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.set_base_pose-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.set_base_pose"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.set_base_pose-479"><a href="#Planner.set_base_pose-479"><span class="linenos">479</span></a>    <span class="k">def</span> <span class="nf">set_base_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose</span><span class="p">):</span>
</span><span id="Planner.set_base_pose-480"><a href="#Planner.set_base_pose-480"><span class="linenos">480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.set_base_pose-481"><a href="#Planner.set_base_pose-481"><span class="linenos">481</span></a><span class="sd">        tell the planner where the base of the robot is w.r.t the world frame</span>
</span><span id="Planner.set_base_pose-482"><a href="#Planner.set_base_pose-482"><span class="linenos">482</span></a>
</span><span id="Planner.set_base_pose-483"><a href="#Planner.set_base_pose-483"><span class="linenos">483</span></a><span class="sd">        Args:</span>
</span><span id="Planner.set_base_pose-484"><a href="#Planner.set_base_pose-484"><span class="linenos">484</span></a><span class="sd">            pose: [x,y,z,qw,qx,qy,qz] pose of the base</span>
</span><span id="Planner.set_base_pose-485"><a href="#Planner.set_base_pose-485"><span class="linenos">485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.set_base_pose-486"><a href="#Planner.set_base_pose-486"><span class="linenos">486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_base_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>tell the planner where the base of the robot is w.r.t the world frame</p>

<p>Args:
    pose: [x,y,z,qw,qx,qy,qz] pose of the base</p>
</div>


                            </div>
                            <div id="Planner.set_normal_object" class="classattr">
                                        <input id="Planner.set_normal_object-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_normal_object</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span>, </span><span class="param"><span class="n">collision_object</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.set_normal_object-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.set_normal_object"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.set_normal_object-488"><a href="#Planner.set_normal_object-488"><span class="linenos">488</span></a>    <span class="k">def</span> <span class="nf">set_normal_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">collision_object</span><span class="p">):</span>
</span><span id="Planner.set_normal_object-489"><a href="#Planner.set_normal_object-489"><span class="linenos">489</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;adds or updates a non-articulated collision object in the scene&quot;&quot;&quot;</span>
</span><span id="Planner.set_normal_object-490"><a href="#Planner.set_normal_object-490"><span class="linenos">490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_normal_object</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">collision_object</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>adds or updates a non-articulated collision object in the scene</p>
</div>


                            </div>
                            <div id="Planner.remove_normal_object" class="classattr">
                                        <input id="Planner.remove_normal_object-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">remove_normal_object</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.remove_normal_object-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.remove_normal_object"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.remove_normal_object-492"><a href="#Planner.remove_normal_object-492"><span class="linenos">492</span></a>    <span class="k">def</span> <span class="nf">remove_normal_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="Planner.remove_normal_object-493"><a href="#Planner.remove_normal_object-493"><span class="linenos">493</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;returns true if the object was removed, false if it was not found&quot;&quot;&quot;</span>
</span><span id="Planner.remove_normal_object-494"><a href="#Planner.remove_normal_object-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">remove_normal_object</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>returns true if the object was removed, false if it was not found</p>
</div>


                            </div>
                            <div id="Planner.plan_qpos_to_qpos" class="classattr">
                                        <input id="Planner.plan_qpos_to_qpos-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plan_qpos_to_qpos</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">goal_qposes</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">current_qpos</span>,</span><span class="param">	<span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">planner_name</span><span class="o">=</span><span class="s1">&#39;RRTConnect&#39;</span>,</span><span class="param">	<span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">fixed_joint_indices</span><span class="o">=</span><span class="p">[]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.plan_qpos_to_qpos-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.plan_qpos_to_qpos"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.plan_qpos_to_qpos-496"><a href="#Planner.plan_qpos_to_qpos-496"><span class="linenos">496</span></a>    <span class="k">def</span> <span class="nf">plan_qpos_to_qpos</span><span class="p">(</span>
</span><span id="Planner.plan_qpos_to_qpos-497"><a href="#Planner.plan_qpos_to_qpos-497"><span class="linenos">497</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-498"><a href="#Planner.plan_qpos_to_qpos-498"><span class="linenos">498</span></a>        <span class="n">goal_qposes</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-499"><a href="#Planner.plan_qpos_to_qpos-499"><span class="linenos">499</span></a>        <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-500"><a href="#Planner.plan_qpos_to_qpos-500"><span class="linenos">500</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-501"><a href="#Planner.plan_qpos_to_qpos-501"><span class="linenos">501</span></a>        <span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-502"><a href="#Planner.plan_qpos_to_qpos-502"><span class="linenos">502</span></a>        <span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-503"><a href="#Planner.plan_qpos_to_qpos-503"><span class="linenos">503</span></a>        <span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-504"><a href="#Planner.plan_qpos_to_qpos-504"><span class="linenos">504</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-505"><a href="#Planner.plan_qpos_to_qpos-505"><span class="linenos">505</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-506"><a href="#Planner.plan_qpos_to_qpos-506"><span class="linenos">506</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-507"><a href="#Planner.plan_qpos_to_qpos-507"><span class="linenos">507</span></a>        <span class="n">planner_name</span><span class="o">=</span><span class="s2">&quot;RRTConnect&quot;</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-508"><a href="#Planner.plan_qpos_to_qpos-508"><span class="linenos">508</span></a>        <span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-509"><a href="#Planner.plan_qpos_to_qpos-509"><span class="linenos">509</span></a>        <span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-510"><a href="#Planner.plan_qpos_to_qpos-510"><span class="linenos">510</span></a>        <span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-511"><a href="#Planner.plan_qpos_to_qpos-511"><span class="linenos">511</span></a>        <span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-512"><a href="#Planner.plan_qpos_to_qpos-512"><span class="linenos">512</span></a>        <span class="n">fixed_joint_indices</span><span class="o">=</span><span class="p">[],</span>
</span><span id="Planner.plan_qpos_to_qpos-513"><a href="#Planner.plan_qpos_to_qpos-513"><span class="linenos">513</span></a>    <span class="p">):</span>
</span><span id="Planner.plan_qpos_to_qpos-514"><a href="#Planner.plan_qpos_to_qpos-514"><span class="linenos">514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.plan_qpos_to_qpos-515"><a href="#Planner.plan_qpos_to_qpos-515"><span class="linenos">515</span></a><span class="sd">        plan a path from a specified joint position to a goal pose</span>
</span><span id="Planner.plan_qpos_to_qpos-516"><a href="#Planner.plan_qpos_to_qpos-516"><span class="linenos">516</span></a>
</span><span id="Planner.plan_qpos_to_qpos-517"><a href="#Planner.plan_qpos_to_qpos-517"><span class="linenos">517</span></a><span class="sd">        Args:</span>
</span><span id="Planner.plan_qpos_to_qpos-518"><a href="#Planner.plan_qpos_to_qpos-518"><span class="linenos">518</span></a><span class="sd">            goal_pose: 7D pose of the end-effector [x,y,z,qw,qx,qy,qz]</span>
</span><span id="Planner.plan_qpos_to_qpos-519"><a href="#Planner.plan_qpos_to_qpos-519"><span class="linenos">519</span></a><span class="sd">            current_qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="Planner.plan_qpos_to_qpos-520"><a href="#Planner.plan_qpos_to_qpos-520"><span class="linenos">520</span></a><span class="sd">            mask: mask for IK. When set, the IK will leave certain joints out of planning</span>
</span><span id="Planner.plan_qpos_to_qpos-521"><a href="#Planner.plan_qpos_to_qpos-521"><span class="linenos">521</span></a><span class="sd">            time_step: time step for TOPP</span>
</span><span id="Planner.plan_qpos_to_qpos-522"><a href="#Planner.plan_qpos_to_qpos-522"><span class="linenos">522</span></a><span class="sd">            rrt_range: step size for RRT</span>
</span><span id="Planner.plan_qpos_to_qpos-523"><a href="#Planner.plan_qpos_to_qpos-523"><span class="linenos">523</span></a><span class="sd">            planning_time: time limit for RRT</span>
</span><span id="Planner.plan_qpos_to_qpos-524"><a href="#Planner.plan_qpos_to_qpos-524"><span class="linenos">524</span></a><span class="sd">            fix_joint_limits: if True, will clip the joint configuration to be within the joint limits</span>
</span><span id="Planner.plan_qpos_to_qpos-525"><a href="#Planner.plan_qpos_to_qpos-525"><span class="linenos">525</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="Planner.plan_qpos_to_qpos-526"><a href="#Planner.plan_qpos_to_qpos-526"><span class="linenos">526</span></a><span class="sd">            use_attach: if True, will consider the attached tool collision when planning</span>
</span><span id="Planner.plan_qpos_to_qpos-527"><a href="#Planner.plan_qpos_to_qpos-527"><span class="linenos">527</span></a><span class="sd">            verbose: if True, will print the log of OMPL and TOPPRA</span>
</span><span id="Planner.plan_qpos_to_qpos-528"><a href="#Planner.plan_qpos_to_qpos-528"><span class="linenos">528</span></a><span class="sd">            planner_name: planner name pick from {&quot;RRTConnect&quot;, &quot;RRT*&quot;}</span>
</span><span id="Planner.plan_qpos_to_qpos-529"><a href="#Planner.plan_qpos_to_qpos-529"><span class="linenos">529</span></a><span class="sd">            fixed_joint_indices: list of indices of joints that are fixed during planning</span>
</span><span id="Planner.plan_qpos_to_qpos-530"><a href="#Planner.plan_qpos_to_qpos-530"><span class="linenos">530</span></a><span class="sd">            constraint_function: evals to 0 when constraint is satisfied</span>
</span><span id="Planner.plan_qpos_to_qpos-531"><a href="#Planner.plan_qpos_to_qpos-531"><span class="linenos">531</span></a><span class="sd">            constraint_jacobian: jacobian of constraint_function</span>
</span><span id="Planner.plan_qpos_to_qpos-532"><a href="#Planner.plan_qpos_to_qpos-532"><span class="linenos">532</span></a><span class="sd">            constraint_tolerance: tolerance for constraint_function</span>
</span><span id="Planner.plan_qpos_to_qpos-533"><a href="#Planner.plan_qpos_to_qpos-533"><span class="linenos">533</span></a><span class="sd">            no_simplification: if true, will not simplify the path. constraint planning does not support simplification</span>
</span><span id="Planner.plan_qpos_to_qpos-534"><a href="#Planner.plan_qpos_to_qpos-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.plan_qpos_to_qpos-535"><a href="#Planner.plan_qpos_to_qpos-535"><span class="linenos">535</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">use_point_cloud</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-536"><a href="#Planner.plan_qpos_to_qpos-536"><span class="linenos">536</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-537"><a href="#Planner.plan_qpos_to_qpos-537"><span class="linenos">537</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">current_qpos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner.plan_qpos_to_qpos-538"><a href="#Planner.plan_qpos_to_qpos-538"><span class="linenos">538</span></a>        <span class="k">if</span> <span class="n">fix_joint_limits</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-539"><a href="#Planner.plan_qpos_to_qpos-539"><span class="linenos">539</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner.plan_qpos_to_qpos-540"><a href="#Planner.plan_qpos_to_qpos-540"><span class="linenos">540</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Planner.plan_qpos_to_qpos-541"><a href="#Planner.plan_qpos_to_qpos-541"><span class="linenos">541</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner.plan_qpos_to_qpos-542"><a href="#Planner.plan_qpos_to_qpos-542"><span class="linenos">542</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Planner.plan_qpos_to_qpos-543"><a href="#Planner.plan_qpos_to_qpos-543"><span class="linenos">543</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner.plan_qpos_to_qpos-544"><a href="#Planner.plan_qpos_to_qpos-544"><span class="linenos">544</span></a>
</span><span id="Planner.plan_qpos_to_qpos-545"><a href="#Planner.plan_qpos_to_qpos-545"><span class="linenos">545</span></a>        <span class="n">current_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-546"><a href="#Planner.plan_qpos_to_qpos-546"><span class="linenos">546</span></a>
</span><span id="Planner.plan_qpos_to_qpos-547"><a href="#Planner.plan_qpos_to_qpos-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-548"><a href="#Planner.plan_qpos_to_qpos-548"><span class="linenos">548</span></a>        <span class="n">collisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide_full</span><span class="p">()</span>
</span><span id="Planner.plan_qpos_to_qpos-549"><a href="#Planner.plan_qpos_to_qpos-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-550"><a href="#Planner.plan_qpos_to_qpos-550"><span class="linenos">550</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid start state!&quot;</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-551"><a href="#Planner.plan_qpos_to_qpos-551"><span class="linenos">551</span></a>            <span class="k">for</span> <span class="n">collision</span> <span class="ow">in</span> <span class="n">collisions</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-552"><a href="#Planner.plan_qpos_to_qpos-552"><span class="linenos">552</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Planner.plan_qpos_to_qpos-553"><a href="#Planner.plan_qpos_to_qpos-553"><span class="linenos">553</span></a>                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> collide!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">collision</span><span class="o">.</span><span class="n">link_name1</span><span class="p">,</span> <span class="n">collision</span><span class="o">.</span><span class="n">link_name2</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-554"><a href="#Planner.plan_qpos_to_qpos-554"><span class="linenos">554</span></a>                <span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-555"><a href="#Planner.plan_qpos_to_qpos-555"><span class="linenos">555</span></a>
</span><span id="Planner.plan_qpos_to_qpos-556"><a href="#Planner.plan_qpos_to_qpos-556"><span class="linenos">556</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner.plan_qpos_to_qpos-557"><a href="#Planner.plan_qpos_to_qpos-557"><span class="linenos">557</span></a>
</span><span id="Planner.plan_qpos_to_qpos-558"><a href="#Planner.plan_qpos_to_qpos-558"><span class="linenos">558</span></a>        <span class="n">goal_qpos_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Planner.plan_qpos_to_qpos-559"><a href="#Planner.plan_qpos_to_qpos-559"><span class="linenos">559</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qposes</span><span class="p">)):</span>
</span><span id="Planner.plan_qpos_to_qpos-560"><a href="#Planner.plan_qpos_to_qpos-560"><span class="linenos">560</span></a>            <span class="n">goal_qpos_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_qposes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Planner.plan_qpos_to_qpos-561"><a href="#Planner.plan_qpos_to_qpos-561"><span class="linenos">561</span></a>
</span><span id="Planner.plan_qpos_to_qpos-562"><a href="#Planner.plan_qpos_to_qpos-562"><span class="linenos">562</span></a>        <span class="n">fixed_joints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Planner.plan_qpos_to_qpos-563"><a href="#Planner.plan_qpos_to_qpos-563"><span class="linenos">563</span></a>        <span class="k">for</span> <span class="n">joint_idx</span> <span class="ow">in</span> <span class="n">fixed_joint_indices</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-564"><a href="#Planner.plan_qpos_to_qpos-564"><span class="linenos">564</span></a>            <span class="n">fixed_joints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ompl</span><span class="o">.</span><span class="n">FixedJoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">joint_idx</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">joint_idx</span><span class="p">]))</span>
</span><span id="Planner.plan_qpos_to_qpos-565"><a href="#Planner.plan_qpos_to_qpos-565"><span class="linenos">565</span></a>
</span><span id="Planner.plan_qpos_to_qpos-566"><a href="#Planner.plan_qpos_to_qpos-566"><span class="linenos">566</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Planner.plan_qpos_to_qpos-567"><a href="#Planner.plan_qpos_to_qpos-567"><span class="linenos">567</span></a>        <span class="n">status</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span>
</span><span id="Planner.plan_qpos_to_qpos-568"><a href="#Planner.plan_qpos_to_qpos-568"><span class="linenos">568</span></a>            <span class="n">current_qpos</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
</span><span id="Planner.plan_qpos_to_qpos-569"><a href="#Planner.plan_qpos_to_qpos-569"><span class="linenos">569</span></a>            <span class="n">goal_qpos_</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-570"><a href="#Planner.plan_qpos_to_qpos-570"><span class="linenos">570</span></a>            <span class="nb">range</span><span class="o">=</span><span class="n">rrt_range</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-571"><a href="#Planner.plan_qpos_to_qpos-571"><span class="linenos">571</span></a>            <span class="n">time</span><span class="o">=</span><span class="n">planning_time</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-572"><a href="#Planner.plan_qpos_to_qpos-572"><span class="linenos">572</span></a>            <span class="n">fixed_joints</span><span class="o">=</span><span class="n">fixed_joints</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-573"><a href="#Planner.plan_qpos_to_qpos-573"><span class="linenos">573</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-574"><a href="#Planner.plan_qpos_to_qpos-574"><span class="linenos">574</span></a>            <span class="n">planner_name</span><span class="o">=</span><span class="n">planner_name</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-575"><a href="#Planner.plan_qpos_to_qpos-575"><span class="linenos">575</span></a>            <span class="n">no_simplification</span><span class="o">=</span><span class="n">no_simplification</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-576"><a href="#Planner.plan_qpos_to_qpos-576"><span class="linenos">576</span></a>            <span class="n">constraint_function</span><span class="o">=</span><span class="n">constraint_function</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-577"><a href="#Planner.plan_qpos_to_qpos-577"><span class="linenos">577</span></a>            <span class="n">constraint_jacobian</span><span class="o">=</span><span class="n">constraint_jacobian</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-578"><a href="#Planner.plan_qpos_to_qpos-578"><span class="linenos">578</span></a>            <span class="n">constraint_tolerance</span><span class="o">=</span><span class="n">constraint_tolerance</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-579"><a href="#Planner.plan_qpos_to_qpos-579"><span class="linenos">579</span></a>        <span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-580"><a href="#Planner.plan_qpos_to_qpos-580"><span class="linenos">580</span></a>
</span><span id="Planner.plan_qpos_to_qpos-581"><a href="#Planner.plan_qpos_to_qpos-581"><span class="linenos">581</span></a>        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Exact solution&quot;</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-582"><a href="#Planner.plan_qpos_to_qpos-582"><span class="linenos">582</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-583"><a href="#Planner.plan_qpos_to_qpos-583"><span class="linenos">583</span></a>                <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-584"><a href="#Planner.plan_qpos_to_qpos-584"><span class="linenos">584</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-585"><a href="#Planner.plan_qpos_to_qpos-585"><span class="linenos">585</span></a>                <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-586"><a href="#Planner.plan_qpos_to_qpos-586"><span class="linenos">586</span></a>            <span class="n">times</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOPP</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">time_step</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_qpos-587"><a href="#Planner.plan_qpos_to_qpos-587"><span class="linenos">587</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="Planner.plan_qpos_to_qpos-588"><a href="#Planner.plan_qpos_to_qpos-588"><span class="linenos">588</span></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-589"><a href="#Planner.plan_qpos_to_qpos-589"><span class="linenos">589</span></a>                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-590"><a href="#Planner.plan_qpos_to_qpos-590"><span class="linenos">590</span></a>                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-591"><a href="#Planner.plan_qpos_to_qpos-591"><span class="linenos">591</span></a>                <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-592"><a href="#Planner.plan_qpos_to_qpos-592"><span class="linenos">592</span></a>                <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-593"><a href="#Planner.plan_qpos_to_qpos-593"><span class="linenos">593</span></a>                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_qpos-594"><a href="#Planner.plan_qpos_to_qpos-594"><span class="linenos">594</span></a>            <span class="p">}</span>
</span><span id="Planner.plan_qpos_to_qpos-595"><a href="#Planner.plan_qpos_to_qpos-595"><span class="linenos">595</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_qpos-596"><a href="#Planner.plan_qpos_to_qpos-596"><span class="linenos">596</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;RRT Failed. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">status</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>plan a path from a specified joint position to a goal pose</p>

<p>Args:
    goal_pose: 7D pose of the end-effector [x,y,z,qw,qx,qy,qz]
    current_qpos: current joint configuration (either full or move_group joints)
    mask: mask for IK. When set, the IK will leave certain joints out of planning
    time_step: time step for TOPP
    rrt_range: step size for RRT
    planning_time: time limit for RRT
    fix_joint_limits: if True, will clip the joint configuration to be within the joint limits
    use_point_cloud: if True, will use the point cloud to avoid collision
    use_attach: if True, will consider the attached tool collision when planning
    verbose: if True, will print the log of OMPL and TOPPRA
    planner_name: planner name pick from {"RRTConnect", "RRT*"}
    fixed_joint_indices: list of indices of joints that are fixed during planning
    constraint_function: evals to 0 when constraint is satisfied
    constraint_jacobian: jacobian of constraint_function
    constraint_tolerance: tolerance for constraint_function
    no_simplification: if true, will not simplify the path. constraint planning does not support simplification</p>
</div>


                            </div>
                            <div id="Planner.plan_qpos_to_pose" class="classattr">
                                        <input id="Planner.plan_qpos_to_pose-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plan_qpos_to_pose</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">goal_pose</span>,</span><span class="param">	<span class="n">current_qpos</span>,</span><span class="param">	<span class="n">mask</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">wrt_world</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">planner_name</span><span class="o">=</span><span class="s1">&#39;RRTConnect&#39;</span>,</span><span class="param">	<span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">0.001</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.plan_qpos_to_pose-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.plan_qpos_to_pose"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.plan_qpos_to_pose-598"><a href="#Planner.plan_qpos_to_pose-598"><span class="linenos">598</span></a>    <span class="k">def</span> <span class="nf">plan_qpos_to_pose</span><span class="p">(</span>
</span><span id="Planner.plan_qpos_to_pose-599"><a href="#Planner.plan_qpos_to_pose-599"><span class="linenos">599</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-600"><a href="#Planner.plan_qpos_to_pose-600"><span class="linenos">600</span></a>        <span class="n">goal_pose</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-601"><a href="#Planner.plan_qpos_to_pose-601"><span class="linenos">601</span></a>        <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-602"><a href="#Planner.plan_qpos_to_pose-602"><span class="linenos">602</span></a>        <span class="n">mask</span><span class="o">=</span><span class="p">[],</span>
</span><span id="Planner.plan_qpos_to_pose-603"><a href="#Planner.plan_qpos_to_pose-603"><span class="linenos">603</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-604"><a href="#Planner.plan_qpos_to_pose-604"><span class="linenos">604</span></a>        <span class="n">rrt_range</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-605"><a href="#Planner.plan_qpos_to_pose-605"><span class="linenos">605</span></a>        <span class="n">planning_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-606"><a href="#Planner.plan_qpos_to_pose-606"><span class="linenos">606</span></a>        <span class="n">fix_joint_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-607"><a href="#Planner.plan_qpos_to_pose-607"><span class="linenos">607</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-608"><a href="#Planner.plan_qpos_to_pose-608"><span class="linenos">608</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-609"><a href="#Planner.plan_qpos_to_pose-609"><span class="linenos">609</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-610"><a href="#Planner.plan_qpos_to_pose-610"><span class="linenos">610</span></a>        <span class="n">wrt_world</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-611"><a href="#Planner.plan_qpos_to_pose-611"><span class="linenos">611</span></a>        <span class="n">planner_name</span><span class="o">=</span><span class="s2">&quot;RRTConnect&quot;</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-612"><a href="#Planner.plan_qpos_to_pose-612"><span class="linenos">612</span></a>        <span class="n">no_simplification</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-613"><a href="#Planner.plan_qpos_to_pose-613"><span class="linenos">613</span></a>        <span class="n">constraint_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-614"><a href="#Planner.plan_qpos_to_pose-614"><span class="linenos">614</span></a>        <span class="n">constraint_jacobian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-615"><a href="#Planner.plan_qpos_to_pose-615"><span class="linenos">615</span></a>        <span class="n">constraint_tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-616"><a href="#Planner.plan_qpos_to_pose-616"><span class="linenos">616</span></a>    <span class="p">):</span>
</span><span id="Planner.plan_qpos_to_pose-617"><a href="#Planner.plan_qpos_to_pose-617"><span class="linenos">617</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.plan_qpos_to_pose-618"><a href="#Planner.plan_qpos_to_pose-618"><span class="linenos">618</span></a><span class="sd">        plan from a start configuration to a goal pose of the end-effector</span>
</span><span id="Planner.plan_qpos_to_pose-619"><a href="#Planner.plan_qpos_to_pose-619"><span class="linenos">619</span></a>
</span><span id="Planner.plan_qpos_to_pose-620"><a href="#Planner.plan_qpos_to_pose-620"><span class="linenos">620</span></a><span class="sd">        Args:</span>
</span><span id="Planner.plan_qpos_to_pose-621"><a href="#Planner.plan_qpos_to_pose-621"><span class="linenos">621</span></a><span class="sd">            goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="Planner.plan_qpos_to_pose-622"><a href="#Planner.plan_qpos_to_pose-622"><span class="linenos">622</span></a><span class="sd">            current_qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="Planner.plan_qpos_to_pose-623"><a href="#Planner.plan_qpos_to_pose-623"><span class="linenos">623</span></a><span class="sd">            mask: if the value at a given index is True, the joint is *not* used in the IK</span>
</span><span id="Planner.plan_qpos_to_pose-624"><a href="#Planner.plan_qpos_to_pose-624"><span class="linenos">624</span></a><span class="sd">            time_step: time step for TOPPRA (time parameterization of path)</span>
</span><span id="Planner.plan_qpos_to_pose-625"><a href="#Planner.plan_qpos_to_pose-625"><span class="linenos">625</span></a><span class="sd">            rrt_range: step size for RRT</span>
</span><span id="Planner.plan_qpos_to_pose-626"><a href="#Planner.plan_qpos_to_pose-626"><span class="linenos">626</span></a><span class="sd">            planning_time: time limit for RRT</span>
</span><span id="Planner.plan_qpos_to_pose-627"><a href="#Planner.plan_qpos_to_pose-627"><span class="linenos">627</span></a><span class="sd">            fix_joint_limits: if True, will clip the joint configuration to be within the joint limits</span>
</span><span id="Planner.plan_qpos_to_pose-628"><a href="#Planner.plan_qpos_to_pose-628"><span class="linenos">628</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="Planner.plan_qpos_to_pose-629"><a href="#Planner.plan_qpos_to_pose-629"><span class="linenos">629</span></a><span class="sd">            use_attach: if True, will consider the attached tool collision when planning</span>
</span><span id="Planner.plan_qpos_to_pose-630"><a href="#Planner.plan_qpos_to_pose-630"><span class="linenos">630</span></a><span class="sd">            verbose: if True, will print the log of OMPL and TOPPRA</span>
</span><span id="Planner.plan_qpos_to_pose-631"><a href="#Planner.plan_qpos_to_pose-631"><span class="linenos">631</span></a><span class="sd">            wrt_world: if true, interpret the target pose with respect to the world frame instead of the base frame</span>
</span><span id="Planner.plan_qpos_to_pose-632"><a href="#Planner.plan_qpos_to_pose-632"><span class="linenos">632</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.plan_qpos_to_pose-633"><a href="#Planner.plan_qpos_to_pose-633"><span class="linenos">633</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">current_qpos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Planner.plan_qpos_to_pose-634"><a href="#Planner.plan_qpos_to_pose-634"><span class="linenos">634</span></a>        <span class="k">if</span> <span class="n">fix_joint_limits</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_pose-635"><a href="#Planner.plan_qpos_to_pose-635"><span class="linenos">635</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner.plan_qpos_to_pose-636"><a href="#Planner.plan_qpos_to_pose-636"><span class="linenos">636</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Planner.plan_qpos_to_pose-637"><a href="#Planner.plan_qpos_to_pose-637"><span class="linenos">637</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner.plan_qpos_to_pose-638"><a href="#Planner.plan_qpos_to_pose-638"><span class="linenos">638</span></a>                <span class="k">if</span> <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Planner.plan_qpos_to_pose-639"><a href="#Planner.plan_qpos_to_pose-639"><span class="linenos">639</span></a>                    <span class="n">current_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner.plan_qpos_to_pose-640"><a href="#Planner.plan_qpos_to_pose-640"><span class="linenos">640</span></a>
</span><span id="Planner.plan_qpos_to_pose-641"><a href="#Planner.plan_qpos_to_pose-641"><span class="linenos">641</span></a>        <span class="k">if</span> <span class="n">wrt_world</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_pose-642"><a href="#Planner.plan_qpos_to_pose-642"><span class="linenos">642</span></a>            <span class="n">base_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">get_base_pose</span><span class="p">()</span>
</span><span id="Planner.plan_qpos_to_pose-643"><a href="#Planner.plan_qpos_to_pose-643"><span class="linenos">643</span></a>            <span class="n">base_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-644"><a href="#Planner.plan_qpos_to_pose-644"><span class="linenos">644</span></a>            <span class="n">base_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Planner.plan_qpos_to_pose-645"><a href="#Planner.plan_qpos_to_pose-645"><span class="linenos">645</span></a>            <span class="n">base_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">base_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="Planner.plan_qpos_to_pose-646"><a href="#Planner.plan_qpos_to_pose-646"><span class="linenos">646</span></a>            <span class="n">goal_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-647"><a href="#Planner.plan_qpos_to_pose-647"><span class="linenos">647</span></a>            <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Planner.plan_qpos_to_pose-648"><a href="#Planner.plan_qpos_to_pose-648"><span class="linenos">648</span></a>            <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="Planner.plan_qpos_to_pose-649"><a href="#Planner.plan_qpos_to_pose-649"><span class="linenos">649</span></a>            <span class="n">goal_tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">base_tf</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">goal_tf</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-650"><a href="#Planner.plan_qpos_to_pose-650"><span class="linenos">650</span></a>            <span class="n">goal_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Planner.plan_qpos_to_pose-651"><a href="#Planner.plan_qpos_to_pose-651"><span class="linenos">651</span></a>            <span class="n">goal_pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">mat2quat</span><span class="p">(</span><span class="n">goal_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="Planner.plan_qpos_to_pose-652"><a href="#Planner.plan_qpos_to_pose-652"><span class="linenos">652</span></a>
</span><span id="Planner.plan_qpos_to_pose-653"><a href="#Planner.plan_qpos_to_pose-653"><span class="linenos">653</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner.plan_qpos_to_pose-654"><a href="#Planner.plan_qpos_to_pose-654"><span class="linenos">654</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner.plan_qpos_to_pose-655"><a href="#Planner.plan_qpos_to_pose-655"><span class="linenos">655</span></a>        <span class="p">)</span>  <span class="c1"># we need to take only the move_group joints when planning</span>
</span><span id="Planner.plan_qpos_to_pose-656"><a href="#Planner.plan_qpos_to_pose-656"><span class="linenos">656</span></a>
</span><span id="Planner.plan_qpos_to_pose-657"><a href="#Planner.plan_qpos_to_pose-657"><span class="linenos">657</span></a>        <span class="n">ik_status</span><span class="p">,</span> <span class="n">goal_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IK</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-658"><a href="#Planner.plan_qpos_to_pose-658"><span class="linenos">658</span></a>        <span class="k">if</span> <span class="n">ik_status</span> <span class="o">!=</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_pose-659"><a href="#Planner.plan_qpos_to_pose-659"><span class="linenos">659</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">ik_status</span><span class="p">}</span>
</span><span id="Planner.plan_qpos_to_pose-660"><a href="#Planner.plan_qpos_to_pose-660"><span class="linenos">660</span></a>
</span><span id="Planner.plan_qpos_to_pose-661"><a href="#Planner.plan_qpos_to_pose-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_pose-662"><a href="#Planner.plan_qpos_to_pose-662"><span class="linenos">662</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IK results:&quot;</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-663"><a href="#Planner.plan_qpos_to_pose-663"><span class="linenos">663</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="Planner.plan_qpos_to_pose-664"><a href="#Planner.plan_qpos_to_pose-664"><span class="linenos">664</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Planner.plan_qpos_to_pose-665"><a href="#Planner.plan_qpos_to_pose-665"><span class="linenos">665</span></a>
</span><span id="Planner.plan_qpos_to_pose-666"><a href="#Planner.plan_qpos_to_pose-666"><span class="linenos">666</span></a>        <span class="n">goal_qpos_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Planner.plan_qpos_to_pose-667"><a href="#Planner.plan_qpos_to_pose-667"><span class="linenos">667</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="Planner.plan_qpos_to_pose-668"><a href="#Planner.plan_qpos_to_pose-668"><span class="linenos">668</span></a>            <span class="n">goal_qpos_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</span><span id="Planner.plan_qpos_to_pose-669"><a href="#Planner.plan_qpos_to_pose-669"><span class="linenos">669</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">current_qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-670"><a href="#Planner.plan_qpos_to_pose-670"><span class="linenos">670</span></a>
</span><span id="Planner.plan_qpos_to_pose-671"><a href="#Planner.plan_qpos_to_pose-671"><span class="linenos">671</span></a>        <span class="n">ik_status</span><span class="p">,</span> <span class="n">goal_qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IK</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">,</span> <span class="n">current_qpos</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-672"><a href="#Planner.plan_qpos_to_pose-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="n">ik_status</span> <span class="o">!=</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_pose-673"><a href="#Planner.plan_qpos_to_pose-673"><span class="linenos">673</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">ik_status</span><span class="p">}</span>
</span><span id="Planner.plan_qpos_to_pose-674"><a href="#Planner.plan_qpos_to_pose-674"><span class="linenos">674</span></a>
</span><span id="Planner.plan_qpos_to_pose-675"><a href="#Planner.plan_qpos_to_pose-675"><span class="linenos">675</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner.plan_qpos_to_pose-676"><a href="#Planner.plan_qpos_to_pose-676"><span class="linenos">676</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IK results:&quot;</span><span class="p">)</span>
</span><span id="Planner.plan_qpos_to_pose-677"><a href="#Planner.plan_qpos_to_pose-677"><span class="linenos">677</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">)):</span>
</span><span id="Planner.plan_qpos_to_pose-678"><a href="#Planner.plan_qpos_to_pose-678"><span class="linenos">678</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">goal_qpos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Planner.plan_qpos_to_pose-679"><a href="#Planner.plan_qpos_to_pose-679"><span class="linenos">679</span></a>
</span><span id="Planner.plan_qpos_to_pose-680"><a href="#Planner.plan_qpos_to_pose-680"><span class="linenos">680</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_qpos_to_qpos</span><span class="p">(</span>
</span><span id="Planner.plan_qpos_to_pose-681"><a href="#Planner.plan_qpos_to_pose-681"><span class="linenos">681</span></a>            <span class="n">goal_qpos</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-682"><a href="#Planner.plan_qpos_to_pose-682"><span class="linenos">682</span></a>            <span class="n">current_qpos</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-683"><a href="#Planner.plan_qpos_to_pose-683"><span class="linenos">683</span></a>            <span class="n">time_step</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-684"><a href="#Planner.plan_qpos_to_pose-684"><span class="linenos">684</span></a>            <span class="n">rrt_range</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-685"><a href="#Planner.plan_qpos_to_pose-685"><span class="linenos">685</span></a>            <span class="n">planning_time</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-686"><a href="#Planner.plan_qpos_to_pose-686"><span class="linenos">686</span></a>            <span class="n">fix_joint_limits</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-687"><a href="#Planner.plan_qpos_to_pose-687"><span class="linenos">687</span></a>            <span class="n">use_point_cloud</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-688"><a href="#Planner.plan_qpos_to_pose-688"><span class="linenos">688</span></a>            <span class="n">use_attach</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-689"><a href="#Planner.plan_qpos_to_pose-689"><span class="linenos">689</span></a>            <span class="n">verbose</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-690"><a href="#Planner.plan_qpos_to_pose-690"><span class="linenos">690</span></a>            <span class="n">planner_name</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-691"><a href="#Planner.plan_qpos_to_pose-691"><span class="linenos">691</span></a>            <span class="n">no_simplification</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-692"><a href="#Planner.plan_qpos_to_pose-692"><span class="linenos">692</span></a>            <span class="n">constraint_function</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-693"><a href="#Planner.plan_qpos_to_pose-693"><span class="linenos">693</span></a>            <span class="n">constraint_jacobian</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-694"><a href="#Planner.plan_qpos_to_pose-694"><span class="linenos">694</span></a>            <span class="n">constraint_tolerance</span><span class="p">,</span>
</span><span id="Planner.plan_qpos_to_pose-695"><a href="#Planner.plan_qpos_to_pose-695"><span class="linenos">695</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>plan from a start configuration to a goal pose of the end-effector</p>

<p>Args:
    goal_pose: [x,y,z,qw,qx,qy,qz] pose of the goal
    current_qpos: current joint configuration (either full or move_group joints)
    mask: if the value at a given index is True, the joint is <em>not</em> used in the IK
    time_step: time step for TOPPRA (time parameterization of path)
    rrt_range: step size for RRT
    planning_time: time limit for RRT
    fix_joint_limits: if True, will clip the joint configuration to be within the joint limits
    use_point_cloud: if True, will use the point cloud to avoid collision
    use_attach: if True, will consider the attached tool collision when planning
    verbose: if True, will print the log of OMPL and TOPPRA
    wrt_world: if true, interpret the target pose with respect to the world frame instead of the base frame</p>
</div>


                            </div>
                            <div id="Planner.plan_screw" class="classattr">
                                        <input id="Planner.plan_screw-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plan_screw</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">target_pose</span>,</span><span class="param">	<span class="n">qpos</span>,</span><span class="param">	<span class="n">qpos_step</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Planner.plan_screw-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Planner.plan_screw"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Planner.plan_screw-697"><a href="#Planner.plan_screw-697"><span class="linenos">697</span></a>    <span class="k">def</span> <span class="nf">plan_screw</span><span class="p">(</span>
</span><span id="Planner.plan_screw-698"><a href="#Planner.plan_screw-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Planner.plan_screw-699"><a href="#Planner.plan_screw-699"><span class="linenos">699</span></a>        <span class="n">target_pose</span><span class="p">,</span>
</span><span id="Planner.plan_screw-700"><a href="#Planner.plan_screw-700"><span class="linenos">700</span></a>        <span class="n">qpos</span><span class="p">,</span>
</span><span id="Planner.plan_screw-701"><a href="#Planner.plan_screw-701"><span class="linenos">701</span></a>        <span class="n">qpos_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner.plan_screw-702"><a href="#Planner.plan_screw-702"><span class="linenos">702</span></a>        <span class="n">time_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Planner.plan_screw-703"><a href="#Planner.plan_screw-703"><span class="linenos">703</span></a>        <span class="n">use_point_cloud</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_screw-704"><a href="#Planner.plan_screw-704"><span class="linenos">704</span></a>        <span class="n">use_attach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_screw-705"><a href="#Planner.plan_screw-705"><span class="linenos">705</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Planner.plan_screw-706"><a href="#Planner.plan_screw-706"><span class="linenos">706</span></a>    <span class="p">):</span>
</span><span id="Planner.plan_screw-707"><a href="#Planner.plan_screw-707"><span class="linenos">707</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Planner.plan_screw-708"><a href="#Planner.plan_screw-708"><span class="linenos">708</span></a><span class="sd">        plan from a start configuration to a goal pose of the end-effector using screw motion</span>
</span><span id="Planner.plan_screw-709"><a href="#Planner.plan_screw-709"><span class="linenos">709</span></a>
</span><span id="Planner.plan_screw-710"><a href="#Planner.plan_screw-710"><span class="linenos">710</span></a><span class="sd">        Args:</span>
</span><span id="Planner.plan_screw-711"><a href="#Planner.plan_screw-711"><span class="linenos">711</span></a><span class="sd">            target_pose: [x,y,z,qw,qx,qy,qz] pose of the goal</span>
</span><span id="Planner.plan_screw-712"><a href="#Planner.plan_screw-712"><span class="linenos">712</span></a><span class="sd">            qpos: current joint configuration (either full or move_group joints)</span>
</span><span id="Planner.plan_screw-713"><a href="#Planner.plan_screw-713"><span class="linenos">713</span></a><span class="sd">            qpos_step: size of the random step for RRT</span>
</span><span id="Planner.plan_screw-714"><a href="#Planner.plan_screw-714"><span class="linenos">714</span></a><span class="sd">            time_step: time step for the discretization</span>
</span><span id="Planner.plan_screw-715"><a href="#Planner.plan_screw-715"><span class="linenos">715</span></a><span class="sd">            use_point_cloud: if True, will use the point cloud to avoid collision</span>
</span><span id="Planner.plan_screw-716"><a href="#Planner.plan_screw-716"><span class="linenos">716</span></a><span class="sd">            use_attach: if True, will use the attached tool to avoid collision</span>
</span><span id="Planner.plan_screw-717"><a href="#Planner.plan_screw-717"><span class="linenos">717</span></a><span class="sd">            verbose: if True, will print the log of TOPPRA</span>
</span><span id="Planner.plan_screw-718"><a href="#Planner.plan_screw-718"><span class="linenos">718</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Planner.plan_screw-719"><a href="#Planner.plan_screw-719"><span class="linenos">719</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_point_cloud</span><span class="p">(</span><span class="n">use_point_cloud</span><span class="p">)</span>
</span><span id="Planner.plan_screw-720"><a href="#Planner.plan_screw-720"><span class="linenos">720</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_use_attach</span><span class="p">(</span><span class="n">use_attach</span><span class="p">)</span>
</span><span id="Planner.plan_screw-721"><a href="#Planner.plan_screw-721"><span class="linenos">721</span></a>        <span class="n">qpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="Planner.plan_screw-722"><a href="#Planner.plan_screw-722"><span class="linenos">722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">set_qpos</span><span class="p">(</span><span class="n">qpos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Planner.plan_screw-723"><a href="#Planner.plan_screw-723"><span class="linenos">723</span></a>
</span><span id="Planner.plan_screw-724"><a href="#Planner.plan_screw-724"><span class="linenos">724</span></a>        <span class="k">def</span> <span class="nf">pose7D2mat</span><span class="p">(</span><span class="n">pose</span><span class="p">):</span>
</span><span id="Planner.plan_screw-725"><a href="#Planner.plan_screw-725"><span class="linenos">725</span></a>            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="Planner.plan_screw-726"><a href="#Planner.plan_screw-726"><span class="linenos">726</span></a>            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="Planner.plan_screw-727"><a href="#Planner.plan_screw-727"><span class="linenos">727</span></a>            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat2mat</span><span class="p">(</span><span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span id="Planner.plan_screw-728"><a href="#Planner.plan_screw-728"><span class="linenos">728</span></a>            <span class="k">return</span> <span class="n">mat</span>
</span><span id="Planner.plan_screw-729"><a href="#Planner.plan_screw-729"><span class="linenos">729</span></a>
</span><span id="Planner.plan_screw-730"><a href="#Planner.plan_screw-730"><span class="linenos">730</span></a>        <span class="k">def</span> <span class="nf">skew</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
</span><span id="Planner.plan_screw-731"><a href="#Planner.plan_screw-731"><span class="linenos">731</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="Planner.plan_screw-732"><a href="#Planner.plan_screw-732"><span class="linenos">732</span></a>                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="Planner.plan_screw-733"><a href="#Planner.plan_screw-733"><span class="linenos">733</span></a>                <span class="p">[</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="Planner.plan_screw-734"><a href="#Planner.plan_screw-734"><span class="linenos">734</span></a>                <span class="p">[</span><span class="o">-</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="Planner.plan_screw-735"><a href="#Planner.plan_screw-735"><span class="linenos">735</span></a>            <span class="p">])</span>
</span><span id="Planner.plan_screw-736"><a href="#Planner.plan_screw-736"><span class="linenos">736</span></a>
</span><span id="Planner.plan_screw-737"><a href="#Planner.plan_screw-737"><span class="linenos">737</span></a>        <span class="k">def</span> <span class="nf">pose2exp_coordinate</span><span class="p">(</span><span class="n">pose</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Planner.plan_screw-738"><a href="#Planner.plan_screw-738"><span class="linenos">738</span></a>            <span class="k">def</span> <span class="nf">rot2so3</span><span class="p">(</span><span class="n">rotation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="Planner.plan_screw-739"><a href="#Planner.plan_screw-739"><span class="linenos">739</span></a>                <span class="k">assert</span> <span class="n">rotation</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Planner.plan_screw-740"><a href="#Planner.plan_screw-740"><span class="linenos">740</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="Planner.plan_screw-741"><a href="#Planner.plan_screw-741"><span class="linenos">741</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span>
</span><span id="Planner.plan_screw-742"><a href="#Planner.plan_screw-742"><span class="linenos">742</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Planner.plan_screw-743"><a href="#Planner.plan_screw-743"><span class="linenos">743</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="mf">1e6</span>
</span><span id="Planner.plan_screw-744"><a href="#Planner.plan_screw-744"><span class="linenos">744</span></a>                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">rotation</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Planner.plan_screw-745"><a href="#Planner.plan_screw-745"><span class="linenos">745</span></a>                <span class="n">omega</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner.plan_screw-746"><a href="#Planner.plan_screw-746"><span class="linenos">746</span></a>                    <span class="mi">1</span>
</span><span id="Planner.plan_screw-747"><a href="#Planner.plan_screw-747"><span class="linenos">747</span></a>                    <span class="o">/</span> <span class="mi">2</span>
</span><span id="Planner.plan_screw-748"><a href="#Planner.plan_screw-748"><span class="linenos">748</span></a>                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="Planner.plan_screw-749"><a href="#Planner.plan_screw-749"><span class="linenos">749</span></a>                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
</span><span id="Planner.plan_screw-750"><a href="#Planner.plan_screw-750"><span class="linenos">750</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="Planner.plan_screw-751"><a href="#Planner.plan_screw-751"><span class="linenos">751</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="Planner.plan_screw-752"><a href="#Planner.plan_screw-752"><span class="linenos">752</span></a>                        <span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="Planner.plan_screw-753"><a href="#Planner.plan_screw-753"><span class="linenos">753</span></a>                    <span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="Planner.plan_screw-754"><a href="#Planner.plan_screw-754"><span class="linenos">754</span></a>                <span class="p">)</span>
</span><span id="Planner.plan_screw-755"><a href="#Planner.plan_screw-755"><span class="linenos">755</span></a>                <span class="k">return</span> <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span>
</span><span id="Planner.plan_screw-756"><a href="#Planner.plan_screw-756"><span class="linenos">756</span></a>
</span><span id="Planner.plan_screw-757"><a href="#Planner.plan_screw-757"><span class="linenos">757</span></a>            <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">rot2so3</span><span class="p">(</span><span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="Planner.plan_screw-758"><a href="#Planner.plan_screw-758"><span class="linenos">758</span></a>            <span class="k">if</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e5</span><span class="p">:</span>
</span><span id="Planner.plan_screw-759"><a href="#Planner.plan_screw-759"><span class="linenos">759</span></a>                <span class="k">return</span> <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span>
</span><span id="Planner.plan_screw-760"><a href="#Planner.plan_screw-760"><span class="linenos">760</span></a>            <span class="n">ss</span> <span class="o">=</span> <span class="n">skew</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
</span><span id="Planner.plan_screw-761"><a href="#Planner.plan_screw-761"><span class="linenos">761</span></a>            <span class="n">inv_left_jacobian</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Planner.plan_screw-762"><a href="#Planner.plan_screw-762"><span class="linenos">762</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">theta</span>
</span><span id="Planner.plan_screw-763"><a href="#Planner.plan_screw-763"><span class="linenos">763</span></a>                <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ss</span>
</span><span id="Planner.plan_screw-764"><a href="#Planner.plan_screw-764"><span class="linenos">764</span></a>                <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">theta</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">ss</span> <span class="o">@</span> <span class="n">ss</span>
</span><span id="Planner.plan_screw-765"><a href="#Planner.plan_screw-765"><span class="linenos">765</span></a>            <span class="p">)</span>
</span><span id="Planner.plan_screw-766"><a href="#Planner.plan_screw-766"><span class="linenos">766</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">inv_left_jacobian</span> <span class="o">@</span> <span class="n">pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Planner.plan_screw-767"><a href="#Planner.plan_screw-767"><span class="linenos">767</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">v</span><span class="p">,</span> <span class="n">omega</span><span class="p">]),</span> <span class="n">theta</span>
</span><span id="Planner.plan_screw-768"><a href="#Planner.plan_screw-768"><span class="linenos">768</span></a>
</span><span id="Planner.plan_screw-769"><a href="#Planner.plan_screw-769"><span class="linenos">769</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_forward_kinematics</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="Planner.plan_screw-770"><a href="#Planner.plan_screw-770"><span class="linenos">770</span></a>        <span class="n">ee_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_name_2_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">move_group</span><span class="p">]</span>
</span><span id="Planner.plan_screw-771"><a href="#Planner.plan_screw-771"><span class="linenos">771</span></a>        <span class="n">current_p</span> <span class="o">=</span> <span class="n">pose7D2mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_pose</span><span class="p">(</span><span class="n">ee_index</span><span class="p">))</span>
</span><span id="Planner.plan_screw-772"><a href="#Planner.plan_screw-772"><span class="linenos">772</span></a>        <span class="n">target_p</span> <span class="o">=</span> <span class="n">pose7D2mat</span><span class="p">(</span><span class="n">target_pose</span><span class="p">)</span>
</span><span id="Planner.plan_screw-773"><a href="#Planner.plan_screw-773"><span class="linenos">773</span></a>        <span class="n">relative_transform</span> <span class="o">=</span> <span class="n">target_p</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">current_p</span><span class="p">)</span>
</span><span id="Planner.plan_screw-774"><a href="#Planner.plan_screw-774"><span class="linenos">774</span></a>
</span><span id="Planner.plan_screw-775"><a href="#Planner.plan_screw-775"><span class="linenos">775</span></a>        <span class="n">omega</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">pose2exp_coordinate</span><span class="p">(</span><span class="n">relative_transform</span><span class="p">)</span>
</span><span id="Planner.plan_screw-776"><a href="#Planner.plan_screw-776"><span class="linenos">776</span></a>
</span><span id="Planner.plan_screw-777"><a href="#Planner.plan_screw-777"><span class="linenos">777</span></a>        <span class="k">if</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e4</span><span class="p">:</span>
</span><span id="Planner.plan_screw-778"><a href="#Planner.plan_screw-778"><span class="linenos">778</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;screw plan failed.&quot;</span><span class="p">}</span>
</span><span id="Planner.plan_screw-779"><a href="#Planner.plan_screw-779"><span class="linenos">779</span></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">theta</span>
</span><span id="Planner.plan_screw-780"><a href="#Planner.plan_screw-780"><span class="linenos">780</span></a>
</span><span id="Planner.plan_screw-781"><a href="#Planner.plan_screw-781"><span class="linenos">781</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_group_joint_indices</span>
</span><span id="Planner.plan_screw-782"><a href="#Planner.plan_screw-782"><span class="linenos">782</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">])]</span>
</span><span id="Planner.plan_screw-783"><a href="#Planner.plan_screw-783"><span class="linenos">783</span></a>
</span><span id="Planner.plan_screw-784"><a href="#Planner.plan_screw-784"><span class="linenos">784</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Planner.plan_screw-785"><a href="#Planner.plan_screw-785"><span class="linenos">785</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">compute_full_jacobian</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="Planner.plan_screw-786"><a href="#Planner.plan_screw-786"><span class="linenos">786</span></a>            <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinocchio_model</span><span class="o">.</span><span class="n">get_link_jacobian</span><span class="p">(</span><span class="n">ee_index</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Planner.plan_screw-787"><a href="#Planner.plan_screw-787"><span class="linenos">787</span></a>            <span class="n">delta_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">@</span> <span class="n">omega</span>
</span><span id="Planner.plan_screw-788"><a href="#Planner.plan_screw-788"><span class="linenos">788</span></a>            <span class="n">delta_q</span> <span class="o">*=</span> <span class="n">qpos_step</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_q</span><span class="p">))</span>
</span><span id="Planner.plan_screw-789"><a href="#Planner.plan_screw-789"><span class="linenos">789</span></a>            <span class="n">delta_twist</span> <span class="o">=</span> <span class="n">J</span> <span class="o">@</span> <span class="n">delta_q</span>
</span><span id="Planner.plan_screw-790"><a href="#Planner.plan_screw-790"><span class="linenos">790</span></a>
</span><span id="Planner.plan_screw-791"><a href="#Planner.plan_screw-791"><span class="linenos">791</span></a>            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Planner.plan_screw-792"><a href="#Planner.plan_screw-792"><span class="linenos">792</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">omega</span><span class="p">):</span>
</span><span id="Planner.plan_screw-793"><a href="#Planner.plan_screw-793"><span class="linenos">793</span></a>                <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span>
</span><span id="Planner.plan_screw-794"><a href="#Planner.plan_screw-794"><span class="linenos">794</span></a>                <span class="n">delta_q</span> <span class="o">=</span> <span class="n">delta_q</span> <span class="o">*</span> <span class="n">ratio</span>
</span><span id="Planner.plan_screw-795"><a href="#Planner.plan_screw-795"><span class="linenos">795</span></a>                <span class="n">delta_twist</span> <span class="o">=</span> <span class="n">delta_twist</span> <span class="o">*</span> <span class="n">ratio</span>
</span><span id="Planner.plan_screw-796"><a href="#Planner.plan_screw-796"><span class="linenos">796</span></a>                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Planner.plan_screw-797"><a href="#Planner.plan_screw-797"><span class="linenos">797</span></a>
</span><span id="Planner.plan_screw-798"><a href="#Planner.plan_screw-798"><span class="linenos">798</span></a>            <span class="n">qpos</span> <span class="o">+=</span> <span class="n">delta_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Planner.plan_screw-799"><a href="#Planner.plan_screw-799"><span class="linenos">799</span></a>            <span class="n">omega</span> <span class="o">-=</span> <span class="n">delta_twist</span>
</span><span id="Planner.plan_screw-800"><a href="#Planner.plan_screw-800"><span class="linenos">800</span></a>
</span><span id="Planner.plan_screw-801"><a href="#Planner.plan_screw-801"><span class="linenos">801</span></a>            <span class="k">def</span> <span class="nf">check_joint_limit</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
</span><span id="Planner.plan_screw-802"><a href="#Planner.plan_screw-802"><span class="linenos">802</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span id="Planner.plan_screw-803"><a href="#Planner.plan_screw-803"><span class="linenos">803</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="Planner.plan_screw-804"><a href="#Planner.plan_screw-804"><span class="linenos">804</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="Planner.plan_screw-805"><a href="#Planner.plan_screw-805"><span class="linenos">805</span></a>                        <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Planner.plan_screw-806"><a href="#Planner.plan_screw-806"><span class="linenos">806</span></a>                        <span class="ow">or</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_limits</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-3</span>
</span><span id="Planner.plan_screw-807"><a href="#Planner.plan_screw-807"><span class="linenos">807</span></a>                    <span class="p">):</span>
</span><span id="Planner.plan_screw-808"><a href="#Planner.plan_screw-808"><span class="linenos">808</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Planner.plan_screw-809"><a href="#Planner.plan_screw-809"><span class="linenos">809</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Planner.plan_screw-810"><a href="#Planner.plan_screw-810"><span class="linenos">810</span></a>
</span><span id="Planner.plan_screw-811"><a href="#Planner.plan_screw-811"><span class="linenos">811</span></a>            <span class="n">within_joint_limit</span> <span class="o">=</span> <span class="n">check_joint_limit</span><span class="p">(</span><span class="n">qpos</span><span class="p">)</span>
</span><span id="Planner.plan_screw-812"><a href="#Planner.plan_screw-812"><span class="linenos">812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">set_qpos_all</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="Planner.plan_screw-813"><a href="#Planner.plan_screw-813"><span class="linenos">813</span></a>            <span class="n">collide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_world</span><span class="o">.</span><span class="n">collide</span><span class="p">()</span>
</span><span id="Planner.plan_screw-814"><a href="#Planner.plan_screw-814"><span class="linenos">814</span></a>
</span><span id="Planner.plan_screw-815"><a href="#Planner.plan_screw-815"><span class="linenos">815</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Planner.plan_screw-816"><a href="#Planner.plan_screw-816"><span class="linenos">816</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta_twist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span>
</span><span id="Planner.plan_screw-817"><a href="#Planner.plan_screw-817"><span class="linenos">817</span></a>                <span class="ow">or</span> <span class="n">collide</span>
</span><span id="Planner.plan_screw-818"><a href="#Planner.plan_screw-818"><span class="linenos">818</span></a>                <span class="ow">or</span> <span class="n">within_joint_limit</span> <span class="o">==</span> <span class="kc">False</span>
</span><span id="Planner.plan_screw-819"><a href="#Planner.plan_screw-819"><span class="linenos">819</span></a>            <span class="p">):</span>
</span><span id="Planner.plan_screw-820"><a href="#Planner.plan_screw-820"><span class="linenos">820</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;screw plan failed&quot;</span><span class="p">}</span>
</span><span id="Planner.plan_screw-821"><a href="#Planner.plan_screw-821"><span class="linenos">821</span></a>
</span><span id="Planner.plan_screw-822"><a href="#Planner.plan_screw-822"><span class="linenos">822</span></a>            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">qpos</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</span><span id="Planner.plan_screw-823"><a href="#Planner.plan_screw-823"><span class="linenos">823</span></a>
</span><span id="Planner.plan_screw-824"><a href="#Planner.plan_screw-824"><span class="linenos">824</span></a>            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span><span id="Planner.plan_screw-825"><a href="#Planner.plan_screw-825"><span class="linenos">825</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Planner.plan_screw-826"><a href="#Planner.plan_screw-826"><span class="linenos">826</span></a>                    <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
</span><span id="Planner.plan_screw-827"><a href="#Planner.plan_screw-827"><span class="linenos">827</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Planner.plan_screw-828"><a href="#Planner.plan_screw-828"><span class="linenos">828</span></a>                    <span class="n">ta</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</span><span id="Planner.plan_screw-829"><a href="#Planner.plan_screw-829"><span class="linenos">829</span></a>                <span class="n">times</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOPP</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">time_step</span><span class="p">)</span>
</span><span id="Planner.plan_screw-830"><a href="#Planner.plan_screw-830"><span class="linenos">830</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="Planner.plan_screw-831"><a href="#Planner.plan_screw-831"><span class="linenos">831</span></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span id="Planner.plan_screw-832"><a href="#Planner.plan_screw-832"><span class="linenos">832</span></a>                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
</span><span id="Planner.plan_screw-833"><a href="#Planner.plan_screw-833"><span class="linenos">833</span></a>                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="Planner.plan_screw-834"><a href="#Planner.plan_screw-834"><span class="linenos">834</span></a>                    <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="n">vel</span><span class="p">,</span>
</span><span id="Planner.plan_screw-835"><a href="#Planner.plan_screw-835"><span class="linenos">835</span></a>                    <span class="s2">&quot;acceleration&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span>
</span><span id="Planner.plan_screw-836"><a href="#Planner.plan_screw-836"><span class="linenos">836</span></a>                    <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="Planner.plan_screw-837"><a href="#Planner.plan_screw-837"><span class="linenos">837</span></a>                <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>plan from a start configuration to a goal pose of the end-effector using screw motion</p>

<p>Args:
    target_pose: [x,y,z,qw,qx,qy,qz] pose of the goal
    qpos: current joint configuration (either full or move_group joints)
    qpos_step: size of the random step for RRT
    time_step: time step for the discretization
    use_point_cloud: if True, will use the point cloud to avoid collision
    use_attach: if True, will use the attached tool to avoid collision
    verbose: if True, will print the log of TOPPRA</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>